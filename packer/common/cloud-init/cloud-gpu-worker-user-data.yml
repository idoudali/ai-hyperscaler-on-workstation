#cloud-config
# Cloud-init configuration for Cloud GPU Worker Image
# This configures the admin user with SSH access and GPU-accelerated Kubernetes worker setup

# User configuration
users:
  - name: admin
    groups: [sudo, adm, systemd-journal]
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    lock_passwd: true
    # Uncomment to set a password for the admin user for debugging reasons
    # plain_text_passwd: cloud-gpu-worker
    ssh_authorized_keys:
      - REPLACE_SSH_KEY

# System configuration
hostname: cloud-gpu-worker
fqdn: cloud-gpu-worker.local

# SSH configuration
ssh_pwauth: false
disable_root: true

# System updates
package_update: true
package_upgrade: false

# Basic packages (minimal set only)
packages:
  - curl
  - wget
  - vim
  - htop
  - network-manager
  - systemd-resolved

# Timezone
timezone: UTC

# Runcmd for post-boot setup
runcmd:
  # Enable SSH service
  - systemctl enable ssh
  - systemctl start ssh

  # Set hostname properly
  - hostnamectl set-hostname cloud-gpu-worker

  # Update /etc/hosts
  - echo "127.0.0.1 localhost" > /etc/hosts
  - echo "127.0.1.1 cloud-gpu-worker cloud-gpu-worker.local" >> /etc/hosts

  # Configure basic limits for GPU workloads
  - echo "* soft nofile 65536" >> /etc/security/limits.conf
  - echo "* hard nofile 65536" >> /etc/security/limits.conf
  - echo "* soft nproc 32768" >> /etc/security/limits.conf
  - echo "* hard nproc 32768" >> /etc/security/limits.conf

  # Ensure kernel modules are loaded
  - modprobe br_netfilter
  - modprobe overlay
  - modprobe nvidia || logger -t cloud-init "Failed to load nvidia kernel module"
  - modprobe nvidia-uvm || logger -t cloud-init "Failed to load nvidia-uvm kernel module"

  # Apply sysctl settings
  - sysctl -p /etc/sysctl.d/99-kubernetes.conf || true

  # Disable swap permanently
  - swapoff -a

  # Enable and start containerd if present
  - systemctl enable containerd || true
  - systemctl start containerd || true

  # Enable NVIDIA persistence mode
  - nvidia-smi -pm 1 || true

  # Enable and start node exporter if present
  - systemctl enable prometheus-node-exporter || true
  - systemctl start prometheus-node-exporter || true

  # Enable and start DCGM exporter if present
  - systemctl enable dcgm-exporter || true
  - systemctl start dcgm-exporter || true

  # Ensure NetworkManager is running and configured
  - systemctl enable NetworkManager
  - systemctl enable systemd-resolved

# Final message
final_message: "Cloud GPU worker image setup complete. Login with admin user (root access disabled for security). The system is ready for GPU-accelerated Kubernetes deployment."
