# SLURM Common - Configuration Validation
# Used by both controller and compute roles for validating configuration

- name: CRITICAL - Validate SLURM controller address is not localhost
  ansible.builtin.assert:
    that:
      - slurm_controller_addr is defined
      - slurm_controller_addr != "127.0.0.1"
      - slurm_controller_addr != "localhost"
      - slurm_controller_addr != "::1"
    fail_msg: |
      ❌ CRITICAL ERROR: slurm_controller_addr is set to {{ slurm_controller_addr }}!

      This is a localhost address and will prevent compute nodes from connecting to the controller.
      The controller address MUST be set to the actual IP address of the controller node.

      Fix: Update ansible/roles/*/defaults/main.yml or set in inventory/group_vars/
    success_msg: "✅ SLURM controller address validated: {{ slurm_controller_addr }}"
  tags:
    - slurm
    - validation
    - critical

- name: Check if SLURM configuration file exists
  ansible.builtin.stat:
    path: /etc/slurm/slurm.conf
  register: slurm_config_file
  when: not (packer_build | default(false) | bool)

- name: Validate SLURM configuration syntax
  ansible.builtin.command: /usr/sbin/slurmctld -t -f /etc/slurm/slurm.conf
  register: slurm_config_validation
  changed_when: false
  failed_when: false # Don't fail on validation errors for now
  become: true
  when:
    - not (packer_build | default(false) | bool)
    - slurm_config_file.stat.exists | default(false)
    - slurm_config_validation_enabled | default(true)

- name: Display SLURM configuration validation result
  ansible.builtin.debug:
    msg: |
      SLURM configuration validation result:
      - Return code: {{ slurm_config_validation.rc | default('N/A') }}
      - Status: {{ 'PASSED' if (slurm_config_validation.rc is defined and slurm_config_validation.rc == 0) else 'FAILED' if slurm_config_validation.rc is defined else 'SKIPPED' }}
      {% if slurm_config_validation.stderr is defined and slurm_config_validation.stderr %}
      - Error: {{ slurm_config_validation.stderr }}
      {% endif %}
  when:
    - not (packer_build | default(false))
    - slurm_config_validation is defined
