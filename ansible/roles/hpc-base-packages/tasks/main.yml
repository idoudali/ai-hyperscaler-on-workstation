---
# HPC Base Packages Role - Main Tasks
# This role installs only essential packages and NVIDIA GPU drivers

- name: Update package cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: true

- name: Install essential system packages
  apt:
    name:
      - git
      - wget
      - curl
      - vim
      - htop
      - unzip
      - bzip2
      - gzip
      - tar
      - rsync
      - openssh-server
      - openssh-client
      - ca-certificates
      - apt-transport-https
      - gnupg
      - lsb-release
      - build-essential
    state: present
  become: true
  notify: restart services

- name: Install NVIDIA repository GPG key
  shell: |
    wget -O- https://developer.download.nvidia.com/compute/cuda/repos/debian12/x86_64/3bf863cc.pub | gpg --dearmor -o /usr/share/keyrings/nvidia-cuda-archive-keyring.gpg
  become: true
  args:
    creates: /usr/share/keyrings/nvidia-cuda-archive-keyring.gpg
  register: nvidia_key_result
  failed_when: false
  ignore_errors: true

- name: Display NVIDIA key installation result
  debug:
    msg: "NVIDIA GPG key installation result: {{ nvidia_key_result }}"
  when: nvidia_key_result is defined

- name: Add NVIDIA CUDA repository
  shell: |
    echo "deb [signed-by=/usr/share/keyrings/nvidia-cuda-archive-keyring.gpg] https://developer.download.nvidia.com/compute/cuda/repos/debian12/x86_64/ /" > /etc/apt/sources.list.d/nvidia-cuda.list
  become: true
  args:
    creates: /etc/apt/sources.list.d/nvidia-cuda.list
  register: nvidia_repo_add_result
  failed_when: false
  ignore_errors: true

- name: Display NVIDIA repository addition result
  debug:
    msg: "NVIDIA repository addition result: {{ nvidia_repo_add_result }}"
  when: nvidia_repo_add_result is defined

- name: Update package cache after adding NVIDIA repository
  apt:
    update_cache: yes
  become: true

- name: Verify NVIDIA repository was added
  stat:
    path: /etc/apt/sources.list.d/nvidia-cuda.list
  register: nvidia_repo_check

- name: Verify NVIDIA GPG key was added
  stat:
    path: /usr/share/keyrings/nvidia-cuda-archive-keyring.gpg
  register: nvidia_key_check

- name: Display NVIDIA repository status
  debug:
    msg: |
      NVIDIA Repository Status:
      - Repository file exists: {{ nvidia_repo_check.stat.exists if nvidia_repo_check is defined else 'Unknown' }}
      - GPG key exists: {{ nvidia_key_check.stat.exists if nvidia_key_check is defined else 'Unknown' }}
  when: nvidia_repo_check is defined and nvidia_key_check is defined

- name: Check available NVIDIA packages
  apt:
    update_cache: yes
  become: true

- name: Check if NVIDIA packages are available
  shell: apt-cache search nvidia-driver-535 | head -5
  register: nvidia_package_check
  changed_when: false
  failed_when: false
  ignore_errors: true
  when: nvidia_repo_check.stat.exists and nvidia_key_check.stat.exists

- name: Display available NVIDIA packages
  debug:
    msg: "Available NVIDIA packages: {{ nvidia_package_check.stdout_lines }}"
  when: nvidia_package_check is defined and nvidia_package_check.rc == 0 and nvidia_package_check.stdout_lines | length > 0

- name: Display no NVIDIA packages available
  debug:
    msg: "No NVIDIA packages found in repository - skipping NVIDIA installation"
  when: nvidia_package_check is defined and (nvidia_package_check.rc != 0 or nvidia_package_check.stdout_lines | length == 0)

- name: Display NVIDIA repository not set up
  debug:
    msg: "NVIDIA repository not properly set up - skipping NVIDIA package check"
  when: nvidia_package_check is not defined

- name: Install NVIDIA GPU drivers and CUDA toolkit
  apt:
    name:
      - nvidia-driver-535
      - nvidia-utils-535
      - nvidia-settings
      - cuda-toolkit-12-4
      - cuda-drivers
      - nvidia-modprobe
      - nvidia-persistenced
    state: present
    install_recommends: no
  become: true
  notify: restart nvidia services
  ignore_errors: true
  register: nvidia_install_result
  when: nvidia_package_check is defined and nvidia_package_check.rc == 0 and nvidia_package_check.stdout_lines | length > 0

- name: Display NVIDIA installation result
  debug:
    msg: "NVIDIA installation result: {{ nvidia_install_result }}"
  when: nvidia_install_result is defined

- name: Display NVIDIA installation summary
  debug:
    msg: |
      NVIDIA Installation Summary:
      - Installation attempted: {{ 'Yes' if (nvidia_package_check is defined and nvidia_package_check.rc == 0 and nvidia_package_check.stdout_lines | length > 0) else 'No' }}
      - Installation successful: {{ 'Yes' if (nvidia_install_result is defined and nvidia_install_result.changed) else 'No' }}
      - Packages changed: {{ nvidia_install_result.changed if nvidia_install_result is defined else 'N/A' }}
      - Packages failed: {{ nvidia_install_result.failed if nvidia_install_result is defined else 'N/A' }}
  when: nvidia_install_result is defined

- name: Install NVIDIA container runtime
  apt:
    name:
      - nvidia-container-toolkit
      - nvidia-container-runtime
    state: present
    install_recommends: no
  become: true
  ignore_errors: true
  register: nvidia_container_result
  when: nvidia_package_check is defined and nvidia_package_check.rc == 0 and nvidia_package_check.stdout_lines | length > 0

- name: Display NVIDIA container installation result
  debug:
    msg: "NVIDIA container installation result: {{ nvidia_container_result }}"
  when: nvidia_container_result is defined

- name: Display NVIDIA container installation summary
  debug:
    msg: |
      NVIDIA Container Runtime Installation Summary:
      - Installation attempted: {{ 'Yes' if (nvidia_package_check is defined and nvidia_package_check.rc == 0 and nvidia_package_check.stdout_lines | length > 0) else 'No' }}
      - Installation successful: {{ 'Yes' if (nvidia_container_result is defined and nvidia_container_result.changed) else 'No' }}
      - Packages changed: {{ nvidia_container_result.changed if nvidia_container_result is defined else 'N/A' }}
      - Packages failed: {{ nvidia_container_result.failed if nvidia_container_result is defined else 'N/A' }}
  when: nvidia_container_result is defined

- name: Ensure Docker daemon configuration directory exists
  file:
    path: /etc/docker
    state: directory
    mode: '0755'
    owner: root
    group: root
  become: true
  when: ansible_facts.pkg_mgr == "apt" and nvidia_container_result is defined and nvidia_container_result.changed

- name: Configure NVIDIA container runtime
  copy:
    content: |
      {
        "default-runtime": "nvidia",
        "runtimes": {
          "nvidia": {
            "path": "nvidia-container-runtime",
            "runtimeArgs": []
          }
        }
      }
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: '0644'
  become: true
  when: ansible_facts.pkg_mgr == "apt" and nvidia_container_result is defined and nvidia_container_result.changed

- name: Final package cleanup
  apt:
    autoremove: yes
    autoclean: yes
  become: true

- name: Display installation summary
  debug:
    msg: |
      Essential HPC Base Packages Installation Complete!

      Installed packages:
      - Essential system tools and utilities
      - NVIDIA GPU drivers and CUDA toolkit (if available)
      - NVIDIA container runtime support (if available)

      System configured for HPC workloads with:
      - Debian 13 (trixie) compatibility
      - Optimized kernel parameters
      - Increased system limits
      - NVIDIA container runtime support (if available)

      NVIDIA Installation Status:
      - Repository added: {{ nvidia_repo_check.stat.exists if nvidia_repo_check is defined else 'Unknown' }}
      - GPG key added: {{ nvidia_key_check.stat.exists if nvidia_key_check is defined else 'Unknown' }}
      - Packages available: {{ 'Yes' if (nvidia_package_check is defined and nvidia_package_check.rc == 0 and nvidia_package_check.stdout_lines | length > 0) else 'No' }}
      - Installation attempted: {{ 'Yes' if (nvidia_package_check is defined and nvidia_package_check.rc == 0 and nvidia_package_check.stdout_lines | length > 0) else 'No' }}
      - NVIDIA drivers installed: {{ 'Yes' if (nvidia_install_result is defined and nvidia_install_result.changed) else 'No' }}
      - Container runtime installed: {{ 'Yes' if (nvidia_container_result is defined and nvidia_container_result.changed) else 'No' }}

      Note: Some NVIDIA packages may not be available in all environments.
      Check the installation results above for any failed packages.
