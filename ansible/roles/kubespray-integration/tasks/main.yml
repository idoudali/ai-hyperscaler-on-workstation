# Kubespray Integration Role - Main Tasks
# This role integrates Kubespray for Kubernetes cluster deployment

- name: Kubespray setup and deployment
  delegate_to: localhost
  run_once: true
  become: false
  block:
    - name: Verify Kubespray installation
      ansible.builtin.stat:
        path: "{{ kubespray_source_dir }}/cluster.yml"
      register: kubespray_check
      failed_when: false

    - name: Fail if Kubespray not installed
      ansible.builtin.fail:
        msg: |
          Kubespray not found at: {{ kubespray_source_dir }}
          Please install Kubespray first:
            cmake --build build --target install-kubespray
          Or:
            make run-docker COMMAND="cmake --build build --target install-kubespray"
      when: not kubespray_check.stat.exists

    - name: Verify inventory file exists
      ansible.builtin.stat:
        path: "{{ (playbook_dir + '/..' + '/..' + '/' + kubespray_inventory_file) if not kubespray_inventory_file.startswith('/') else kubespray_inventory_file }}"
      register: inventory_check
      failed_when: false

    - name: Fail if inventory not found
      ansible.builtin.fail:
        msg: |
          Kubespray inventory not found at: {{ kubespray_inventory_file }}
          Please generate inventory first:
            python scripts/generate-kubespray-inventory.py config/cloud-cluster.yaml cloud <inventory_path>
      when: not inventory_check.stat.exists

    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          Deploying Kubernetes cluster via Kubespray
          Inventory: {{ kubespray_inventory_file }}
          Kubespray Source: {{ kubespray_source_dir }}
          Kubernetes Version: {{ kube_version | default('v1.28.0') }}
          CNI: {{ kube_network_plugin | default('calico') }}

    - name: Resolve absolute paths
      ansible.builtin.set_fact:
        kubespray_source_dir_abs: "{{ kubespray_source_dir | realpath }}"
        kubespray_inventory_abs: "{{ ((playbook_dir + '/..' + '/..' + '/' + kubespray_inventory_file) if not kubespray_inventory_file.startswith('/') else kubespray_inventory_file) | realpath }}"
        kubespray_cluster_yml: "{{ (kubespray_source_dir + '/cluster.yml') | realpath }}"
        collections_path: "{{ (playbook_dir + '/..' + '/..' + '/collections') | realpath }}"
        ansible_cfg_path: "{{ (playbook_dir + '/..' + '/ansible.cfg') | realpath }}"

    - name: Check if requirements.txt exists
      ansible.builtin.stat:
        path: "{{ kubespray_source_dir_abs }}/requirements.txt"
      register: kubespray_requirements

    - name: Setup Python virtual environment
      block:
        - name: Create Python venv for Ansible
          ansible.builtin.command: python3 -m venv "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17"
          args:
            creates: "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17/bin/activate"
            chdir: "{{ kubespray_source_dir_abs }}"

        - name: Install pip and Ansible core in venv
          ansible.builtin.pip:
            name:
              - pip
              - "ansible-core>=2.17.3,<2.18.0"
            virtualenv: "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17"
            virtualenv_python: python3
            state: latest

        - name: Install Kubespray Python requirements
          ansible.builtin.pip:
            requirements: "{{ kubespray_source_dir_abs }}/requirements.txt"
            virtualenv: "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17"
            virtualenv_python: python3
          when: kubespray_requirements.stat.exists

        - name: Install netaddr if requirements.txt missing
          ansible.builtin.pip:
            name: netaddr
            virtualenv: "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17"
            virtualenv_python: python3
          when: not kubespray_requirements.stat.exists

    - name: Define required Ansible collections
      ansible.builtin.set_fact:
        kubespray_required_collections:
          - "ansible.utils:>=2.5.0"
          - "community.crypto:>=2.22.3"
          - "community.general:>=7.0.0"
          - "ansible.netcommon:>=5.3.0"
          - "ansible.posix:>=1.5.4"
          - "community.docker:>=3.11.0"
          - "kubernetes.core:>=2.4.2"

    - name: Install required Ansible collections
      ansible.builtin.command:
        cmd: "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17/bin/ansible-galaxy collection install {{ item }} -p \"{{ collections_path }}\""
      args:
        chdir: "{{ kubespray_source_dir_abs }}"
      environment:
        ANSIBLE_COLLECTIONS_PATHS: "{{ collections_path }}"
      loop: "{{ kubespray_required_collections }}"
      loop_control:
        label: "{{ item }}"
      changed_when: false

    - name: Run Kubespray cluster deployment
      ansible.builtin.command: >
        stdbuf -oL -eL {{ kubespray_source_dir_abs }}/.venv-ansible-2.17/bin/ansible-playbook -i "{{ kubespray_inventory_abs }}" -vv "{{ kubespray_cluster_yml }}"
      args:
        chdir: "{{ kubespray_source_dir_abs }}"
      environment:
        ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3
        ANSIBLE_CONFIG: "{{ ansible_cfg_path }}"
        ANSIBLE_BECOME: "True"
        ANSIBLE_ROLES_PATH: "{{ kubespray_source_dir_abs }}/roles:{{ playbook_dir + '/..' + '/roles' }}"
        PYTHONUNBUFFERED: "1"
        ANSIBLE_FORCE_COLOR: "1"
        ANSIBLE_STDOUT_CALLBACK: yaml
        ANSIBLE_COLLECTIONS_PATHS: "{{ collections_path }}"
      changed_when: true
