# Kubespray Integration Role - Main Tasks
# This role integrates Kubespray for Kubernetes cluster deployment

- name: Verify Kubespray installation
  ansible.builtin.stat:
    path: "{{ kubespray_source_dir }}/cluster.yml"
  register: kubespray_check
  delegate_to: localhost
  run_once: true
  become: false
  failed_when: false

- name: Fail if Kubespray not installed
  ansible.builtin.fail:
    msg: |
      Kubespray not found at: {{ kubespray_source_dir }}
      Please install Kubespray first:
        cmake --build build --target install-kubespray
      Or:
        make run-docker COMMAND="cmake --build build --target install-kubespray"
  when: not kubespray_check.stat.exists
  delegate_to: localhost
  run_once: true
  become: false

- name: Verify inventory file exists
  ansible.builtin.stat:
    path: "{{ (playbook_dir + '/..' + '/..' + '/' + kubespray_inventory_file) if not kubespray_inventory_file.startswith('/') else kubespray_inventory_file }}"
  register: inventory_check
  delegate_to: localhost
  run_once: true
  become: false
  failed_when: false

- name: Fail if inventory not found
  ansible.builtin.fail:
    msg: |
      Kubespray inventory not found at: {{ kubespray_inventory_file }}
      Please generate inventory first:
        python scripts/generate-kubespray-inventory.py config/cloud-cluster.yaml cloud <inventory_path>
  when: not inventory_check.stat.exists
  delegate_to: localhost
  run_once: true
  become: false

- name: Display deployment information
  ansible.builtin.debug:
    msg: |
      Deploying Kubernetes cluster via Kubespray
      Inventory: {{ kubespray_inventory_file }}
      Kubespray Source: {{ kubespray_source_dir }}
      Kubernetes Version: {{ kube_version | default('v1.28.0') }}
      CNI: {{ kube_network_plugin | default('calico') }}
  become: false

- name: Resolve absolute paths to Kubespray files
  ansible.builtin.set_fact:
    kubespray_source_dir_abs: "{{ lookup('pipe', 'realpath ' ~ kubespray_source_dir) }}"
    kubespray_inventory_abs: "{{ lookup('pipe', 'realpath ' ~ ((playbook_dir + '/..' + '/..' + '/' + kubespray_inventory_file) if not kubespray_inventory_file.startswith('/') else kubespray_inventory_file)) }}"
  delegate_to: localhost
  run_once: true
  become: false

- name: Set absolute path to cluster.yml
  ansible.builtin.set_fact:
    kubespray_cluster_yml: "{{ kubespray_source_dir_abs }}/cluster.yml"
  delegate_to: localhost
  run_once: true
  become: false

- name: Check if requirements.txt exists
  ansible.builtin.stat:
    path: "{{ kubespray_source_dir_abs }}/requirements.txt"
  register: kubespray_requirements
  delegate_to: localhost
  run_once: true
  become: false

- name: Ensure Python venv for Ansible exists
  ansible.builtin.command: python3 -m venv "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17"
  args:
    creates: "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17/bin/activate"
    chdir: "{{ kubespray_source_dir_abs }}"
  delegate_to: localhost
  run_once: true
  become: false

- name: Install/upgrade pip and Ansible core in venv
  ansible.builtin.pip:
    name:
      - pip
      - "ansible-core>=2.17.3,<2.18.0"
    virtualenv: "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17"
    virtualenv_python: python3
    state: latest
  delegate_to: localhost
  run_once: true
  become: false

- name: Install Kubespray Python requirements in venv
  ansible.builtin.pip:
    requirements: "{{ kubespray_source_dir_abs }}/requirements.txt"
    virtualenv: "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17"
    virtualenv_python: python3
  delegate_to: localhost
  run_once: true
  become: false
  when: kubespray_requirements.stat.exists

- name: Ensure netaddr is installed in venv if requirements.txt is missing
  ansible.builtin.pip:
    name: netaddr
    virtualenv: "{{ kubespray_source_dir_abs }}/.venv-ansible-2.17"
    virtualenv_python: python3
  delegate_to: localhost
  run_once: true
  become: false
  when: not kubespray_requirements.stat.exists

- name: Ensure Kubespray-required collections are installed
  ansible.builtin.command: >
    {{ kubespray_source_dir_abs }}/.venv-ansible-2.17/bin/ansible-galaxy collection install ansible.utils:>=2.5.0 community.crypto:>=2.22.3 community.general:>=7.0.0 ansible.netcommon:>=5.3.0 ansible.posix:>=1.5.4 community.docker:>=3.11.0 kubernetes.core:>=2.4.2 -p "{{ playbook_dir + '/..' + '/..' + '/collections' }}"
  args:
    chdir: "{{ kubespray_source_dir_abs }}"
  environment:
    ANSIBLE_COLLECTIONS_PATHS: "{{ playbook_dir + '/..' + '/..' + '/collections' }}"
  delegate_to: localhost
  run_once: true
  become: false
  changed_when: false # ansible-galaxy collection install is idempotent

- name: Run Kubespray cluster deployment playbook
  ansible.builtin.command: >
    stdbuf -oL -eL {{ kubespray_source_dir_abs }}/.venv-ansible-2.17/bin/ansible-playbook -i "{{ kubespray_inventory_abs }}" -vv "{{ kubespray_cluster_yml }}"
  args:
    chdir: "{{ kubespray_source_dir_abs }}"
  environment:
    ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3
    ANSIBLE_CONFIG: "{{ playbook_dir + '/..' + '/ansible.cfg' }}"
    ANSIBLE_ROLES_PATH: "{{ kubespray_source_dir_abs }}/roles:{{ playbook_dir + '/..' + '/roles' }}"
    PYTHONUNBUFFERED: "1"
    ANSIBLE_FORCE_COLOR: "1"
    ANSIBLE_STDOUT_CALLBACK: yaml
    ANSIBLE_COLLECTIONS_PATHS: "{{ playbook_dir + '/..' + '/..' + '/collections' }}"
  delegate_to: localhost
  run_once: true
  become: false
  changed_when: true # Kubespray deployment will report changes through its own playbook
