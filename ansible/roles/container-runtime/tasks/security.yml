---
# Container Security Policy Tasks
# This file handles security configuration for container runtime
# including security policies and access controls

- name: Create {{ container_runtime_type }} configuration directory
  file:
    path: "{{ container_runtime_config_dir }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags: [container-runtime, security, config]

- name: Deploy {{ container_runtime_type }} configuration template
  template:
    src: "{{ container_runtime_type }}.conf.j2"
    dest: "{{ container_runtime_config_file }}"
    mode: '0644'
    owner: root
    group: root
    backup: yes
  notify: restart container runtime services
  tags: [container-runtime, security, config]

- name: Create container runtime security directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop: "{{ container_runtime_security_directories }}"
  tags: [container-runtime, security, directories]

- name: Check if sysctl parameters exist
  stat:
    path: "/proc/sys/{{ item.name | replace('.', '/') }}"
  register: sysctl_param_check
  loop: "{{ container_runtime_sysctl_settings }}"
  when: container_runtime_enable_user_namespaces | bool
  tags: [container-runtime, security, sysctl]

- name: Set up user namespace mapping
  sysctl:
    name: "{{ item.item.name }}"
    value: "{{ item.item.value }}"
    state: present
    reload: yes
  loop: "{{ sysctl_param_check.results }}"
  when:
    - container_runtime_enable_user_namespaces | bool
    - item.stat.exists
  tags: [container-runtime, security, sysctl]

- name: Display skipped sysctl parameters
  debug:
    msg: "Skipped sysctl parameter {{ item.item.name }} - not available on this system"
  loop: "{{ sysctl_param_check.results }}"
  when:
    - container_runtime_enable_user_namespaces | bool
    - not item.stat.exists
  tags: [container-runtime, security, sysctl]

- name: Verify user namespace support
  command: "unshare --user --map-root-user --mount-proc --pid --fork true"
  register: userns_test
  changed_when: false
  failed_when: false
  when: container_runtime_enable_user_namespaces | bool
  tags: [container-runtime, security, validation]

- name: Display user namespace support status
  debug:
    msg: "User namespace support: {{ 'Available' if userns_test.rc == 0 else 'Not available or restricted' }}"
  when: container_runtime_enable_user_namespaces | bool
  tags: [container-runtime, security, validation]

- name: Configure FUSE permissions
  file:
    path: "{{ item }}"
    mode: '0666'
    owner: root
    group: root
  loop: "{{ container_runtime_fuse_devices }}"
  when: container_runtime_enable_fuse | bool
  tags: [container-runtime, security, fuse]

- name: Create container runtime security policy file
  copy:
    content: |
      # Container Runtime Security Policy
      # Generated by Ansible on {{ ansible_date_time.iso8601 }}

      # Allow container execution
      allow_container_execution = {{ container_runtime_allow_execution | lower }}

      # Security restrictions
      allow_suid = {{ container_runtime_allow_suid | lower }}
      allow_pid_namespace = {{ container_runtime_allow_pid_namespace | lower }}
      mount_hostfs = {{ container_runtime_mount_hostfs | lower }}

      # Resource limits
      max_container_size = {{ container_runtime_max_size }}
      max_container_memory = {{ container_runtime_max_memory }}

      # Network restrictions
      allow_networking = {{ container_runtime_allow_networking | lower }}
      allowed_networks = {{ container_runtime_allowed_networks | join(',') }}
    dest: "{{ container_runtime_security_policy_file }}"
    mode: '0644'
    owner: root
    group: root
  tags: [container-runtime, security, policy]

- name: Verify security configuration
  command: "{{ container_runtime_binary }} config validate"
  register: security_config_validation
  changed_when: false
  failed_when: security_config_validation.rc != 0
  tags: [container-runtime, security, validation]

- name: Display security configuration status
  debug:
    msg: "Container runtime security configuration validated successfully"
  when: security_config_validation.rc == 0
  tags: [container-runtime, security, validation]
