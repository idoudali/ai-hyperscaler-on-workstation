---
# BeeGFS Management Service - Installation Tasks
# Installs from pre-built packages only (no source build)

- name: Check if BeeGFS management service is already installed
  ansible.builtin.stat:
    path: /usr/bin/beegfs-mgmtd
  register: beegfs_mgmtd_installed
  tags:
    - beegfs
    - beegfs-mgmt
    - check

- name: Check if packages directory exists on remote host
  ansible.builtin.stat:
    path: "{{ beegfs_packages_path }}"
  register: packages_dir_check
  tags:
    - beegfs
    - beegfs-mgmt
    - check

- name: Check if pre-built packages exist on remote host
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: prebuilt_packages_check
  when:
    - not beegfs_mgmtd_installed.stat.exists
    - packages_dir_check.stat.exists | default(false)
  tags:
    - beegfs
    - beegfs-mgmt
    - check

- name: Check if packages exist on Ansible controller (for runtime deployment)
  ansible.builtin.find:
    paths: "{{ beegfs_packages_source_dir | default('build/packages/beegfs') }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: controller_packages_check
  delegate_to: localhost
  become: false
  when:
    - not beegfs_mgmtd_installed.stat.exists
    - (not (packages_dir_check.stat.exists | default(false))) or (prebuilt_packages_check.matched | default(0) == 0)
  tags:
    - beegfs
    - beegfs-mgmt
    - check

- name: Debug controller packages check
  ansible.builtin.debug:
    msg:
      - "Looking for packages in: {{ beegfs_packages_source_dir | default('build/packages/beegfs') }}"
      - "Found {{ controller_packages_check.matched | default(0) }} package(s)"
      - "Files: {{ controller_packages_check.files | default([]) | map(attribute='path') | list }}"
  when: not beegfs_mgmtd_installed.stat.exists
  tags:
    - beegfs
    - beegfs-mgmt
    - check

- name: Create BeeGFS packages directory on remote host (for runtime deployment)
  ansible.builtin.file:
    path: "{{ beegfs_packages_path }}"
    state: directory
    mode: '0755'
  when:
    - not beegfs_mgmtd_installed.stat.exists
    - (not (packages_dir_check.stat.exists | default(false))) or (prebuilt_packages_check.matched | default(0) == 0)
    - controller_packages_check.matched | default(0) > 0
  tags:
    - beegfs
    - beegfs-mgmt
    - copy

- name: Copy pre-built packages from Ansible controller to remote host
  ansible.builtin.copy:
    src: "{{ beegfs_packages_source_dir | default('build/packages/beegfs') }}/"
    dest: "{{ beegfs_packages_path }}/"
    mode: '0644'
  when:
    - not beegfs_mgmtd_installed.stat.exists
    - (not (packages_dir_check.stat.exists | default(false))) or (prebuilt_packages_check.matched | default(0) == 0)
    - controller_packages_check.matched | default(0) > 0
  tags:
    - beegfs
    - beegfs-mgmt
    - copy

- name: Re-check if pre-built packages exist after copy
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: prebuilt_packages_check_final
  when:
    - not beegfs_mgmtd_installed.stat.exists
  tags:
    - beegfs
    - beegfs-mgmt
    - check

- name: Fail if pre-built packages not found
  ansible.builtin.fail:
    msg: >-
      BeeGFS pre-built packages not found at {{ beegfs_packages_path }}.
      Expected: beegfs-utils_{{ beegfs_version }}_*.deb (and other packages)
      Checked on controller: {{ beegfs_packages_source_dir | default('build/packages/beegfs') }}
      For Packer builds: Packages should be copied by Packer to /tmp/beegfs-packages/
      For runtime: Build packages first with: cmake --build build --target build-beegfs-packages
      Note: BeeGFS 8.1.0 no longer has beegfs-common package
  when:
    - not beegfs_mgmtd_installed.stat.exists
    - prebuilt_packages_check_final.matched | default(0) == 0
  tags:
    - beegfs
    - beegfs-mgmt

- name: Display package installation method
  ansible.builtin.debug:
    msg: "{{ 'BeeGFS management already installed, skipping' if beegfs_mgmtd_installed.stat.exists else 'Installing BeeGFS management packages from ' + beegfs_packages_path }}"
  tags:
    - beegfs
    - beegfs-mgmt

- name: Find BeeGFS management service packages
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns:
      - "beegfs-mgmtd_{{ beegfs_version }}_*.deb"
      - "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: beegfs_mgmt_pkgs
  when: not beegfs_mgmtd_installed.stat.exists
  tags:
    - beegfs
    - beegfs-mgmt
    - install

- name: Install BeeGFS management service packages
  ansible.builtin.apt:
    deb: "{{ item.path }}"
    state: present
  loop: "{{ beegfs_mgmt_pkgs.files }}"
  when:
    - not beegfs_mgmtd_installed.stat.exists
    - beegfs_mgmt_pkgs.matched > 0
  tags:
    - beegfs
    - beegfs-mgmt
    - install

- name: Create BeeGFS management storage directory
  ansible.builtin.file:
    path: "{{ beegfs_mgmt_storage_directory }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - beegfs
    - beegfs-mgmt
    - directories

- name: Create BeeGFS management log directory
  ansible.builtin.file:
    path: "{{ beegfs_mgmt_log_directory }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - beegfs
    - beegfs-mgmt
    - directories

- name: Verify BeeGFS management service installation
  ansible.builtin.command:
    cmd: beegfs-mgmtd --version
  register: beegfs_mgmt_version
  changed_when: false
  failed_when: false
  tags:
    - beegfs
    - beegfs-mgmt
    - verify

- name: Display installation status
  ansible.builtin.debug:
    msg: >-
      BeeGFS management service installed successfully
      (Version: {{ beegfs_mgmt_version.stdout_lines[0] if beegfs_mgmt_version.rc == 0 else 'unknown' }},
      packer_build={{ packer_build }})
  tags:
    - beegfs
    - beegfs-mgmt
