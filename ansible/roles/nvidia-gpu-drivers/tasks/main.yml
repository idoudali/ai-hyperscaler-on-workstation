# NVIDIA GPU Drivers Role - Main Tasks
# This role installs NVIDIA proprietary GPU drivers following Debian wiki guidelines
# Reference: https://wiki.debian.org/NvidiaGraphicsDrivers

- name: Force NVIDIA driver installation (no GPU detection)
  ansible.builtin.debug:
    msg: "Installing NVIDIA drivers regardless of GPU presence for Packer build"
    verbosity: 1

- name: Configure NVIDIA GPU drivers and dependencies
  block:
    - name: Enable non-free repository for NVIDIA drivers
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        regexp: '^deb http://deb.debian.org/debian'
        line: 'deb http://deb.debian.org/debian {{ ansible_distribution_release }} main contrib non-free non-free-firmware'
        state: present
        backup: true
      notify: update apt cache

    - name: Ensure non-free-firmware is in sources.list (for Debian 12+)
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        regexp: '^deb-src http://deb.debian.org/debian'
        line: 'deb-src http://deb.debian.org/debian {{ ansible_distribution_release }} main contrib non-free non-free-firmware'
        state: present
        backup: true
      when: ansible_distribution_major_version|int >= 12
      notify: update apt cache

    - name: Force apt cache update
      ansible.builtin.meta: flush_handlers

    # Kernel Headers Installation Strategy
    # This approach handles the common issue where kernel header packages don't exactly match
    # the running kernel version. We try multiple package name variations in order of preference:
    # 1. Exact kernel version (e.g., linux-headers-6.12.48+deb13-cloud-amd64)
    # 2. Kernel version without suffix (e.g., linux-headers-6.12.48)
    # 3. Cloud kernel headers (e.g., linux-headers-cloud-amd64)
    # 4. Generic headers (e.g., linux-headers-generic)
    # This is a 4-tier kernel headers installation strategy

    - name: Install build tools and DKMS (required for NVIDIA kernel module build)
      ansible.builtin.apt:
        name:
          - build-essential
          - dkms
          - gcc
          - make
        state: present

    - name: Try to install exact kernel headers for running kernel
      ansible.builtin.apt:
        name: "linux-headers-{{ ansible_kernel }}"
        state: present
      register: kernel_headers_exact
      failed_when: false

    - name: Try to install kernel headers without suffix (fallback 1)
      ansible.builtin.apt:
        name: "linux-headers-{{ ansible_kernel.split('+')[0] }}"
        state: present
      register: kernel_headers_no_suffix
      when: kernel_headers_exact is failed
      failed_when: false

    - name: Try to install cloud kernel headers (fallback 2)
      ansible.builtin.apt:
        name: "linux-headers-cloud-amd64"
        state: present
      register: kernel_headers_cloud
      when: kernel_headers_exact is failed and kernel_headers_no_suffix is failed
      failed_when: false

    - name: Try to install generic kernel headers (fallback 3)
      ansible.builtin.apt:
        name: "linux-headers-generic"
        state: present
      register: kernel_headers_generic
      when: kernel_headers_exact is failed and kernel_headers_no_suffix is failed and (kernel_headers_cloud is not defined or kernel_headers_cloud is failed)
      failed_when: false

    - name: Set fact for successfully installed kernel header package (exact match)
      ansible.builtin.set_fact:
        successful_kernel_header: "linux-headers-{{ ansible_kernel }}"
      when: kernel_headers_exact is succeeded

    - name: Set fact for successfully installed kernel header package (no suffix)
      ansible.builtin.set_fact:
        successful_kernel_header: "linux-headers-{{ ansible_kernel.split('+')[0] }}"
      when: kernel_headers_no_suffix is succeeded

    - name: Set fact for successfully installed kernel header package (cloud)
      ansible.builtin.set_fact:
        successful_kernel_header: "linux-headers-cloud-amd64"
      when: kernel_headers_cloud is defined and kernel_headers_cloud is succeeded

    - name: Set fact for successfully installed kernel header package (generic)
      ansible.builtin.set_fact:
        successful_kernel_header: "linux-headers-generic"
      when: kernel_headers_generic is succeeded

    - name: Set fact for kernel header installation failure
      ansible.builtin.set_fact:
        successful_kernel_header: "none"
      when: >
        kernel_headers_exact is failed and (kernel_headers_no_suffix is not defined or kernel_headers_no_suffix is failed) and (kernel_headers_cloud is not defined or kernel_headers_cloud is failed) and (kernel_headers_generic is not defined or kernel_headers_generic is failed)

    - name: Verify kernel headers installation
      ansible.builtin.debug:
        msg: "Successfully installed kernel headers: {{ successful_kernel_header }}"
      when: successful_kernel_header != 'none'

    - name: Fail if kernel headers could not be installed
      ansible.builtin.fail:
        msg: |
          ❌ CRITICAL: Could not install kernel headers for kernel {{ ansible_kernel }}

          Tried the following package names:
          1. linux-headers-{{ ansible_kernel }} - {{ 'SUCCESS' if kernel_headers_exact is succeeded else 'FAILED' }}
          2. linux-headers-{{ ansible_kernel.split('+')[0] }} - {{ 'SUCCESS' if (kernel_headers_no_suffix is defined and kernel_headers_no_suffix is succeeded) else 'FAILED' if (kernel_headers_no_suffix is defined and kernel_headers_no_suffix is failed) else 'NOT ATTEMPTED' }}
          3. linux-headers-cloud-amd64 - {{ 'SUCCESS' if (kernel_headers_cloud is defined and kernel_headers_cloud is succeeded) else 'FAILED' if (kernel_headers_cloud is defined and kernel_headers_cloud is failed) else 'NOT ATTEMPTED' }}
          4. linux-headers-generic - {{ 'SUCCESS' if (kernel_headers_generic is defined and kernel_headers_generic is succeeded) else 'FAILED' if (kernel_headers_generic is defined and kernel_headers_generic is failed) else 'NOT ATTEMPTED' }}

          Manual fix:
            1. Update apt cache: sudo apt-get update
            2. Check available headers: apt-cache search linux-headers | grep {{ ansible_kernel.split('+')[0] }}
            3. Install manually: sudo apt-get install -y linux-headers-$(uname -r)
            4. Verify: dpkg -l | grep linux-headers

          Without kernel headers, NVIDIA kernel modules cannot be built.
      when: successful_kernel_header == 'none'

    - name: Install NVIDIA detection utility
      ansible.builtin.apt:
        name: nvidia-detect
        state: present

    - name: Detect recommended NVIDIA driver
      ansible.builtin.command: "nvidia-detect"
      register: nvidia_detect_output
      changed_when: false
      failed_when: false

    - name: Install NVIDIA driver package
      ansible.builtin.apt:
        name: nvidia-driver
        state: present

    - name: Install additional NVIDIA utilities
      ansible.builtin.apt:
        name:
          - nvidia-settings
          - nvidia-smi
        state: present

    # Check NVIDIA kernel modules after installation
    # NVIDIA drivers are installed via apt and modules should be built automatically
    # If headers were missing during install, modules might not exist
    - name: Check if NVIDIA kernel modules exist for current kernel
      ansible.builtin.find:
        paths: "/lib/modules/{{ ansible_kernel }}"
        patterns: "nvidia.ko*"
        recurse: true
      register: nvidia_module_check
      changed_when: false
      failed_when: false

    - name: Check if NVIDIA modules are loaded
      ansible.builtin.shell:
        cmd: "lsmod | grep -E '^nvidia' || true"
      register: nvidia_modules_loaded
      changed_when: false
      failed_when: false

    - name: Get installed NVIDIA driver version
      ansible.builtin.shell:
        cmd: "dpkg -l | grep '^ii.*nvidia-driver' | awk '{print $2}' | head -1"
      register: nvidia_driver_package
      changed_when: false
      failed_when: false

    - name: Check NVIDIA DKMS status
      ansible.builtin.shell:
        cmd: "dkms status | grep nvidia || echo 'NVIDIA not in DKMS'"
      register: nvidia_dkms_status
      changed_when: false
      failed_when: false

    - name: Display NVIDIA kernel module status
      ansible.builtin.debug:
        msg: |
          NVIDIA Kernel Module Status:
          - Running kernel: {{ ansible_kernel }}
          - Kernel headers: {{ successful_kernel_header if successful_kernel_header != 'none' else 'NOT INSTALLED' }}
          - Module files exist: {{ '✓' if (nvidia_module_check.matched | default(0)) > 0 else '✗' }}
          - Modules loaded: {{ '✓' if (nvidia_modules_loaded.rc == 0 and nvidia_modules_loaded.stdout | length > 0) else '✗' }}
          - Driver package: {{ nvidia_driver_package.stdout if nvidia_driver_package.rc == 0 else 'unknown' }}
          - DKMS status: {{ nvidia_dkms_status.stdout if nvidia_dkms_status.rc == 0 else 'not in DKMS' }}
          - Packer build: {{ packer_build | default(false) }}

    # Driver rebuild logic - SKIP during Packer builds (first install)
    # This logic is only needed for existing installations where drivers may need rebuilding
    # During Packer builds, we're doing a fresh install, so no rebuild is necessary
    - name: Skip driver rebuild during Packer builds
      ansible.builtin.debug:
        msg: "Skipping driver rebuild logic - this is a Packer build (first install)"
      when: packer_build | default(false) | bool

    # Include driver rebuild tasks for live systems (not Packer builds)
    - name: Include driver rebuild tasks for live systems
      include_tasks: rebuild-driver-modules.yml
      when: not (packer_build | default(false) | bool)

    - name: Blacklist nouveau driver (conflicts with NVIDIA)
      ansible.builtin.copy:
        content: |
          # Blacklist nouveau driver to prevent conflicts with NVIDIA
          blacklist nouveau
          blacklist lbm-nouveau
          options nouveau modeset=0
          alias nouveau off
          alias lbm-nouveau off
        dest: /etc/modprobe.d/blacklist-nouveau.conf
        mode: '0644'
      notify: update initramfs

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file

    - name: Notify about required reboot (runtime deployments)
      ansible.builtin.debug:
        msg: |
          IMPORTANT: A system reboot is required to complete NVIDIA driver installation.
          The system will need to be rebooted before the NVIDIA driver will be functional.
          Run 'sudo reboot' after this playbook completes.
        verbosity: 1
      when:
        - not (nvidia_packer_build | default(false) | bool)
        - (reboot_required_file.stat.exists or nvidia_force_reboot_warning)

    - name: Notify about Packer build completion
      ansible.builtin.debug:
        msg: |
          NVIDIA drivers installed successfully during Packer build.
          Drivers will be available after the image is deployed and rebooted.
          No reboot required during image creation process.
        verbosity: 1
      when: nvidia_packer_build | default(false) | bool

  # Always execute NVIDIA driver installation (no conditional check)

# Verify nvidia-smi works after installation (runtime only)
- name: Verify NVIDIA driver functionality
  block:
    - name: Check if nvidia-smi is available
      ansible.builtin.command:
        cmd: which nvidia-smi
      register: nvidia_smi_path
      changed_when: false
      failed_when: false

    - name: Test nvidia-smi execution
      ansible.builtin.command:
        cmd: nvidia-smi --query-gpu=driver_version --format=csv,noheader,nounits
      register: nvidia_smi_test
      changed_when: false
      failed_when: false
      when: nvidia_smi_path.rc == 0

    - name: Verify nvidia-smi works (no reboot required check)
      ansible.builtin.debug:
        msg: |
          NVIDIA Driver Verification:
          - nvidia-smi path: {{ nvidia_smi_path.stdout if nvidia_smi_path.rc == 0 else 'not found' }}
          - nvidia-smi test: {{ '✓ SUCCESS' if (nvidia_smi_test is defined and nvidia_smi_test.rc == 0) else '✗ FAILED or SKIPPED' }}
          - Driver version: {{ nvidia_smi_test.stdout if (nvidia_smi_test is defined and nvidia_smi_test.rc == 0) else 'unknown' }}
      when: nvidia_smi_path.rc == 0 or nvidia_smi_test is defined

    - name: Display nvidia-smi output if successful
      ansible.builtin.debug:
        msg: "{{ nvidia_smi_test.stdout_lines }}"
      when: >
        nvidia_smi_test is defined and nvidia_smi_test.rc == 0

    - name: Warn if nvidia-smi failed (likely requires reboot)
      ansible.builtin.debug:
        msg: |
          ⚠️  WARNING: nvidia-smi test failed

          This is typically expected after initial driver installation and requires a system reboot.

          After reboot, verify with:
            nvidia-smi

          If nvidia-smi still fails after reboot, check:
            1. Kernel modules loaded: lsmod | grep nvidia
            2. Driver version: dpkg -l | grep nvidia-driver
            3. System logs: dmesg | grep -i nvidia
      when: >
        nvidia_smi_test is defined and nvidia_smi_test.rc != 0 and not (nvidia_packer_build | default(false) | bool)
