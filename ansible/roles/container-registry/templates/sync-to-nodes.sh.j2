#!/bin/bash
# Container Registry Sync Script
# Syncs container images from controller to compute nodes
# Generated by Ansible - Managed automatically

set -euo pipefail

# Configuration
REGISTRY_BASE="{{ container_registry_base_path }}"
SSH_KEY="/root/.ssh/id_rsa_registry_sync"
RSYNC_OPTS="-avz --delete --progress"
{% if groups['compute'] is defined %}
COMPUTE_NODES=(
{% for node in groups['compute'] %}
  "{{ node }}"
{% endfor %}
)
{% else %}
COMPUTE_NODES=()
{% endif %}

# Logging
LOG_FILE="/var/log/container-registry-sync.log"
log() {
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Validate source exists
if [ ! -d "$REGISTRY_BASE" ]; then
  log "ERROR: Registry base directory $REGISTRY_BASE does not exist"
  exit 1
fi

# Validate SSH key
if [ ! -f "$SSH_KEY" ]; then
  log "ERROR: SSH key $SSH_KEY not found"
  exit 1
fi

# Function to sync to a single node
sync_to_node() {
  local node="$1"
  local subdir="${2:-}"  # Optional: specific subdirectory to sync

  local source_path="$REGISTRY_BASE/"
  if [ -n "$subdir" ]; then
    source_path="$REGISTRY_BASE/$subdir/"
    if [ ! -d "$source_path" ]; then
      log "WARNING: Source subdirectory $source_path does not exist, skipping"
      return 0
    fi
  fi

  log "Syncing $source_path to $node..."

  if rsync $RSYNC_OPTS \
      -e "ssh -i $SSH_KEY -o StrictHostKeyChecking=no -o BatchMode=yes" \
      "$source_path" \
      "root@${node}:${REGISTRY_BASE}/"; then
    log "SUCCESS: Synced to $node"
    return 0
  else
    log "ERROR: Failed to sync to $node"
    return 1
  fi
}

# Main execution
main() {
{% raw %}
  local subdir="${1:-}"  # Optional: sync specific subdirectory
  local failed_nodes=()

  log "Starting registry sync operation"

  if [ ${#COMPUTE_NODES[@]} -eq 0 ]; then
    log "WARNING: No compute nodes configured for synchronization"
    exit 0
  fi

  for node in "${COMPUTE_NODES[@]}"; do
    if ! sync_to_node "$node" "$subdir"; then
      failed_nodes+=("$node")
    fi
  done

  # Report results
  if [ ${#failed_nodes[@]} -eq 0 ]; then
    log "SUCCESS: All nodes synchronized successfully"
    exit 0
  else
    log "ERROR: Failed to sync to nodes: ${failed_nodes[*]}"
    exit 1
  fi
{% endraw %}
}

# Usage information
usage() {
{% raw %}
  cat <<'EOF'
Usage: $(basename "$0") [SUBDIRECTORY]

Sync container registry from controller to all compute nodes.

Arguments:
  SUBDIRECTORY  Optional: sync only specific subdirectory (e.g., ml-frameworks)

Examples:
  $(basename "$0")                    # Sync entire registry
  $(basename "$0") ml-frameworks      # Sync only ml-frameworks subdirectory

Registry Base: $REGISTRY_BASE
Compute Nodes: ${COMPUTE_NODES[*]}
EOF
{% endraw %}
}

# Handle arguments
case "${1:-}" in
  -h|--help)
    usage
    exit 0
    ;;
  *)
    main "$@"
    ;;
esac
