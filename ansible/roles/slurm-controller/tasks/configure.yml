# SLURM Configuration Deployment
# Task 011: Configure SLURM PMIx Integration

# Note: Directory creation is now handled by slurm-common role
# The following directories are created by slurm-common:
# - /etc/slurm (configuration directory)
# - /var/log/slurm (log directory)
# - /var/lib/slurm (state directory, if configured)
# - /var/spool/slurmd (spool directory, if configured)
# - /opt/containers (container images directory, if enabled)
# - /etc/slurm/cgroup (cgroup directory, if enabled)

- name: Deploy SLURM configuration template
  template:
    src: slurm.conf.j2
    dest: /etc/slurm/slurm.conf
    mode: '0644'
    owner: root
    group: root
    backup: true
  become: true
  register: slurm_config_deployed
  notify:
    - restart slurm services

- name: Deploy PMIx configuration template
  template:
    src: pmix.conf.j2
    dest: /etc/slurm/pmix.conf
    mode: '0644'
    owner: root
    group: root
    backup: true
  become: true
  register: pmix_config_deployed
  when: pmix_enabled | default(true)
  notify:
    - restart slurm services

# Task 013: Container plugin configuration deployment
- name: Deploy SLURM plugin stack configuration template
  template:
    src: plugstack.conf.j2
    dest: /etc/slurm/plugstack.conf
    mode: '0644'
    owner: root
    group: root
    backup: true
  become: true
  register: plugstack_config_deployed
  when: slurm_container_enabled | default(true)
  notify:
    - restart slurm services

- name: Deploy SLURM container plugin configuration template
  template:
    src: container.conf.j2
    dest: /etc/slurm/container.conf
    mode: '0644'
    owner: root
    group: root
    backup: true
  become: true
  register: container_config_deployed
  when: slurm_container_enabled | default(true)
  notify:
    - restart slurm services

- name: Create container images directory
  file:
    path: "{{ singularity_image_path | default('/opt/containers') }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  become: true
  when: slurm_container_enabled | default(true)

- name: Check if slurmctld binary exists
  stat:
    path: /usr/sbin/slurmctld
  register: slurmctld_binary
  when: not (packer_build | default(false) | bool)

- name: Check if SLURM configuration file exists
  stat:
    path: /etc/slurm/slurm.conf
  register: slurm_config_file
  when: not (packer_build | default(false) | bool)

- name: Validate SLURM configuration syntax
  command: /usr/sbin/slurmctld -t -f /etc/slurm/slurm.conf
  register: slurm_config_validation
  changed_when: false
  failed_when: false # Don't fail on validation errors for now
  become: true
  when:
    - not (packer_build | default(false) | bool)
    - slurmctld_binary.stat.exists | default(false)
    - slurm_config_file.stat.exists | default(false)

- name: Check PMIx library availability
  stat:
    path: "{{ item }}"
  loop:
    - /usr/lib/x86_64-linux-gnu/libpmix.so.2
    - /usr/lib/libpmix.so.2
  register: pmix_library_paths
  when: not (packer_build | default(false) | bool)

- name: Verify PMIx integration in SLURM
  command: /usr/bin/srun --mpi=list
  register: slurm_mpi_list
  changed_when: false
  failed_when: false
  when: not (packer_build | default(false) | bool)

- name: Check SLURM configuration values
  command: grep -E "{{ item }}" /etc/slurm/slurm.conf
  loop:
    - "MpiDefault"
    - "MpiParams"
    - "GresTypes"
    - "SelectType"
    - "ProctrackType"
  register: slurm_config_check
  changed_when: false
  when: not (packer_build | default(false) | bool)

- name: Validate PMIx configuration file
  command: grep -E "{{ item }}" /etc/slurm/pmix.conf
  loop:
    - "pmix_server_addr"
    - "pmix_server_port"
    - "pmix_client_addr"
    - "pmix_client_port"
  register: pmix_config_check
  changed_when: false
  when:
    - not (packer_build | default(false))
    - pmix_enabled | default(true)

- name: Test PMIx library functionality
  command: pmix_info --version
  register: pmix_version_check
  changed_when: false
  failed_when: false
  when: not (packer_build | default(false) | bool)

- name: Verify MPI port range configuration
  command: grep "MpiParams.*ports=" /etc/slurm/slurm.conf
  register: mpi_ports_check
  changed_when: false
  when: not (packer_build | default(false) | bool)

- name: Check PMIx library paths
  find:
    paths:
      - /usr/lib
      - /usr/lib/x86_64-linux-gnu
    patterns:
      - "libpmix*"
    file_type: file
  register: pmix_libraries_found
  when: not (packer_build | default(false) | bool)

# Task 013: Container plugin validation
- name: Check container plugin library exists
  stat:
    path: "{{ slurm_container_plugin_path | default('/usr/lib/x86_64-linux-gnu/slurm-wlm/container_singularity.so') }}"
  register: container_plugin_library
  when:
    - not (packer_build | default(false))
    - slurm_container_enabled | default(true)

- name: Verify Singularity/Apptainer runtime exists
  stat:
    path: "{{ singularity_runtime_path | default('/usr/bin/singularity') }}"
  register: singularity_runtime
  when:
    - not (packer_build | default(false))
    - slurm_container_enabled | default(true)

- name: Check SLURM container plugin loading
  command: grep -i "container" /var/log/slurm/slurmctld.log
  register: container_plugin_log_check
  changed_when: false
  failed_when: false
  when:
    - not (packer_build | default(false))
    - slurm_container_enabled | default(true)

- name: Validate plugin stack configuration
  command: grep -E "{{ item }}" /etc/slurm/plugstack.conf
  loop:
    - "include /etc/slurm/container.conf"
  register: plugstack_config_check
  changed_when: false
  failed_when: false
  when:
    - not (packer_build | default(false))
    - slurm_container_enabled | default(true)

- name: Validate container configuration file
  command: grep -E "{{ item }}" /etc/slurm/container.conf
  loop:
    - "required="
    - "runtime_path="
    - "enable_gpu="
    - "enable_overlay="
  register: container_config_check
  changed_when: false
  failed_when: false
  when:
    - not (packer_build | default(false))
    - slurm_container_enabled | default(true)

- name: Check container images directory
  stat:
    path: "{{ singularity_image_path | default('/opt/containers') }}"
  register: container_images_dir
  when:
    - not (packer_build | default(false))
    - slurm_container_enabled | default(true)

- name: Display SLURM configuration deployment results
  debug:
    msg: |
      SLURM Configuration deployed successfully:
      - Configuration file: /etc/slurm/slurm.conf
      - PMIx configuration file: {{ '/etc/slurm/pmix.conf' if pmix_enabled | default(true) else 'Not deployed' }}
      - Plugin stack configuration: {{ '/etc/slurm/plugstack.conf' if slurm_container_enabled | default(true) else 'Not deployed' }}
      - Container configuration: {{ '/etc/slurm/container.conf' if slurm_container_enabled | default(true) else 'Not deployed' }}
      - PMIx enabled: {{ pmix_enabled | default(true) }}
      - Container plugin enabled: {{ slurm_container_enabled | default(true) }}
      - MPI default: {{ slurm_mpi_default | default('pmix') }}
      - MPI ports: {{ pmix_ports | default('12000-12999') }}
      - GRES types: {{ gres_types | default('gpu') }}
      - Select type: {{ select_type | default('select/cons_tres') }}
      - Container runtime: {{ singularity_runtime_path | default('/usr/bin/singularity') }}
      - Container images path: {{ singularity_image_path | default('/opt/containers') }}
      {% if not (packer_build | default(false)) %}
      - Configuration validation: {{ 'PASSED' if (slurm_config_validation is defined and slurm_config_validation.rc is defined and slurm_config_validation.rc == 0) else 'SKIPPED/FAILED' }}
      - PMIx libraries found: {{ (pmix_library_paths.results | selectattr('stat.exists', 'defined') | selectattr('stat.exists', 'equalto', true) | list | length) if pmix_library_paths is defined else 'Not checked' }}
      - PMIx libraries paths: {{ 'Found' if (pmix_library_paths is defined and pmix_library_paths.results | selectattr('stat.exists', 'defined') | selectattr('stat.exists', 'equalto', true) | list | length > 0) else 'Not found' }}
      - Available MPI types: {{ slurm_mpi_list.stdout_lines if (slurm_mpi_list is defined and slurm_mpi_list.rc is defined and slurm_mpi_list.rc == 0) else 'Not checked' }}
      - PMIx version: {{ pmix_version_check.stdout if (pmix_version_check is defined and pmix_version_check.rc is defined and pmix_version_check.rc == 0) else 'Not available' }}
      - MPI ports configuration: {{ mpi_ports_check.stdout if (mpi_ports_check is defined and mpi_ports_check.rc is defined) else 'Not checked' }}
      - PMIx config validation: {{ 'PASSED' if (pmix_config_check is defined and pmix_config_check.results is defined and pmix_config_check.results | selectattr('rc', 'defined') | selectattr('rc', 'equalto', 0) | list | length > 0) else 'Not checked' }}
      {% if slurm_container_enabled | default(true) %}
      - Container plugin library exists: {{ 'YES' if container_plugin_library is defined and container_plugin_library.stat.exists else 'NO' if container_plugin_library is defined else 'Not checked' }}
      - Singularity runtime exists: {{ 'YES' if singularity_runtime is defined and singularity_runtime.stat.exists else 'NO' if singularity_runtime is defined else 'Not checked' }}
      - Container images directory: {{ 'CREATED' if container_images_dir is defined and container_images_dir.stat.exists else 'MISSING' if container_images_dir is defined else 'Not checked' }}
      - Plugin stack config valid: {{ 'PASSED' if (plugstack_config_check is defined and plugstack_config_check.results is defined and plugstack_config_check.results | selectattr('rc', 'defined') | selectattr('rc', 'equalto', 0) | list | length > 0) else 'Not checked' }}
      - Container config valid: {{ 'PASSED' if (container_config_check is defined and container_config_check.results is defined and container_config_check.results | selectattr('rc', 'defined') | selectattr('rc', 'equalto', 0) | list | length > 0) else 'Not checked' }}
      {% endif %}
      {% else %}
      - Note: Detailed validation skipped during Packer build
      {% endif %}

- name: Display SLURM configuration validation result
  debug:
    msg: |
      SLURM configuration validation result:
      - Return code: {{ slurm_config_validation.rc | default('N/A') }}
      - Status: {{ 'PASSED' if (slurm_config_validation.rc is defined and slurm_config_validation.rc == 0) else 'FAILED' if slurm_config_validation.rc is defined else 'SKIPPED' }}
      {% if slurm_config_validation.stderr is defined and slurm_config_validation.stderr %}
      - Error: {{ slurm_config_validation.stderr }}
      {% endif %}
  when:
    - not (packer_build | default(false))
    - slurm_config_validation is defined
