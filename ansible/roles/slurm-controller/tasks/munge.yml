---
# SLURM Controller Role - MUNGE Authentication Setup
# Configures MUNGE authentication system for SLURM cluster
- name: Create MUNGE directories and set ownership
  file:
    path: "{{ item }}"
    state: directory
    owner: munge
    group: munge
    mode: '0755'
    recurse: yes
  loop:
    - /etc/munge
    - /var/lib/munge
    - /var/log/munge
    - /var/run/munge
  become: true
- name: Check if MUNGE key exists
  stat:
    path: "{{ munge_key_path }}"
  register: munge_key_stat
  become: true
- name: Generate MUNGE key if needed
  block:
    - name: Stop MUNGE service for key generation
      service:
        name: munge
        state: stopped
      become: true
      ignore_errors: true
    - name: Remove existing key if regenerating
      file:
        path: "{{ munge_key_path }}"
        state: absent
      become: true
      when: munge_force_regenerate_key | default(false)
    - name: Create MUNGE key
      command: /usr/sbin/create-munge-key -f
      become: true
      notify: restart munge
    - name: Set MUNGE key permissions immediately
      file:
        path: "{{ munge_key_path }}"
        owner: munge
        group: munge
        mode: '0600'
      become: true
  when: not munge_key_stat.stat.exists or munge_force_regenerate_key | default(false)
- name: Ensure MUNGE key has correct permissions
  file:
    path: "{{ munge_key_path }}"
    owner: munge
    group: munge
    mode: '0600'
  become: true
- name: Ensure /etc/default directory exists
  file:
    path: /etc/default
    state: directory
    mode: '0755'
  become: true
- name: Configure MUNGE daemon defaults
  template:
    src: munge.default.j2
    dest: /etc/default/munge
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: restart munge
- name: Start and enable MUNGE service
  service:
    name: munge
    enabled: true
    state: started
  become: true
  when: not (packer_build | default(false) | bool)
- name: Wait for MUNGE service readiness
  wait_for:
    port: "{{ munge_port | default(6818) }}"
    host: "127.0.0.1"
    delay: 5
    timeout: 30
  when: not (packer_build | default(false) | bool)
  ignore_errors: true
- name: Validate MUNGE installation
  command: munge --version
  register: munge_version_check
  changed_when: false
  become: true
- name: Test MUNGE authentication
  shell: echo "munge-test" | munge | unmunge
  register: munge_local_test
  changed_when: false
  become: true
  when: not (packer_build | default(false) | bool)
- name: Store MUNGE key for distribution
  slurp:
    src: "{{ munge_key_path }}"
  register: munge_key_content
  become: true
  when: munge_store_key_for_distribution | default(false)
- name: Set MUNGE key fact for distribution
  set_fact:
    slurm_munge_key_content: "{{ munge_key_content.content }}"
  when: munge_store_key_for_distribution | default(false) and munge_key_content is defined
- name: Log MUNGE setup completion
  debug:
    msg: "MUNGE authentication configured successfully"
