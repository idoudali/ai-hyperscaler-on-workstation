# SLURM Controller Package Installation
# Uses pre-built packages from TASK-028.2 (same pattern as BeeGFS)
#
# Installation Flow:
# 1. Check if already installed (skip if binaries exist)
# 2. Check packages on remote host (Packer: /tmp/slurm-packages/)
# 3. Check packages on controller (Runtime: build/packages/slurm/)
# 4. Copy packages if needed (Runtime only)
# 5. Install from local packages
# 6. Fail with clear message if packages not found

# Use package-manager role for SLURM controller package installation
- name: Install SLURM controller packages via package-manager
  ansible.builtin.import_role:
    name: package-manager
  vars:
    package_name: "SLURM Controller"
    package_binary_path: "/usr/sbin/slurmctld"
    package_files: "{{ slurm_controller_required_packages }}"
    package_remote_path: "{{ slurm_packages_path }}"
    package_source_dir: "{{ slurm_packages_source_dir }}"
    package_dependencies: "{{ slurm_controller_dependencies }}"
    component_tag: "slurm-controller"
    verify_command: "/usr/sbin/slurmctld -V"
    use_dpkg_install: true # Better dependency resolution for SLURM
    update_cache: true
  tags:
    - slurm
    - slurm-controller
    - install

- name: Create SLURM system user
  ansible.builtin.user:
    name: slurm
    system: true
    shell: /usr/sbin/nologin
    home: /var/lib/slurm
    createhome: true
    comment: "SLURM Resource Manager"
  tags:
    - slurm
    - slurm-controller
    - install

- name: Verify SLURM controller installation
  ansible.builtin.command: "/usr/sbin/slurmctld -V"
  register: slurmctld_version
  changed_when: false
  failed_when: false
  tags:
    - slurm
    - slurm-controller
    - verify

- name: Display SLURM controller version
  ansible.builtin.debug:
    msg: "SLURM controller installed: {{ slurmctld_version.stdout }}"
  when: slurmctld_version.rc == 0
  tags:
    - slurm
    - slurm-controller
    - verify

- name: Verify slurmdbd installation
  ansible.builtin.command: "/usr/sbin/slurmdbd -V"
  register: slurmdbd_version
  changed_when: false
  failed_when: false
  tags:
    - slurm
    - slurm-controller
    - verify

- name: Display slurmdbd version
  ansible.builtin.debug:
    msg: "slurmdbd installed: {{ slurmdbd_version.stdout }}"
  when: slurmdbd_version.rc == 0
  tags:
    - slurm
    - slurm-controller
    - verify

# Install MPI runtime (OpenMPI) for running MPI programs on controller
- name: Install OpenMPI runtime packages
  apt:
    name:
      - openmpi-bin
      - openmpi-common
    state: present
    update_cache: true
  become: true
  when: not ((packer_build | default(false)) | bool)
  tags:
    - mpi
    - openmpi
    - slurm-controller
    - install

- name: Verify MPI runtime installation
  ansible.builtin.command: mpirun --version
  register: mpirun_version
  changed_when: false
  failed_when: false
  when: not ((packer_build | default(false)) | bool)
  tags:
    - mpi
    - openmpi
    - slurm-controller
    - verify

- name: Display MPI runtime version
  ansible.builtin.debug:
    msg: "MPI runtime installed: {{ mpirun_version.stdout_lines[0] if mpirun_version.rc == 0 else 'Not available' }}"
  when: not ((packer_build | default(false)) | bool)
  tags:
    - mpi
    - openmpi
    - slurm-controller
    - verify

- name: Verify PMIx libraries installation
  ansible.builtin.stat:
    path: "/usr/lib/x86_64-linux-gnu/libpmix.so.2"
  register: pmix_library_check
  when: not ((packer_build | default(false)) | bool)
  tags:
    - slurm
    - slurm-controller
    - verify

- name: Verify MUNGE installation
  ansible.builtin.command: mungekey --version
  register: munge_version_check
  changed_when: false
  failed_when: false
  when: not ((packer_build | default(false)) | bool)
  tags:
    - slurm
    - slurm-controller
    - verify

- name: Display installation results
  ansible.builtin.debug:
    msg: |
      SLURM Controller installation completed:
      - SLURM version: {{ slurm_version }}
      - Installation method: Pre-built packages from {{ slurm_packages_path }}
      - Build mode: {{ 'Packer' if (packer_build | default(false)) | bool else 'Live deployment' }}
      {% if not ((packer_build | default(false)) | bool) %}
      - PMIx library present: {{ pmix_library_check.stat.exists if pmix_library_check is defined else 'Not checked' }}
      - MUNGE available: {{ 'Yes' if munge_version_check is defined and munge_version_check.rc == 0 else 'No' }}
      - MPI runtime available: {{ 'Yes' if mpirun_version is defined and mpirun_version.rc == 0 else 'No' }}
      {% endif %}
  tags:
    - slurm
    - slurm-controller
