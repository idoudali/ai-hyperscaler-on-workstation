---
# BeeGFS Client - Installation Tasks
# Installs from pre-built packages only (no source build)
# Note: Kernel module must be built on the target system
#
# KERNEL COMPATIBILITY: BeeGFS 8.1.0 + Kernel 6.12+
# ==================================================================
# BeeGFS 8.1.0 client kernel module is FULLY COMPATIBLE with Linux kernel 6.12+
# All kernel API compatibility issues from 7.4.4 have been resolved in 8.1.0.
#
# Fixed in BeeGFS 8.1.0:
#   ✅ generic_fillattr() function signature updated for kernel 6.12+
#   ✅ inode_owner_or_capable() function signature updated for kernel 6.12+
#   ✅ SetPageError() function replaced with compatible alternative
#   ✅ asm/unaligned.h header path issues resolved
#
# Requirements:
#   - Kernel headers must match between build and runtime environments
#   - Docker build container and Packer VMs must use same kernel version
#   - DKMS will build kernel module at install time
#
# Kernel Compatibility Matrix:
#   6.1.x LTS  - ✅ Fully Supported
#   6.6.x LTS  - ✅ Fully Supported
#   6.11.x     - ✅ Fully Supported
#   6.12.x+    - ✅ Fully Supported (kernel 6.12 API compatible)
#
# References:
#   - Solution documented in: phase-3-storage-fixes.md (TASK-028.1)
#   - BeeGFS 8.1.0 release notes
#   - Kernel consistency requirement for DKMS builds
# ==================================================================

- name: Check if BeeGFS client DKMS package is installed
  ansible.builtin.stat:
    path: "/usr/src/beegfs-{{ beegfs_version }}"
  register: beegfs_client_dkms_installed
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Check if BeeGFS client is already installed
  ansible.builtin.stat:
    path: /opt/beegfs/sbin/beegfs-ctl
  register: beegfs_client_installed
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Check if packages directory exists on remote host
  ansible.builtin.stat:
    path: "{{ beegfs_packages_path }}"
  register: packages_dir_check
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Check if pre-built packages exist on remote host
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: prebuilt_packages_check
  when:
    - (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists)
    - packages_dir_check.stat.exists
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Check if packages exist on Ansible controller (for runtime deployment)
  ansible.builtin.find:
    paths: "{{ beegfs_packages_source_dir | default('build/packages/beegfs') }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: controller_packages_check
  delegate_to: localhost
  become: false
  when:
    - (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists)
    - (not packages_dir_check.stat.exists) or (prebuilt_packages_check.matched | default(0) == 0)
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Create BeeGFS packages directory on remote host (for runtime deployment)
  ansible.builtin.file:
    path: "{{ beegfs_packages_path }}"
    state: directory
    mode: '0755'
  when:
    - (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists)
    - (not packages_dir_check.stat.exists) or (prebuilt_packages_check.matched | default(0) == 0)
    - controller_packages_check.matched | default(0) > 0
  tags:
    - beegfs
    - beegfs-client
    - copy

- name: Copy pre-built packages from Ansible controller to remote host
  ansible.builtin.copy:
    src: "{{ beegfs_packages_source_dir | default('build/packages/beegfs') }}/"
    dest: "{{ beegfs_packages_path }}/"
    mode: '0644'
  when:
    - (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists)
    - (not packages_dir_check.stat.exists) or (prebuilt_packages_check.matched | default(0) == 0)
    - controller_packages_check.matched | default(0) > 0
  tags:
    - beegfs
    - beegfs-client
    - copy

- name: Re-check if pre-built packages exist after copy
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: prebuilt_packages_check_final
  when:
    - (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists)
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Fail if pre-built packages not found
  ansible.builtin.fail:
    msg: >-
      BeeGFS pre-built packages not found at {{ beegfs_packages_path }}.
      Expected: beegfs-utils_{{ beegfs_version }}_*.deb
      Checked on controller: {{ beegfs_packages_source_dir | default('build/packages/beegfs') }}
      For Packer builds: Packages should be copied by Packer to /tmp/beegfs-packages/
      For runtime: Build packages first with: cmake --build build --target build-beegfs-packages
  when:
    - (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists)
    - prebuilt_packages_check_final.matched | default(0) == 0
  tags:
    - beegfs
    - beegfs-client

- name: Display package installation method
  ansible.builtin.debug:
    msg: "{{ 'BeeGFS client already installed, skipping' if beegfs_client_installed.stat.exists else 'Installing BeeGFS client packages from ' + beegfs_packages_path }}"
  tags:
    - beegfs
    - beegfs-client

# Remove conflicting beegfs-client package (conflicts with beegfs-client-dkms)
- name: Remove conflicting beegfs-client package if installed
  ansible.builtin.apt:
    name: beegfs-client
    state: absent
  when: not beegfs_client_dkms_installed.stat.exists
  tags:
    - beegfs
    - beegfs-client
    - install

# Kernel headers are always needed for client module
- name: Install kernel headers for BeeGFS client module
  ansible.builtin.apt:
    name: "linux-headers-{{ ansible_kernel }}"
    state: present
    update_cache: true
  when: not beegfs_client_installed.stat.exists
  tags:
    - beegfs
    - beegfs-client
    - kernel-headers

- name: Find BeeGFS common package
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: beegfs_common_pkg
  when: not beegfs_client_installed.stat.exists
  tags:
    - beegfs
    - beegfs-client
    - install

- name: Install BeeGFS common package
  ansible.builtin.apt:
    deb: "{{ beegfs_common_pkg.files[0].path }}"
    state: present
  when:
    - (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists)
    - beegfs_common_pkg.matched | default(0) > 0
  tags:
    - beegfs
    - beegfs-client
    - install

- name: Find BeeGFS client packages
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns:
      - "beegfs-client-dkms_{{ beegfs_version }}_*.deb"
      - "beegfs-helperd_{{ beegfs_version }}_*.deb"
      - "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: beegfs_client_pkgs
  when: (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists)
  tags:
    - beegfs
    - beegfs-client
    - install

- name: Ensure kernel headers for running kernel are installed
  ansible.builtin.apt:
    name: "linux-headers-{{ ansible_kernel }}"
    state: present
    update_cache: false
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers

- name: Ensure DKMS and build tools are installed
  ansible.builtin.apt:
    name:
      - dkms
      - build-essential
    state: present
  tags:
    - beegfs
    - beegfs-client
    - install
    - dkms

# DKMS autoinstall enabled - BeeGFS 8.1.0 is fully compatible with kernel 6.12+
# DKMS will automatically build the kernel module during package installation.
# For Packer builds, this adds ~30 seconds to build time but ensures module availability.
- name: Install BeeGFS client packages (with DKMS autoinstall)
  ansible.builtin.apt:
    deb: "{{ item.path }}"
    state: present
  loop: "{{ beegfs_client_pkgs.files }}"
  when:
    - (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists)
    - beegfs_client_pkgs.matched | default(0) > 0
  register: client_install_result
  tags:
    - beegfs
    - beegfs-client
    - install

# TASK-028.1: Verify BeeGFS DKMS module built successfully
# With BeeGFS 8.1.0 + kernel 6.12+, DKMS autoinstall should build the module automatically.
# This section verifies the build succeeded and provides fallback if needed.
#
# Kernel Compatibility:
#   - 6.1.x LTS: ✅ Fully supported
#   - 6.6.x LTS: ✅ Fully supported
#   - 6.12.x+:   ✅ Fully supported (BeeGFS 8.1.0 compatible)
- name: Check if DKMS module was built during installation
  ansible.builtin.command:
    cmd: "dkms status beegfs/{{ beegfs_version }}"
  register: dkms_status_check
  changed_when: false
  failed_when: false
  tags:
    - beegfs
    - beegfs-client
    - dkms
    - kernel-module

- name: Display DKMS autoinstall status
  ansible.builtin.debug:
    msg: |
      DKMS Status: {{ dkms_status_check.stdout if dkms_status_check.rc == 0 else 'Not installed' }}

      {% if 'installed' in dkms_status_check.stdout %}
      ✅ DKMS module built successfully during package installation
      {% else %}
      ⚠️  DKMS autoinstall did not complete - will attempt manual build
      {% endif %}
  tags:
    - beegfs
    - beegfs-client
    - dkms
    - kernel-module

- name: Build DKMS module manually if autoinstall failed
  ansible.builtin.command:
    cmd: "dkms install beegfs/{{ beegfs_version }} -k {{ ansible_kernel }}"
  register: dkms_manual_build
  changed_when: dkms_manual_build.rc == 0
  failed_when: false
  when:
    - dkms_status_check.rc != 0 or 'installed' not in dkms_status_check.stdout
  tags:
    - beegfs
    - beegfs-client
    - dkms
    - kernel-module

- name: Display manual DKMS build result
  ansible.builtin.debug:
    msg: "Manual DKMS build {{ 'succeeded' if dkms_manual_build.rc == 0 else 'failed (rc=' + (dkms_manual_build.rc | string) + ')' }}"
  when:
    - dkms_manual_build is defined
    - dkms_manual_build.changed
  tags:
    - beegfs
    - beegfs-client
    - dkms
    - kernel-module

- name: Display manual DKMS build output on failure
  ansible.builtin.debug:
    msg: "{{ dkms_manual_build.stdout_lines | default([]) + dkms_manual_build.stderr_lines | default([]) }}"
  when:
    - dkms_manual_build is defined
    - dkms_manual_build.changed
    - dkms_manual_build.rc != 0
  tags:
    - beegfs
    - beegfs-client
    - dkms
    - kernel-module

- name: Check if BeeGFS client kernel module exists
  ansible.builtin.find:
    paths: "/lib/modules/{{ ansible_kernel }}"
    patterns: "beegfs.ko"
    recurse: true
  register: beegfs_client_module_check
  tags:
    - beegfs
    - beegfs-client
    - kernel-module

- name: Display kernel module status
  ansible.builtin.debug:
    msg: "BeeGFS client kernel module: {{ 'found' if (beegfs_client_module_check.matched | default(0)) > 0 else 'not found' }}"
  tags:
    - beegfs
    - beegfs-client
    - kernel-module

# TASK-028.1: Enhanced diagnostic message for kernel module availability
- name: Warn if kernel module is not available
  ansible.builtin.debug:
    msg: |
      ⚠️  WARNING: BeeGFS client kernel module NOT AVAILABLE

      Kernel: {{ ansible_kernel }}
      BeeGFS Version: {{ beegfs_version }}

      Possible Causes:
        1. Kernel headers not installed:
           sudo apt-get install linux-headers-{{ ansible_kernel }}

        2. DKMS build dependencies missing:
           sudo apt-get install dkms build-essential

        3. Kernel header version mismatch (Docker build vs VM runtime):
           - Check Docker: linux-headers version
           - Check VM: uname -r should match headers version
           - Reference: phase-3-storage-fixes.md (TASK-028.1)

        4. Manual DKMS build attempt:
           sudo dkms install beegfs/{{ beegfs_version }} -k {{ ansible_kernel }}

      Expected: BeeGFS 8.1.0 is compatible with kernel 6.12+

      Impact:
        ❌ BeeGFS filesystem CANNOT be mounted
        ❌ Client operations unavailable
        ✅ Server services operational (if installed)
  when: (beegfs_client_module_check.matched | default(0)) == 0
  tags:
    - beegfs
    - beegfs-client
    - kernel-module

- name: Success message if kernel module is available
  ansible.builtin.debug:
    msg: |
      ✅ SUCCESS: BeeGFS client kernel module AVAILABLE

      Kernel: {{ ansible_kernel }}
      Module: beegfs.ko found in /lib/modules/{{ ansible_kernel }}

      BeeGFS client is ready to mount filesystems.
  when: (beegfs_client_module_check.matched | default(0)) > 0
  tags:
    - beegfs
    - beegfs-client
    - kernel-module

- name: Create BeeGFS client mount point
  ansible.builtin.file:
    path: "{{ beegfs_client_mount_point }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  ignore_errors: true
  tags:
    - beegfs
    - beegfs-client
    - directories

- name: Create BeeGFS client log directory
  ansible.builtin.file:
    path: "{{ beegfs_client_log_directory }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - beegfs
    - beegfs-client
    - directories

- name: Verify BeeGFS client installation
  ansible.builtin.stat:
    path: /opt/beegfs/sbin/beegfs-client
  register: beegfs_client_binary
  tags:
    - beegfs
    - beegfs-client
    - verify

- name: Display installation status
  ansible.builtin.debug:
    msg: >-
      BeeGFS client installed successfully
      (Binary: {{ 'found' if beegfs_client_binary.stat.exists else 'NOT FOUND' }},
      packer_build={{ packer_build }})
  tags:
    - beegfs
    - beegfs-client
