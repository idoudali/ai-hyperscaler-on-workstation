---
# BeeGFS Client - Installation Tasks
# Installs from pre-built packages only (no source build)
# Note: Kernel module must be built on the target system via DKMS
#
# BeeGFS 8.1.0 is fully compatible with Linux kernel 6.12+
# For troubleshooting and historical analysis, see:
#   docs/troubleshooting/beegfs-client-install-debugging.md

# ========== INITIAL CHECKS ==========
# These tasks register variables used by installation conditions
# They must include 'install' tag to run when installation is filtered

- name: Check if BeeGFS client DKMS package is installed
  ansible.builtin.stat:
    path: "/usr/src/beegfs-{{ beegfs_version }}"
  register: beegfs_client_dkms_installed
  tags:
    - beegfs
    - beegfs-client
    - install
    - check

- name: Check if BeeGFS kernel module exists for current kernel (early check)
  ansible.builtin.find:
    paths: "/lib/modules/{{ ansible_kernel }}"
    patterns: "beegfs.ko*"
    recurse: true
  register: beegfs_kernel_module_early_check
  tags:
    - beegfs
    - beegfs-client
    - install
    - check
    - kernel-module

- name: Check if BeeGFS client is already installed
  ansible.builtin.stat:
    path: /opt/beegfs/sbin/beegfs-ctl
  register: beegfs_client_installed
  tags:
    - beegfs
    - beegfs-client
    - install
    - check

- name: Check if packages directory exists on remote host
  ansible.builtin.stat:
    path: "{{ beegfs_packages_path }}"
  register: packages_dir_check
  tags:
    - beegfs
    - beegfs-client
    - install
    - check

# Define reusable conditional variables for cleaner logic
- name: Determine installation requirements
  ansible.builtin.set_fact:
    needs_installation: "{{ (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists) or ((beegfs_kernel_module_early_check.matched | default(0)) == 0) }}"
    needs_packages: "{{ (not packages_dir_check.stat.exists) or ((prebuilt_packages_check.matched | default(0)) == 0) }}"
  tags:
    - beegfs
    - beegfs-client
    - install

# ========== KERNEL HEADERS AND DEPENDENCIES ==========
# Install kernel headers FIRST - required for DKMS module build

- name: Install kernel headers and build dependencies
  ansible.builtin.apt:
    name:
      - "linux-headers-{{ ansible_kernel }}"
      - dkms
      - build-essential
    state: present
    update_cache: true
  when: needs_installation
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers
    - dkms

# ========== PACKAGE MANAGEMENT ==========
# Check for and copy pre-built packages if needed

- name: Check if pre-built packages exist on remote host
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: prebuilt_packages_check
  when:
    - needs_installation
    - packages_dir_check.stat.exists
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Check if packages exist on Ansible controller (for runtime deployment)
  ansible.builtin.find:
    paths: "{{ beegfs_packages_source_dir | default('build/packages/beegfs') }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: controller_packages_check
  delegate_to: localhost
  become: false
  when:
    - needs_installation
    - needs_packages
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Create BeeGFS packages directory on remote host (for runtime deployment)
  ansible.builtin.file:
    path: "{{ beegfs_packages_path }}"
    state: directory
    mode: '0755'
  when:
    - needs_installation
    - needs_packages
    - (controller_packages_check.matched | default(0)) > 0
  tags:
    - beegfs
    - beegfs-client
    - copy

- name: Copy pre-built packages from Ansible controller to remote host
  ansible.builtin.copy:
    src: "{{ beegfs_packages_source_dir | default('build/packages/beegfs') }}/"
    dest: "{{ beegfs_packages_path }}/"
    mode: '0644'
  when:
    - needs_installation
    - needs_packages
    - (controller_packages_check.matched | default(0)) > 0
  tags:
    - beegfs
    - beegfs-client
    - copy

- name: Re-check if pre-built packages exist after copy
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: prebuilt_packages_check_final
  when: needs_installation
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Fail if pre-built packages not found
  ansible.builtin.fail:
    msg: >-
      BeeGFS pre-built packages not found at {{ beegfs_packages_path }}.
      Expected: beegfs-utils_{{ beegfs_version }}_*.deb
      Checked on controller: {{ beegfs_packages_source_dir | default('build/packages/beegfs') }}
      For Packer builds: Packages should be copied by Packer to /tmp/beegfs-packages/
      For runtime: Build packages first with: cmake --build build --target build-beegfs-packages
  when:
    - needs_installation
    - (prebuilt_packages_check_final.matched | default(0)) == 0
  tags:
    - beegfs
    - beegfs-client

- name: Display package installation method
  ansible.builtin.debug:
    msg: "{{ 'BeeGFS client already installed, skipping' if beegfs_client_installed.stat.exists else 'Installing BeeGFS client packages from ' + beegfs_packages_path }}"
  tags:
    - beegfs
    - beegfs-client

# ========== PACKAGE INSTALLATION ==========

- name: Remove conflicting beegfs-client package if installed
  ansible.builtin.apt:
    name: beegfs-client
    state: absent
  when: needs_installation
  tags:
    - beegfs
    - beegfs-client
    - install

- name: Find all BeeGFS client packages
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns:
      - "beegfs-utils_{{ beegfs_version }}_*.deb"
      - "beegfs-client-dkms_{{ beegfs_version }}_*.deb"
      - "beegfs-helperd_{{ beegfs_version }}_*.deb"
  register: beegfs_all_packages
  when: needs_installation
  tags:
    - beegfs
    - beegfs-client
    - install

- name: Install BeeGFS client packages (with DKMS autoinstall)
  ansible.builtin.apt:
    deb: "{{ item.path }}"
    state: present
  loop: "{{ beegfs_all_packages.files }}"
  when:
    - needs_installation
    - (beegfs_all_packages.matched | default(0)) > 0
  register: client_install_result
  tags:
    - beegfs
    - beegfs-client
    - install

# ========== DKMS MODULE BUILD VERIFICATION ==========
# BeeGFS 8.1.0 is fully compatible with kernel 6.12+
# DKMS autoinstall should build the module automatically during package installation

- name: Check DKMS module status and build if needed
  block:
    - name: Check if DKMS module was built during installation
      ansible.builtin.command:
        cmd: "dkms status beegfs/{{ beegfs_version }}"
      register: dkms_status_check
      changed_when: false
      failed_when: false

    - name: Build DKMS module manually if autoinstall failed
      ansible.builtin.command:
        cmd: "dkms install beegfs/{{ beegfs_version }} -k {{ ansible_kernel }}"
      register: dkms_manual_build
      changed_when: true
      when: dkms_status_check.rc != 0 or 'installed' not in dkms_status_check.stdout

    - name: Verify DKMS module is installed for current kernel
      ansible.builtin.command:
        cmd: "dkms status beegfs/{{ beegfs_version }} -k {{ ansible_kernel }}"
      register: dkms_final_status
      changed_when: false
      failed_when: false

    - name: Display DKMS build status
      ansible.builtin.debug:
        msg: |
          DKMS Status for kernel {{ ansible_kernel }}:
          {{ dkms_final_status.stdout if dkms_final_status.stdout else '(not installed)' }}

          {% if 'installed' in dkms_final_status.stdout %}
          ✅ DKMS module built successfully
          {% else %}
          ⚠️  WARNING: DKMS module NOT installed - BeeGFS cannot mount
          {% endif %}
      when: dkms_final_status is defined

  rescue:
    - name: Display DKMS build failure
      ansible.builtin.debug:
        msg: |
          ❌ DKMS build failed
          Check logs: /var/lib/dkms/beegfs/*/build/make.log
          Manual build: sudo dkms install beegfs/{{ beegfs_version }} -k {{ ansible_kernel }} --verbose
  tags:
    - beegfs
    - beegfs-client
    - dkms
    - kernel-module

# ========== KERNEL MODULE VERIFICATION ==========

- name: Check if BeeGFS client kernel module exists
  ansible.builtin.find:
    paths: "/lib/modules/{{ ansible_kernel }}"
    patterns: "beegfs.ko*"
    recurse: true
  register: beegfs_client_module_check
  tags:
    - beegfs
    - beegfs-client
    - kernel-module

- name: Display kernel module availability
  ansible.builtin.debug:
    msg: |
      {% if ((beegfs_client_module_check.matched | default(0))) > 0 %}
      ✅ SUCCESS: BeeGFS client kernel module AVAILABLE
      Kernel: {{ ansible_kernel }}
      Module: beegfs.ko found in /lib/modules/{{ ansible_kernel }}
      BeeGFS client is ready to mount filesystems.
      {% else %}
      ⚠️  WARNING: BeeGFS client kernel module NOT AVAILABLE

      Kernel: {{ ansible_kernel }}
      BeeGFS Version: {{ beegfs_version }}

      Troubleshooting Steps:
        1. Check kernel headers: dpkg -s linux-headers-{{ ansible_kernel }}
        2. Verify DKMS status: dkms status beegfs/{{ beegfs_version }}
        3. Manual build: sudo dkms install beegfs/{{ beegfs_version }} -k {{ ansible_kernel }}
        4. Check build logs: cat /var/lib/dkms/beegfs/*/build/make.log

      Impact:
        ❌ BeeGFS filesystem CANNOT be mounted
        ❌ Client operations unavailable

      See: docs/troubleshooting/beegfs-client-install-debugging.md
      {% endif %}
  tags:
    - beegfs
    - beegfs-client
    - kernel-module

# ========== DIRECTORY CREATION ==========

- name: Create BeeGFS client mount point
  ansible.builtin.file:
    path: "{{ beegfs_client_mount_point }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  ignore_errors: true
  tags:
    - beegfs
    - beegfs-client
    - directories

- name: Create BeeGFS client log directory
  ansible.builtin.file:
    path: "{{ beegfs_client_log_directory }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - beegfs
    - beegfs-client
    - directories

# ========== INSTALLATION VERIFICATION ==========

- name: Verify BeeGFS client installation
  ansible.builtin.stat:
    path: /opt/beegfs/sbin/beegfs-client
  register: beegfs_client_binary
  tags:
    - beegfs
    - beegfs-client
    - verify

- name: Display installation status
  ansible.builtin.debug:
    msg: >-
      BeeGFS client installed successfully
      (Binary: {{ 'found' if beegfs_client_binary.stat.exists else 'NOT FOUND' }},
      packer_build={{ packer_build }})
  tags:
    - beegfs
    - beegfs-client

# ========== CRITICAL FAILURE CHECK ==========
# Only fail during Packer builds if kernel module is missing
# For runtime deployments, allow installation to continue (may be fixed by reboot)

- name: FAIL if kernel module could not be built (Packer builds only)
  ansible.builtin.fail:
    msg: |
      ❌ CRITICAL BUILD FAILURE: BeeGFS kernel module NOT FOUND

      The beegfs.ko kernel module could not be built by DKMS. This prevents mounting.

      Check the following on the target node:

      1. Kernel headers must match running kernel:
         Running kernel: {{ ansible_kernel }}
         Check: dpkg -s linux-headers-{{ ansible_kernel }}
         Install: sudo apt-get install -y linux-headers-{{ ansible_kernel }}

      2. Verify build tools installed:
         which gcc && which make && which dkms
         sudo apt-get install -y build-essential dkms

      3. Review DKMS build output above for compilation errors

      4. Manual rebuild on the target node:
         sudo dkms install beegfs/{{ beegfs_version }} -k {{ ansible_kernel }} --verbose 2>&1 | tee ~/dkms-build.log

      5. Check detailed DKMS logs:
         cat /var/lib/dkms/beegfs/*/build/make.log | tail -100

      6. Check kernel logs:
         dmesg | tail -30

      See: docs/troubleshooting/beegfs-client-install-debugging.md
  when:
    - (beegfs_kernel_module_early_check.matched | default(0)) == 0
    - packer_build is not defined or not packer_build | bool
  tags:
    - beegfs
    - beegfs-client
    - kernel-module
