# BeeGFS Client - Installation Tasks
# Installs from pre-built packages only (no source build)
# Note: Kernel module must be built on the target system via DKMS
#
# BeeGFS 8.1.0 is fully compatible with Linux kernel 6.12+
# For troubleshooting and historical analysis, see:
#   docs/troubleshooting/beegfs-client-install-debugging.md

# ========== INITIAL CHECKS ==========
# These tasks register variables used by installation conditions
# They must include 'install' tag to run when installation is filtered

- name: Check if BeeGFS client DKMS package is installed
  ansible.builtin.stat:
    path: "/usr/src/beegfs-{{ beegfs_version }}"
  register: beegfs_client_dkms_installed
  tags:
    - beegfs
    - beegfs-client
    - install
    - check

- name: Check if BeeGFS kernel module exists for current kernel (early check)
  ansible.builtin.find:
    paths: "/lib/modules/{{ ansible_kernel }}"
    patterns: "beegfs.ko*"
    recurse: true
  register: beegfs_kernel_module_early_check
  tags:
    - beegfs
    - beegfs-client
    - install
    - check
    - kernel-module

- name: Check if BeeGFS client is already installed
  ansible.builtin.stat:
    path: /opt/beegfs/sbin/beegfs-ctl
  register: beegfs_client_installed
  tags:
    - beegfs
    - beegfs-client
    - install
    - check

- name: Check if packages directory exists on remote host
  ansible.builtin.stat:
    path: "{{ beegfs_packages_path }}"
  register: packages_dir_check
  tags:
    - beegfs
    - beegfs-client
    - install
    - check

# Define reusable conditional variables for cleaner logic
- name: Determine installation requirements
  ansible.builtin.set_fact:
    needs_installation: "{{ (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists) or ((beegfs_kernel_module_early_check.matched | default(0)) == 0) }}"
    needs_packages: "{{ (not packages_dir_check.stat.exists) or ((prebuilt_packages_check.matched | default(0)) == 0) }}"
  tags:
    - beegfs
    - beegfs-client
    - install

# ========== KERNEL HEADERS AND DEPENDENCIES ==========
# Install kernel headers FIRST - required for DKMS module build

- name: Install kernel headers and build dependencies
  ansible.builtin.apt:
    name:
      - "linux-headers-{{ ansible_kernel }}"
      - dkms
      - build-essential
    state: present
    update_cache: true
  when: needs_installation
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers
    - dkms

# ========== PACKAGE MANAGEMENT ==========
# Use common role for package installation logic

- name: Check if pre-built packages exist on remote host (for initial check)
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: prebuilt_packages_check
  when:
    - needs_installation
    - packages_dir_check.stat.exists
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Install BeeGFS client packages via common role
  ansible.builtin.import_role:
    name: beegfs-common
    tasks_from: install-packages
  vars:
    beegfs_service_type: "client"
    beegfs_binary_check_path: "/opt/beegfs/sbin/beegfs-ctl"
    beegfs_required_packages:
      - "beegfs-utils_{{ beegfs_version }}_*.deb"
    beegfs_verify_command: "beegfs-ctl --version"
  tags:
    - beegfs
    - beegfs-client
    - install

# Client-specific: Additional DKMS module handling
- name: Find all BeeGFS client packages for DKMS
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns:
      - "beegfs-client-dkms_{{ beegfs_version }}_*.deb"
      - "beegfs-helperd_{{ beegfs_version }}_*.deb"
  register: beegfs_all_packages
  when: needs_installation
  tags:
    - beegfs
    - beegfs-client
    - install

- name: Install BeeGFS client DKMS packages
  ansible.builtin.apt:
    deb: "{{ item.path }}"
    state: present
  loop: "{{ beegfs_all_packages.files }}"
  when:
    - needs_installation
    - beegfs_all_packages.matched | default(0) > 0
  register: client_install_result
  tags:
    - beegfs
    - beegfs-client
    - install

# ========== DKMS MODULE BUILD VERIFICATION ==========
# BeeGFS 8.1.0 is fully compatible with kernel 6.12+
# DKMS autoinstall should build the module automatically during package installation

- name: Check DKMS module status and build if needed
  block:
    - name: Check if DKMS module was built during installation
      ansible.builtin.command:
        cmd: "dkms status beegfs/{{ beegfs_version }}"
      register: dkms_status_check
      changed_when: false
      failed_when: false

    - name: Build DKMS module manually if autoinstall failed
      ansible.builtin.command:
        cmd: "dkms install beegfs/{{ beegfs_version }} -k {{ ansible_kernel }}"
      register: dkms_manual_build
      changed_when: true
      when: dkms_status_check.rc != 0 or 'installed' not in dkms_status_check.stdout

    - name: Verify DKMS module is installed for current kernel
      ansible.builtin.command:
        cmd: "dkms status beegfs/{{ beegfs_version }} -k {{ ansible_kernel }}"
      register: dkms_final_status
      changed_when: false
      failed_when: false

    - name: Display DKMS build status
      ansible.builtin.debug:
        msg: |
          DKMS Status for kernel {{ ansible_kernel }}:
          {{ dkms_final_status.stdout if dkms_final_status.stdout else '(not installed)' }}
  when: needs_installation
  tags:
    - beegfs
    - beegfs-client
    - install
    - dkms

# ========== FINAL VERIFICATION ==========

- name: Verify BeeGFS kernel module exists
  ansible.builtin.find:
    paths: "/lib/modules/{{ ansible_kernel }}"
    patterns: "beegfs.ko*"
    recurse: true
  register: beegfs_module_final_check
  changed_when: false
  tags:
    - beegfs
    - beegfs-client
    - install
    - verify
    - kernel-module

- name: Verify BeeGFS client installation
  ansible.builtin.command:
    cmd: /opt/beegfs/sbin/beegfs-ctl --version
  register: beegfs_client_version
  changed_when: false
  failed_when: false
  tags:
    - beegfs
    - beegfs-client
    - install
    - verify

- name: Display final installation status
  ansible.builtin.debug:
    msg: |
      BeeGFS client installation complete:
      - Packages: {{ '✓' if beegfs_client_installed.stat.exists else '✗' }}
      - DKMS Source: {{ '✓' if beegfs_client_dkms_installed.stat.exists else '✗' }}
      - Kernel Module: {{ '✓' if beegfs_module_final_check.matched > 0 else '✗' }}
      - Version: {{ beegfs_client_version.stdout_lines[0] if beegfs_client_version.rc == 0 else 'unknown' }}
      - Packer Build: {{ packer_build | default(false) }}
  tags:
    - beegfs
    - beegfs-client
    - install
    - verify
