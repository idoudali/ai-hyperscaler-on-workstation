# BeeGFS Client - Installation Tasks
# Installs from pre-built packages only (no source build)
# Note: Kernel module must be built on the target system via DKMS
#
# BeeGFS 8.1.0 is fully compatible with Linux kernel 6.12+
# For troubleshooting and historical analysis, see:
#   docs/troubleshooting/beegfs-client-install-debugging.md

# ========== INITIAL CHECKS ==========
# These tasks register variables used by installation conditions
# They must include 'install' tag to run when installation is filtered

- name: Check if BeeGFS client DKMS package is installed
  ansible.builtin.stat:
    path: "/usr/src/beegfs-{{ beegfs_version }}"
  register: beegfs_client_dkms_installed
  tags:
    - beegfs
    - beegfs-client
    - install
    - check

- name: Check if BeeGFS kernel module exists for current kernel (early check)
  ansible.builtin.find:
    paths: "/lib/modules/{{ ansible_kernel }}"
    patterns: "beegfs.ko*"
    recurse: true
  register: beegfs_kernel_module_early_check
  tags:
    - beegfs
    - beegfs-client
    - install
    - check
    - kernel-module

- name: Check if BeeGFS client is already installed
  ansible.builtin.stat:
    path: /opt/beegfs/sbin/beegfs-ctl
  register: beegfs_client_installed
  tags:
    - beegfs
    - beegfs-client
    - install
    - check

- name: Check if packages directory exists on remote host
  ansible.builtin.stat:
    path: "{{ beegfs_packages_path }}"
  register: packages_dir_check
  tags:
    - beegfs
    - beegfs-client
    - install
    - check

# Define reusable conditional variables for cleaner logic
- name: Determine installation requirements
  ansible.builtin.set_fact:
    needs_installation: "{{ (not beegfs_client_installed.stat.exists) or (not beegfs_client_dkms_installed.stat.exists) or ((beegfs_kernel_module_early_check.matched | default(0)) == 0) }}"
    needs_packages: "{{ (not packages_dir_check.stat.exists) or ((prebuilt_packages_check.matched | default(0)) == 0) }}"
  tags:
    - beegfs
    - beegfs-client
    - install

# ========== KERNEL HEADERS AND DEPENDENCIES ==========
# Install kernel headers FIRST - required for DKMS module build
# Use robust installation strategy with fallbacks to handle kernel version mismatches

- name: Update apt cache before kernel headers installation
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers

- name: Install build tools and DKMS (always required for kernel module build)
  ansible.builtin.apt:
    name:
      - build-essential
      - dkms
      - gcc
      - make
    state: present
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers
    - dkms

- name: Try to install exact kernel headers for running kernel
  ansible.builtin.apt:
    name: "linux-headers-{{ ansible_kernel }}"
    state: present
  register: kernel_headers_exact
  failed_when: false
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers

- name: Try to install kernel headers without suffix (fallback 1)
  ansible.builtin.apt:
    name: "linux-headers-{{ ansible_kernel.split('+')[0] }}"
    state: present
  register: kernel_headers_no_suffix
  when: kernel_headers_exact is failed
  failed_when: false
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers

- name: Try to install cloud kernel headers (fallback 2)
  ansible.builtin.apt:
    name: "linux-headers-cloud-amd64"
    state: present
  register: kernel_headers_cloud
  when: kernel_headers_exact is failed and (kernel_headers_no_suffix is not defined or kernel_headers_no_suffix is failed)
  failed_when: false
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers

- name: Verify kernel headers were installed successfully
  ansible.builtin.stat:
    path: "/usr/src/linux-headers-{{ ansible_kernel.split('+')[0] }}"
  register: kernel_headers_verify
  failed_when: false
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers

- name: Verify kernel headers installation via package check
  ansible.builtin.shell:
    cmd: |
      dpkg -q -l linux-headers-{{ ansible_kernel.split('+')[0] }} 2>/dev/null \
      || dpkg -q -l linux-headers-cloud-amd64 2>/dev/null \
      || echo "not-installed"
  register: kernel_headers_package_check
  changed_when: false
  failed_when: false
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers

- name: Display kernel headers installation status
  ansible.builtin.debug:
    msg: |
      Kernel Headers Installation Status:
      - Running kernel: {{ ansible_kernel }}
      - Exact headers: {{ '✓' if kernel_headers_exact is succeeded else '✗' }}
      - No suffix headers: {{ '✓' if (kernel_headers_no_suffix is defined and kernel_headers_no_suffix is succeeded) else '✗' }}
      - Cloud headers: {{ '✓' if (kernel_headers_cloud is defined and kernel_headers_cloud is succeeded) else '✗' }}
      - Headers directory exists: {{ '✓' if kernel_headers_verify.stat.exists else '✗' }}
      - Package installed: {{ '✓' if (kernel_headers_package_check.rc == 0 and kernel_headers_package_check.stdout | length > 0) else '✗' }}
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers

- name: Fail if kernel headers could not be installed
  ansible.builtin.fail:
    msg: |
      ❌ CRITICAL: Could not install kernel headers for kernel {{ ansible_kernel }}

      Tried the following package names:
      1. linux-headers-{{ ansible_kernel }} - {{ 'SUCCESS' if kernel_headers_exact is succeeded else 'FAILED' }}
      2. linux-headers-{{ ansible_kernel.split('+')[0] }} - {{ 'SUCCESS' if (kernel_headers_no_suffix is defined and kernel_headers_no_suffix is succeeded) else 'FAILED' if (kernel_headers_no_suffix is defined and kernel_headers_no_suffix is failed) else 'NOT ATTEMPTED' }}
      3. linux-headers-cloud-amd64 - {{ 'SUCCESS' if (kernel_headers_cloud is defined and kernel_headers_cloud is succeeded) else 'FAILED' if (kernel_headers_cloud is defined and kernel_headers_cloud is failed) else 'NOT ATTEMPTED' }}

      Manual fix:
        1. Update apt cache: sudo apt-get update
        2. Check available headers: apt-cache search linux-headers | grep {{ ansible_kernel.split('+')[0] }}
        3. Install manually: sudo apt-get install -y linux-headers-$(uname -r)
        4. Verify: dpkg -l | grep linux-headers

      Without kernel headers, BeeGFS kernel module cannot be built.
  when: >
    kernel_headers_exact is failed and (kernel_headers_no_suffix is not defined or kernel_headers_no_suffix is failed) and (kernel_headers_cloud is not defined or kernel_headers_cloud is failed)
  tags:
    - beegfs
    - beegfs-client
    - install
    - kernel-headers

# ========== PACKAGE MANAGEMENT ==========
# Use common role for package installation logic

- name: Check if pre-built packages exist on remote host (for initial check)
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns: "beegfs-utils_{{ beegfs_version }}_*.deb"
  register: prebuilt_packages_check
  when:
    - needs_installation
    - packages_dir_check.stat.exists
  tags:
    - beegfs
    - beegfs-client
    - check

- name: Install BeeGFS client packages via common role
  ansible.builtin.import_role:
    name: beegfs-common
    tasks_from: install-packages
  vars:
    beegfs_service_type: "client"
    beegfs_binary_check_path: "/opt/beegfs/sbin/beegfs-ctl"
    beegfs_required_packages:
      - "beegfs-utils_{{ beegfs_version }}_*.deb"
    beegfs_verify_command: "beegfs-ctl --version"
  tags:
    - beegfs
    - beegfs-client
    - install

# Client-specific: Additional DKMS module handling
- name: Find all BeeGFS client packages for DKMS
  ansible.builtin.find:
    paths: "{{ beegfs_packages_path }}"
    patterns:
      - "beegfs-client-dkms_{{ beegfs_version }}_*.deb"
      - "beegfs-helperd_{{ beegfs_version }}_*.deb"
  register: beegfs_all_packages
  when: needs_installation
  tags:
    - beegfs
    - beegfs-client
    - install

- name: Install BeeGFS client DKMS packages
  ansible.builtin.apt:
    deb: "{{ item.path }}"
    state: present
  loop: "{{ beegfs_all_packages.files }}"
  when:
    - needs_installation
    - beegfs_all_packages.matched | default(0) > 0
  register: client_install_result
  tags:
    - beegfs
    - beegfs-client
    - install

# ========== DKMS MODULE BUILD VERIFICATION ==========
# BeeGFS 8.1.0 is fully compatible with kernel 6.12+
# DKMS autoinstall should build the module automatically during package installation
# If autoinstall fails, we rebuild manually after ensuring headers are installed

- name: Check DKMS module status and build if needed
  when: beegfs_version is defined
  tags:
    - beegfs
    - beegfs-client
    - dkms
  block:
    - name: Check if DKMS module source is registered
      ansible.builtin.command:
        cmd: "dkms status beegfs/{{ beegfs_version }}"
      register: dkms_status_check
      changed_when: false
      failed_when: false

    - name: Check if kernel module exists for current kernel
      ansible.builtin.find:
        paths: "/lib/modules/{{ ansible_kernel }}"
        patterns: "beegfs.ko*"
        recurse: true
      register: beegfs_module_pre_build_check
      changed_when: false

    - name: Remove existing DKMS module if it exists but module file is missing
      ansible.builtin.shell:
        cmd: "dkms remove beegfs/{{ beegfs_version }} -k {{ ansible_kernel }} --all || true"
      register: dkms_remove
      changed_when: dkms_remove.rc == 0
      failed_when: false
      when: >
        (dkms_status_check.rc == 0 and dkms_status_check.stdout is defined and 'installed' in dkms_status_check.stdout) and (beegfs_module_pre_build_check.matched | default(0)) == 0
    - name: Build DKMS module for current kernel (with force if needed)
      ansible.builtin.command:
        cmd: "dkms install beegfs/{{ beegfs_version }} -k {{ ansible_kernel }} --force"
      register: dkms_manual_build
      changed_when: dkms_manual_build.rc == 0
      failed_when: false
      when: >
        (dkms_status_check.rc != 0 or (dkms_status_check.stdout is defined and 'installed' not in dkms_status_check.stdout) or
         (beegfs_module_pre_build_check.matched | default(0)) == 0)
      tags:
        - beegfs
        - beegfs-client
        - dkms
        - always

    - name: Display DKMS build output on failure
      ansible.builtin.debug:
        msg: |
          DKMS Build Output:
          stdout: {{ dkms_manual_build.stdout_lines | default([]) }}
          stderr: {{ dkms_manual_build.stderr_lines | default([]) }}
      when: >
        dkms_manual_build is defined and dkms_manual_build.rc is defined and dkms_manual_build.rc != 0 and dkms_manual_build.stdout is defined
      tags:
        - beegfs
        - beegfs-client
        - dkms

    - name: Check DKMS build log on failure
      ansible.builtin.shell:
        cmd: "tail -50 /var/lib/dkms/beegfs/{{ beegfs_version }}/build/make.log || echo 'Build log not found'"
      register: dkms_build_log
      changed_when: false
      failed_when: false
      when: >
        dkms_manual_build is defined and dkms_manual_build.rc is defined and dkms_manual_build.rc != 0
      tags:
        - beegfs
        - beegfs-client
        - dkms

    - name: Display DKMS build log on failure
      ansible.builtin.debug:
        msg: "{{ dkms_build_log.stdout_lines | default([]) }}"
      when: >
        dkms_build_log is defined and dkms_build_log.stdout_lines is defined
      tags:
        - beegfs
        - beegfs-client
        - dkms

    - name: Verify DKMS module is installed for current kernel
      ansible.builtin.command:
        cmd: "dkms status beegfs/{{ beegfs_version }} -k {{ ansible_kernel }}"
      register: dkms_final_status
      changed_when: false
      failed_when: false

    - name: Display DKMS build status
      ansible.builtin.debug:
        msg: |
          DKMS Status for kernel {{ ansible_kernel }}:
          {{ dkms_final_status.stdout if dkms_final_status.stdout else '(not installed)' }}
      tags:
        - beegfs
        - beegfs-client
        - dkms

# ========== FINAL VERIFICATION ==========

- name: Verify BeeGFS kernel module exists
  ansible.builtin.find:
    paths: "/lib/modules/{{ ansible_kernel }}"
    patterns: "beegfs.ko*"
    recurse: true
  register: beegfs_module_final_check
  changed_when: false
  tags:
    - beegfs
    - beegfs-client
    - install
    - verify
    - kernel-module

- name: Verify BeeGFS client installation
  ansible.builtin.command:
    cmd: /opt/beegfs/sbin/beegfs-ctl --version
  register: beegfs_client_version
  changed_when: false
  failed_when: false
  tags:
    - beegfs
    - beegfs-client
    - install
    - verify

- name: Display final installation status
  ansible.builtin.debug:
    msg: |
      BeeGFS client installation complete:
      - Packages: {{ '✓' if beegfs_client_installed.stat.exists else '✗' }}
      - DKMS Source: {{ '✓' if beegfs_client_dkms_installed.stat.exists else '✗' }}
      - Kernel Module: {{ '✓' if beegfs_module_final_check.matched > 0 else '✗' }}
      - Version: {{ beegfs_client_version.stdout_lines[0] if beegfs_client_version.rc == 0 else 'unknown' }}
      - Packer Build: {{ packer_build | default(false) }}
  tags:
    - beegfs
    - beegfs-client
    - install
    - verify
