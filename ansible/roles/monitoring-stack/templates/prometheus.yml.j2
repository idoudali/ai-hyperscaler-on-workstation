# Prometheus configuration file
# Generated by Ansible monitoring-stack role

global:
  scrape_interval: {{ prometheus_scrape_interval }}
  evaluation_interval: {{ prometheus_evaluation_interval }}
  external_labels:
    cluster: 'hpc-cluster'
    environment: '{{ ansible_environment | default("development") }}'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - localhost:{{ alertmanager_port }}

# Rule files
rule_files:
  - "rules/*.yml"

# Scrape configurations
scrape_configs:
{% for config in prometheus_scrape_configs %}
  - job_name: '{{ config.job_name }}'
    scrape_interval: {{ config.scrape_interval | default(prometheus_scrape_interval) }}
    static_configs:
{% if config.static_configs is defined %}
{% for static_config in config.static_configs %}
      - targets:
{% if static_config.targets is string %}
          - {{ static_config.targets }}
{% else %}
{% for target in static_config.targets %}
          - {{ target }}
{% endfor %}
{% endif %}
{% if static_config.labels is defined %}
        labels:
{% for label_key, label_value in static_config.labels.items() %}
          {{ label_key }}: {{ label_value }}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}
{% if config.metrics_path is defined %}
    metrics_path: {{ config.metrics_path }}
{% endif %}
{% if config.params is defined %}
    params:
{% for param_key, param_value in config.params.items() %}
      {{ param_key }}:
{% for value in param_value %}
        - {{ value }}
{% endfor %}
{% endfor %}
{% endif %}

{% endfor %}

  # Additional scrape config for SLURM metrics (if slurm-exporter is available)
  - job_name: 'slurm'
    scrape_interval: 30s
    static_configs:
      - targets:
{% for host in groups['hpc_controllers'] | default([]) %}
{% if hostvars[host]['ansible_default_ipv4'] is defined and hostvars[host]['ansible_default_ipv4']['address'] is defined %}
          - {{ hostvars[host]['ansible_default_ipv4']['address'] }}:9341
{% endif %}
{% endfor %}

  # GPU metrics via DCGM exporter (if available)
  - job_name: 'dcgm'
    scrape_interval: 10s
    static_configs:
      - targets:
{% for host in groups['hpc_compute_nodes'] | default([]) %}
{% if hostvars[host]['gpu_devices'] is defined and hostvars[host]['gpu_devices'] | length > 0 and hostvars[host]['ansible_default_ipv4'] is defined and hostvars[host]['ansible_default_ipv4']['address'] is defined %}
          - {{ hostvars[host]['ansible_default_ipv4']['address'] }}:9400
{% endif %}
{% endfor %}
