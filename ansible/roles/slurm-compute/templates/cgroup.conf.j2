# SLURM Cgroup Configuration
# Generated by Ansible for HPC SLURM deployment
# Task 024: Set Up Cgroup Resource Isolation
#
# This file configures cgroup-based resource isolation for CPU, memory, and GPU device access control
# Reference: https://slurm.schedmd.com/cgroup.conf.html

#=============================================================================
# Cgroup Mounting
#=============================================================================

# NOTE: CgroupAutomount is defunct in SLURM 23.x and later - removed
# Cgroups are automatically managed by systemd

# Cgroup mount point (auto-detected by SLURM)
# CgroupMountpoint=/sys/fs/cgroup

#=============================================================================
# Resource Constraints
#=============================================================================

# Constrain job's CPU cores to allocated cores
# When enabled, jobs cannot use cores beyond their allocation
ConstrainCores={{ slurm_cgroup_constrain_cores | default('yes') }}

# Constrain job's RAM usage to allocated memory
# When enabled, jobs cannot exceed their memory allocation
ConstrainRAMSpace={{ slurm_cgroup_constrain_memory | default('yes') }}

# Constrain job's swap usage
# When enabled, jobs cannot use swap space beyond allocation
ConstrainSwapSpace={{ slurm_cgroup_constrain_swap | default('no') }}

# Constrain device access for jobs
# When enabled, jobs can only access allowed devices
ConstrainDevices={{ slurm_cgroup_constrain_devices | default('yes') }}

#=============================================================================
# Device Access Control
#=============================================================================

# Allowed devices file specifies which devices jobs can access
# This is critical for GPU isolation and security
AllowedDevicesFile={{ slurm_cgroup_allowed_devices_file | default('/etc/slurm/cgroup_allowed_devices_file.conf') }}

#=============================================================================
# Task Affinity and Core Binding
#=============================================================================

# NOTE: TaskAffinity is NOT a valid cgroup.conf parameter
# Task affinity is configured in slurm.conf via TaskPlugin=task/affinity
# See slurm.conf: TaskPlugin=task/cgroup,task/affinity

#=============================================================================
# Memory Enforcement
#=============================================================================

# Action to take when job exceeds memory limit
# Options: ignore, kill, oom (out-of-memory killer)
{% if slurm_cgroup_memory_enforce is defined %}
# MemorySwappiness controls the kernel's tendency to swap process memory
MemorySwappiness={{ slurm_cgroup_memory_swappiness | default('0') }}
{% endif %}

#=============================================================================
# Cgroup Performance and Tuning
#=============================================================================

# Minimum RAM per job (in MB)
# Jobs requesting less memory will be allocated this minimum
MinRAMSpace={{ slurm_cgroup_min_ram_mb | default('100') }}

# Maximum RAM enforcement percentage
# Allows job to use up to this percentage of allocated memory before being killed
{% if slurm_cgroup_max_ram_percent is defined %}
MaxRAMPercent={{ slurm_cgroup_max_ram_percent | default('100') }}
{% endif %}

# Maximum swap space enforcement percentage
{% if slurm_cgroup_max_swap_percent is defined %}
MaxSwapPercent={{ slurm_cgroup_max_swap_percent | default('0') }}
{% endif %}

#=============================================================================
# Advanced Cgroup Settings
#=============================================================================

# Cgroup plugin parameters
{% if slurm_cgroup_plugin_params is defined %}
CgroupPlugin={{ slurm_cgroup_plugin_params }}
{% endif %}

# Cgroup mount point (usually auto-detected)
{% if slurm_cgroup_mount_point is defined %}
CgroupMountpoint={{ slurm_cgroup_mount_point }}
{% endif %}

#=============================================================================
# GPU and Device Isolation
#=============================================================================

# When ConstrainDevices=yes, this file specifies allowed devices
# GPU devices (/dev/nvidia*) will be added dynamically based on job allocation
# See cgroup_allowed_devices_file.conf for device specifications

#=============================================================================
# Notes and Best Practices
#=============================================================================
#
# 1. ConstrainCores=yes: Essential for multi-tenant environments to prevent CPU oversubscription
# 2. ConstrainRAMSpace=yes: Prevents memory exhaustion and protects other jobs
# 3. ConstrainDevices=yes: Critical for GPU isolation and security in shared environments
# 4. TaskAffinity=yes: Improves performance through better cache locality
# 5. ConstrainSwapSpace=no: Typically disabled to allow kernel memory management flexibility
#
# GPU Isolation:
# - GPU device access is controlled through AllowedDevicesFile
# - SLURM automatically grants access to allocated GPUs via GRES configuration
# - Jobs without GPU allocation cannot access GPU devices
#
# Memory Management:
# - MemorySwappiness=0: Minimizes swapping for better performance
# - MinRAMSpace: Prevents jobs with unreasonably low memory requests
# - Jobs exceeding memory limits will be killed (OOM behavior)
#
# CPU Affinity:
# - TaskAffinity binds tasks to specific cores for better cache performance
# - Works in conjunction with ConstrainCores for strict core isolation
# - Essential for reproducible performance in HPC workloads
#
