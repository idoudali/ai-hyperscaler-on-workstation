# SLURM Configuration Template with PMIx Integration
# Generated by Ansible for HPC SLURM deployment
# Task 011: Configure SLURM PMIx Integration

#=============================================================================
# SLURM Configuration File
#=============================================================================

# Cluster name
ClusterName={{ slurm_cluster_name | default('hpc-cluster') }}

# Control machine
ControlMachine={{ slurm_controller_name | default('controller') }}
ControlAddr={{ slurm_controller_addr | default('127.0.0.1') }}

#=============================================================================
# MPI Integration (PMIx Compliant)
#=============================================================================

# Default MPI implementation
MpiDefault={{ slurm_mpi_default | default('pmix') }}

# MPI parameters - Port range for MPI communication
MpiParams={{ slurm_mpi_params | default('ports=' + pmix_ports) }}

# MPI timeout (deprecated parameter removed)
# MpiTimeout={{ slurm_mpi_timeout | default('300') }}

#=============================================================================
# Resource Management and Scheduling
#=============================================================================

# Select plugin for resource selection
SelectType={{ select_type | default('select/cons_tres') }}

# Select plugin parameters
SelectTypeParameters={{ slurm_select_type_params | default('CR_Core_Memory') }}

# GRES (Generic Resource) types
GresTypes={{ gres_types | default('gpu') }}

# Scheduler type
SchedulerType={{ slurm_scheduler_type | default('sched/backfill') }}

# Scheduler parameters
SchedulerParameters={{ slurm_scheduler_params | default('bf_interval=5,bf_max_job_test=1000,bf_window=3600') }}

#=============================================================================
# Process Tracking and Task Management
#=============================================================================

# Process tracking plugin
ProctrackType={{ slurm_proctrack_type | default('proctrack/cgroup') }}

# Task plugin for task management
TaskPlugin={{ slurm_task_plugin | default('task/cgroup,task/affinity') }}

# Task plugin parameters (Sched parameter is invalid)
# TaskPluginParam={{ slurm_task_plugin_param | default('Sched') }}

#=============================================================================
# Job Accounting and Database
#=============================================================================

# Accounting storage type (none by default, set to accounting_storage/slurmdbd if using database)
AccountingStorageType={{ slurm_accounting_storage_type | default('accounting_storage/none') }}

{% if slurm_accounting_storage_type is defined and slurm_accounting_storage_type == 'accounting_storage/slurmdbd' %}
# Accounting storage host
AccountingStorageHost={{ slurm_accounting_storage_host | default('localhost') }}

# Accounting storage port
AccountingStoragePort={{ slurm_accounting_storage_port | default('6819') }}

# Accounting storage user
AccountingStorageUser={{ slurm_accounting_storage_user | default('slurm') }}
{% endif %}

# Job accounting gather type
JobAcctGatherType={{ slurm_job_acct_gather_type | default('jobacct_gather/linux') }}

# Job accounting gather parameters
JobAcctGatherParams={{ slurm_job_acct_gather_params | default('UsePss,NoOverMemoryKill') }}

# Job accounting gather frequency
JobAcctGatherFrequency={{ slurm_job_acct_gather_frequency | default('30') }}

#=============================================================================
# Authentication and Security
#=============================================================================

# Authentication type
AuthType={{ slurm_auth_type | default('auth/munge') }}

# Crypto type for secure communication
CryptoType={{ slurm_crypto_type | default('crypto/munge') }}

#=============================================================================
# Communication and Networking
#=============================================================================

# SLURM daemon port
SlurmctldPort={{ slurm_controller_port | default('6817') }}

# SLURM compute daemon port
SlurmdPort={{ slurm_compute_port | default('6818') }}

# State save location
StateSaveLocation={{ slurm_state_save_location | default('/var/lib/slurm') }}

# Slurm spool directory
SlurmdSpoolDir={{ slurm_spool_dir | default('/var/spool/slurmd') }}

# Slurm log file
SlurmctldLogFile={{ slurm_log_file | default('/var/log/slurm/slurmctld.log') }}

# Slurm compute daemon log file
SlurmdLogFile={{ slurm_compute_log_file | default('/var/log/slurm/slurmd.log') }}

# SLURM user ID
SlurmUser={{ slurm_user | default('slurm') }}

#=============================================================================
# Job Limits and Defaults
#=============================================================================

# Maximum job count per user
MaxJobCount={{ slurm_max_job_count | default('10000') }}

# Maximum array size
MaxArraySize={{ slurm_max_array_size | default('1000000') }}

# Maximum step count
MaxStepCount={{ slurm_max_step_count | default('40000') }}

# Minimum job time
MinJobAge={{ slurm_min_job_age | default('300') }}

# Maximum job time (parameter removed - use partition MaxTime instead)
# MaxJobTime={{ slurm_max_job_time | default('UNLIMITED') }}

#=============================================================================
# Partition Configuration
#=============================================================================

# Default partition
PartitionName={{ slurm_default_partition | default('compute') }} \
    Nodes={% for host in (groups['hpc_compute_nodes'] | default([])) + (groups['hpc_gpu_nodes'] | default([])) %}{{ hostvars[host]['slurm_node_name'] | default(host) }}{{ ',' if not loop.last else '' }}{% endfor %} \
    Default={{ slurm_default_partition_default | default('YES') }} \
    MaxTime={{ slurm_partition_max_time | default('INFINITE') }} \
    State={{ slurm_partition_state | default('UP') }}

# GPU partition (if GPUs are available)
{% if gres_types is defined and 'gpu' in gres_types %}
PartitionName={{ slurm_gpu_partition | default('gpu') }} \
    Nodes={% for host in (groups['hpc_compute_nodes'] | default([])) + (groups['hpc_gpu_nodes'] | default([])) %}{{ hostvars[host]['slurm_node_name'] | default(host) }}{{ ',' if not loop.last else '' }}{% endfor %} \
    Default={{ slurm_gpu_partition_default | default('NO') }} \
    MaxTime={{ slurm_gpu_partition_max_time | default('INFINITE') }} \
    State={{ slurm_gpu_partition_state | default('UP') }} \
    AllowGroups={{ slurm_gpu_allow_groups | default('ALL') }}
{% endif %}

#=============================================================================
# Node Configuration
#=============================================================================

# Compute nodes - dynamically generated from inventory
{% for host in (groups['hpc_compute_nodes'] | default([])) + (groups['hpc_gpu_nodes'] | default([])) %}
NodeName={{ hostvars[host].slurm_node_name | default(host) }} \
    NodeAddr={{ hostvars[host].ansible_host | default(host) }} \
    Sockets={{ hostvars[host].slurm_node_sockets | default('1') }} \
    CoresPerSocket={{ hostvars[host].slurm_node_cores_per_socket | default('8') }} \
    ThreadsPerCore={{ hostvars[host].slurm_node_threads_per_core | default('1') }} \
    State={{ hostvars[host].slurm_node_state | default('UNKNOWN') }}
{% endfor %}

# Controller node configuration
{% set controller_host = groups['hpc_controllers'][0] | default('localhost') %}
NodeName={{ hostvars[controller_host].slurm_node_name | default('controller') }} \
    NodeAddr={{ hostvars[controller_host].ansible_host | default('127.0.0.1') }} \
    Sockets={{ hostvars[controller_host].slurm_controller_sockets | default('1') }} \
    CoresPerSocket={{ hostvars[controller_host].slurm_controller_cores_per_socket | default('4') }} \
    ThreadsPerCore={{ hostvars[controller_host].slurm_controller_threads_per_core | default('2') }} \
    State={{ hostvars[controller_host].slurm_controller_state | default('UNKNOWN') }}

#=============================================================================
# Advanced Configuration
#=============================================================================

# Message timeout
MessageTimeout={{ slurm_message_timeout | default('10') }}

# TCP timeout
TCPTimeout={{ slurm_tcp_timeout | default('2') }}

# Tree width
TreeWidth={{ slurm_tree_width | default('50') }}

# Unkillable step timeout
UnkillableStepTimeout={{ slurm_unkillable_step_timeout | default('60') }}

# VSize factor
VSizeFactor={{ slurm_vsize_factor | default('0') }}

# Wait time
WaitTime={{ slurm_wait_time | default('0') }}

#=============================================================================
# Container Integration (if enabled)
#=============================================================================

{% if slurm_container_integration | default(false) %}
# Container plugin configuration
ConstrainDevices={{ slurm_constrain_devices | default('yes') }}
ConstrainRAMSpace={{ slurm_constrain_ram_space | default('yes') }}
ConstrainSwapSpace={{ slurm_constrain_swap_space | default('no') }}
ConstrainCores={{ slurm_constrain_cores | default('yes') }}
{% endif %}

#=============================================================================
# PMIx Specific Configuration
#=============================================================================

{% if pmix_enabled | default(true) %}
# PMIx server parameters (deprecated parameters removed)
# PmixServerAddr={{ slurm_pmix_server_addr | default('localhost') }}
# PmixServerPort={{ slurm_pmix_server_port | default('15000') }}

# PMIx client parameters (deprecated parameters removed)
# PmixClientAddr={{ slurm_pmix_client_addr | default('localhost') }}
# PmixClientPort={{ slurm_pmix_client_port | default('15001') }}

# PMIx timeout settings (deprecated parameter removed)
# PmixTimeout={{ slurm_pmix_timeout | default('300') }}

# PMIx debug level (deprecated parameter removed)
# PmixDebug={{ slurm_pmix_debug | default('0') }}
{% endif %}

#=============================================================================
# Logging and Debugging
#=============================================================================

# Debug flags
DebugFlags={{ slurm_debug_flags | default('Backfill,BackfillMap,Priority') }}

# Log file format (deprecated parameter removed)
# LogFileFormat={{ slurm_log_file_format | default('2') }}

# Job completion callback (deprecated parameter removed)
# JobCheckpointDir={{ slurm_job_checkpoint_dir | default('/var/checkpoint') }}

#=============================================================================
# Power Management (if enabled)
#=============================================================================

{% if slurm_power_management | default(false) %}
# Power management plugin
PowerPlugin={{ slurm_power_plugin | default('power/none') }}
PowerParameters={{ slurm_power_parameters | default('') }}
{% endif %}
