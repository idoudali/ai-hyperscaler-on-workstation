# SLURM Compute Role - Main Tasks
# Task 022: SLURM Compute Node Installation and Configuration
# This file orchestrates the installation and configuration of SLURM compute nodes

# Install packages and create SLURM user first
- name: Include SLURM compute node package installation
  include_tasks: install.yml
  tags:
    - slurm-compute
    - slurm-compute-install
    - install

# Setup common SLURM directories after user creation
- name: Setup SLURM directories using common role
  ansible.builtin.import_role:
    name: slurm-common
    tasks_from: setup-directories
  vars:
    slurm_setup_directories: true
  tags:
    - slurm-compute
    - directories

# Validate and configure NodeName BEFORE configuring slurm.conf
- name: Validate and configure NodeName
  include_tasks: validate-nodename.yml
  vars:
    slurm_node_name: "{{ hostvars[inventory_hostname].slurm_node_name | default(inventory_hostname) }}"
  tags:
    - slurm-compute
    - slurm-compute-validate
    - validate

- name: Include SLURM compute node configuration
  include_tasks: configure.yml
  tags:
    - slurm-compute
    - slurm-compute-configure
    - configure

- name: Include SLURM GRES configuration
  include_tasks: gres.yml
  when: slurm_gres_enabled | default(false) | bool
  tags:
    - slurm-compute
    - slurm-gres
    - gres

- name: Include cgroup resource isolation configuration
  include_tasks: cgroup.yml
  when: slurm_cgroup_enabled | default(true) | bool
  tags:
    - slurm-compute
    - slurm-cgroup
    - cgroup

- name: Include SLURM job scripts configuration
  include_tasks: job-scripts.yml
  tags:
    - slurm-compute
    - slurm-job-scripts
    - job-scripts

- name: Display SLURM compute node setup complete
  debug:
    msg: |
      SLURM Compute Node setup complete:
      - Node name: {{ slurm_compute_node_name | default(inventory_hostname) }}
      - Packages installed: {{ slurm_compute_packages }}
      - Service configured: slurmd
      - Container runtime enabled: {{ slurm_container_enabled | default(true) }}
      - Cgroup enabled: {{ slurm_cgroup_enabled | default(true) }}

      {% if (packer_build | default(false)) | bool %}
      Build Mode: Packer image creation
      - Services enabled but not started
      - Node registration will occur at runtime
      {% else %}
      Runtime Mode: Live deployment
      - Services started and enabled
      - Node registered with controller
      - Ready to accept jobs
      {% endif %}
  tags:
    - slurm-compute
