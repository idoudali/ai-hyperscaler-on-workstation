---
# SLURM Compute Package Installation
# Uses pre-built packages from TASK-028.2 (same pattern as BeeGFS)
#
# Installation Flow:
# 1. Check if already installed (skip if binaries exist)
# 2. Check packages on remote host (Packer: /tmp/slurm-packages/)
# 3. Check packages on controller (Runtime: build/packages/slurm/)
# 4. Copy packages if needed (Runtime only)
# 5. Install from local packages
# 6. Fail with clear message if packages not found

- name: Verify SLURM packages are available
  ansible.builtin.find:
    paths: "{{ slurm_packages_path }}"
    patterns: "slurm-smd_{{ slurm_version }}-1_*.deb"
  register: available_packages
  tags:
    - slurm
    - slurm-compute
    - check

- name: Fail if SLURM packages not found
  ansible.builtin.fail:
    msg: >-
      SLURM packages not found at {{ slurm_packages_path }}.
      Expected: slurm-smd_{{ slurm_version }}-1_*.deb
      Packages should be copied by the playbook before this role runs.
  when: available_packages.matched == 0
  tags:
    - slurm
    - slurm-compute
    - check

- name: Display SLURM package installation
  ansible.builtin.debug:
    msg: "Installing SLURM compute from {{ available_packages.matched }} packages at {{ slurm_packages_path }}"
  tags:
    - slurm
    - slurm-compute

- name: Install SLURM compute dependencies
  ansible.builtin.apt:
    name: "{{ slurm_compute_dependencies }}"
    state: present
    update_cache: true
  tags:
    - slurm
    - slurm-compute
    - install

- name: Find SLURM compute package files
  ansible.builtin.find:
    paths: "{{ slurm_packages_path }}"
    patterns: "{{ slurm_compute_required_packages }}"
  register: slurm_compute_pkgs
  tags:
    - slurm
    - slurm-compute
    - install

- name: Install SLURM compute packages (all at once for dependency resolution)
  ansible.builtin.command:
    cmd: "dpkg -i {{ slurm_compute_pkgs.files | map(attribute='path') | join(' ') }}"
  register: dpkg_install_result
  changed_when: dpkg_install_result.rc == 0
  failed_when: false
  when: slurm_compute_pkgs.matched | default(0) > 0
  tags:
    - slurm
    - slurm-compute
    - install

- name: Fix SLURM package dependencies if needed
  ansible.builtin.command:
    cmd: "apt-get install -f -y"
  register: apt_fix_result
  changed_when: apt_fix_result.rc == 0
  when: slurm_compute_pkgs.matched | default(0) > 0
  tags:
    - slurm
    - slurm-compute
    - install

- name: Create SLURM system user
  ansible.builtin.user:
    name: slurm
    system: true
    shell: /usr/sbin/nologin
    home: /var/lib/slurm
    createhome: true
    comment: "SLURM Resource Manager"
  tags:
    - slurm
    - slurm-compute
    - install

- name: Verify SLURM compute installation
  ansible.builtin.command: "/usr/sbin/slurmd -V"
  register: slurmd_version
  changed_when: false
  failed_when: false
  tags:
    - slurm
    - slurm-compute
    - verify

- name: Display SLURM compute version
  ansible.builtin.debug:
    msg: "SLURM compute installed: {{ slurmd_version.stdout }}"
  when: slurmd_version.rc == 0
  tags:
    - slurm
    - slurm-compute
    - verify

- name: Verify PMIx libraries installation
  ansible.builtin.stat:
    path: "/usr/lib/x86_64-linux-gnu/libpmix.so.2"
  register: pmix_library_check
  when: not ((packer_build | default(false)) | bool)
  tags:
    - slurm
    - slurm-compute
    - verify

- name: Verify MUNGE installation
  ansible.builtin.command: mungekey --version
  register: munge_version_check
  changed_when: false
  failed_when: false
  when: not ((packer_build | default(false)) | bool)
  tags:
    - slurm
    - slurm-compute
    - verify

- name: Display installation results
  ansible.builtin.debug:
    msg: |
      SLURM Compute Node installation completed:
      - SLURM version: {{ slurm_version }}
      - Installation method: Pre-built packages from {{ slurm_packages_path }}
      - Build mode: {{ 'Packer' if (packer_build | default(false)) | bool else 'Live deployment' }}
      {% if not ((packer_build | default(false)) | bool) %}
      - PMIx library present: {{ pmix_library_check.stat.exists if pmix_library_check is defined else 'Not checked' }}
      - MUNGE available: {{ 'Yes' if munge_version_check is defined and munge_version_check.rc == 0 else 'No' }}
      {% endif %}
  tags:
    - slurm
    - slurm-compute
