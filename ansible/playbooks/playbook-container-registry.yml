# Container Registry Infrastructure Deployment Playbook
# Deploys container registry infrastructure on HPC cluster (live VMs only)
#
# CRITICAL: This playbook MUST NOT run during Packer builds
# Set packer_build=false (or omit it) when running this playbook
#
# Usage:
#   ansible-playbook playbooks/playbook-container-registry.yml
#   ansible-playbook playbooks/playbook-container-registry.yml --check  # Dry run
#   ansible-playbook playbooks/playbook-container-registry.yml --tags registry-setup
#
# Prerequisites:
#   - HPC cluster deployed with controller and compute nodes
#   - SLURM installed and configured
#   - Apptainer/Singularity installed on all nodes

- name: Deploy Container Registry Infrastructure on HPC Cluster
  hosts: controller,compute
  become: true
  gather_facts: true

  vars:
    # Explicitly set packer_build to false for live VM deployment
    packer_build: false

    # Optional: Override default registry settings
    # container_registry_base_path: "/opt/containers"
    # container_registry_group: "slurm"
    # container_registry_sync_enabled: true

  pre_tasks:
    - name: Verify not running in Packer build mode
      assert:
        that:
          - not (packer_build | default(false))
        fail_msg: |
          ERROR: This playbook is for live VM deployment only.
          It should NOT run during Packer builds.
          If you're running this during a Packer build, you're doing it wrong.
        success_msg: "Running in live VM deployment mode (packer_build=false) ✓"
      tags: always

    - name: Check if BeeGFS is mounted
      stat:
        path: "{{ container_registry_beegfs_path | default('/mnt/beegfs') }}"
      register: beegfs_mount_check
      changed_when: false
      tags: always

    - name: Set BeeGFS mount status
      set_fact:
        beegfs_mounted: "{{ beegfs_mount_check.stat.exists and beegfs_mount_check.stat.isdir }}"
      tags: always

    - name: Determine container registry storage backend
      set_fact:
        container_registry_storage_backend: >-
          {{ 'BeeGFS' if (container_registry_on_beegfs | default(true) and beegfs_mounted)
             else 'Local Storage' }}
        container_registry_actual_path: >-
          {{ container_registry_beegfs_path if (container_registry_on_beegfs | default(true) and beegfs_mounted)
             else container_registry_local_path }}
      tags: always

    - name: Display deployment information
      debug:
        msg:
          - "Deploying container registry infrastructure"
          - "Target hosts: {{ ansible_play_hosts | join(', ') }}"
          - "Storage backend: {{ container_registry_storage_backend }}"
          - "Registry path: {{ container_registry_actual_path }}"
          - "BeeGFS mounted: {{ beegfs_mounted }}"
          - "Packer build mode: {{ packer_build | default(false) }}"
      tags: always

    - name: Ensure Apptainer/Singularity is installed
      package:
        name: "{{ container_runtime | default('apptainer') }}"
        state: present
      failed_when: false
      tags:
        - prerequisites
        - packages

    - name: Verify container runtime is available
      command: "which {{ container_runtime | default('apptainer') }}"
      register: container_runtime_check
      changed_when: false
      failed_when: container_runtime_check.rc != 0
      tags:
        - prerequisites
        - verify

  roles:
    - role: container-registry
      tags:
        - container-registry

  post_tasks:
    - name: Verify registry infrastructure deployed
      stat:
        path: "{{ container_registry_actual_path }}"
      register: registry_deployed
      failed_when: not registry_deployed.stat.exists
      tags:
        - verify

    - name: Display registry information
      debug:
        msg:
          - "Container registry infrastructure deployed successfully ✓"
          - "Storage backend: {{ container_registry_storage_backend }}"
          - "Registry path: {{ container_registry_actual_path }}"
          - "Owner: {{ container_registry_owner | default('root') }}"
          - "Group: {{ container_registry_group | default('slurm') }}"
          - ""
          - "Next steps:"
          - "1. Deploy container images using: hpc-container-manager deploy <image.sif>"
          - "2. Run tests: tests/test-container-registry-framework.sh --phase infrastructure"
          - "3. Verify: tests/suites/container-registry/run-ansible-infrastructure-tests.sh"
          - ""
          - "Storage benefits:"
          - "{{ '• Automatic distribution across all nodes via BeeGFS' if (container_registry_storage_backend == 'BeeGFS') else '• Manual sync required between nodes' }}"
          - "{{ '• No sync script needed' if (container_registry_storage_backend == 'BeeGFS') else '• Use registry-sync-to-nodes.sh for distribution' }}"
      tags:
        - always

# Deployment verification play
- name: Verify Container Registry Deployment
  hosts: controller
  become: true
  gather_facts: false

  tasks:
    - name: Check registry structure on controller
      stat:
        path: "{{ item }}"
      register: registry_structure_stat
      loop:
        - "{{ container_registry_actual_path }}"
        - "{{ container_registry_actual_path }}/ml-frameworks"
        - "{{ container_registry_actual_path }}/custom-images"
        - "{{ container_registry_actual_path }}/base-images"
        - "{{ container_registry_actual_path }}/.registry"
      failed_when: not registry_structure_stat.stat.exists
      tags:
        - verify

    - name: Test registry sync script availability
      stat:
        path: /usr/local/bin/registry-sync-to-nodes.sh
      register: sync_script
      failed_when: not sync_script.stat.exists or not sync_script.stat.executable
      tags:
        - verify

    - name: Display deployment summary
      debug:
        msg:
          - "═══════════════════════════════════════════════════════════"
          - "  Container Registry Infrastructure Deployment Complete"
          - "═══════════════════════════════════════════════════════════"
          - ""
          - "Registry Status: READY"
          - "Storage Backend: {{ container_registry_storage_backend }}"
          - "Base Path: {{ container_registry_actual_path }}"
          - "Sync Script: {{ '/usr/local/bin/registry-sync-to-nodes.sh' if (container_registry_storage_backend == 'Local Storage') else 'Not needed (BeeGFS auto-distribution)' }}"
          - ""
          - "Subdirectories:"
          - "  • ml-frameworks/  - Production ML frameworks"
          - "  • custom-images/  - User custom containers"
          - "  • base-images/    - Base/template images"
          - "  • .registry/      - Registry metadata"
          - ""
          - "Deploy containers with:"
          - "  hpc-container-manager deploy <image.sif> \\"
          - "    --cluster-config config/example-multi-gpu-clusters.yaml \\"
          - "    --registry-path {{ container_registry_actual_path }}/ml-frameworks/ \\"
          - "    {{ '--sync-nodes' if (container_registry_storage_backend == 'Local Storage') else '--no-sync' }} --verify"
          - ""
          - "Storage Benefits:"
          - "{{ '  • Automatic distribution across all nodes via BeeGFS' if (container_registry_storage_backend == 'BeeGFS') else '  • Manual sync required between nodes' }}"
          - "{{ '  • No sync script needed' if (container_registry_storage_backend == 'BeeGFS') else '  • Use registry-sync-to-nodes.sh for distribution' }}"
          - ""
          - "═══════════════════════════════════════════════════════════"
      tags:
        - always
