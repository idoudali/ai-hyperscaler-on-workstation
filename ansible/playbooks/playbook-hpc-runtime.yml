---
# HPC Runtime Configuration Playbook
# Unified runtime configuration for complete HPC cluster deployment
# Consolidates 6 specialized runtime playbooks into one maintainable file
#
# Usage:
#   ansible-playbook -i inventories/production playbooks/playbook-hpc-runtime.yml
#
# IMPORTANT: This playbook is for RUNTIME deployment only (packer_build=false)

# Pre-validation
- name: HPC Runtime Configuration - Pre-validation
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Verify runtime deployment mode
      assert:
        that:
          - not ((packer_build | default(false)) | bool)
        fail_msg: |
          ERROR: This playbook is for RUNTIME deployment only!
          It must be run with packer_build=false on live VMs.
          Do NOT run this during Packer image builds.
        success_msg: "Runtime deployment mode confirmed"

    - name: Display runtime configuration plan
      debug:
        msg: |
          ====================================================================
          HPC Runtime Configuration
          ====================================================================

          This playbook will configure:
          - Controllers: {{ groups['hpc_controllers'] | default([]) | join(', ') }}
          - Compute Nodes: {{ groups['compute_nodes'] | default([]) | join(', ') }}

          Configuration includes:
          - SLURM controller and compute services
          - Cgroup resource isolation
          - GPU GRES configuration (if GPUs present)
          - Job scripts deployment
          - Monitoring stack (Prometheus, Grafana, DCGM)
          - Container runtime validation
          - VirtIO-FS host directory sharing (if configured)
          - BeeGFS parallel filesystem (if enabled)

          ====================================================================

# Configure hostnames and /etc/hosts for all nodes
- name: Configure Cluster Hostnames and DNS
  hosts: hpc_controllers,compute_nodes
  become: true
  gather_facts: true
  tasks:
    - name: Build /etc/hosts entries for all cluster nodes
      set_fact:
        cluster_hosts_entries: "{{ cluster_hosts_entries | default([]) + [{'ip': hostvars[item].ansible_host, 'hostname': hostvars[item].slurm_node_name | default(item)}] }}"
      loop: "{{ groups['hpc_controllers'] + groups['compute_nodes'] }}"
      run_once: true
      tags:
        - hostname
        - dns

    - name: Add all cluster nodes to /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: "^{{ item.ip }}\\s"
        line: "{{ item.ip }}\t{{ item.hostname }}"
        state: present
      loop: "{{ hostvars[groups['hpc_controllers'][0]].cluster_hosts_entries }}"
      tags:
        - hostname
        - dns

# Copy SLURM packages to all nodes
- name: Distribute SLURM Packages to All Nodes
  hosts: hpc_controllers,compute_nodes
  become: true
  gather_facts: false
  vars:
    slurm_version: "24.11.0"
    slurm_packages_source_dir: "{{ playbook_dir }}/../../build/packages/slurm"
    slurm_packages_dest_dir: "/tmp/slurm-packages"
  tasks:
    - name: Create SLURM packages directory on remote nodes
      ansible.builtin.file:
        path: "{{ slurm_packages_dest_dir }}"
        state: directory
        mode: '0755'
      tags:
        - slurm
        - packages

    - name: Copy SLURM packages from Ansible controller to nodes
      ansible.builtin.copy:
        src: "{{ slurm_packages_source_dir }}/"
        dest: "{{ slurm_packages_dest_dir }}/"
        mode: '0644'
      tags:
        - slurm
        - packages

    - name: Verify SLURM packages were copied
      ansible.builtin.find:
        paths: "{{ slurm_packages_dest_dir }}"
        patterns: "slurm-smd_{{ slurm_version }}-1_*.deb"
      register: copied_packages
      tags:
        - slurm
        - packages

    - name: Display copied packages count
      ansible.builtin.debug:
        msg: "Copied {{ copied_packages.matched }} SLURM packages to {{ inventory_hostname }}"
      tags:
        - slurm
        - packages

    - name: Fail if no packages were copied
      ansible.builtin.fail:
        msg: "Failed to copy SLURM packages. Expected packages at {{ slurm_packages_source_dir }}"
      when: copied_packages.matched == 0
      tags:
        - slurm
        - packages

# Controller configuration
- name: Configure HPC Controllers
  hosts: hpc_controllers
  become: true
  gather_facts: true
  vars:
    packer_build: false

  pre_tasks:
    - name: Set controller hostname
      hostname:
        name: "{{ slurm_node_name | default('controller') }}"
      tags:
        - hostname
        - setup

    - name: Update /etc/hosts with controller hostname
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1\t{{ slurm_node_name | default('controller') }}"
        state: present
      tags:
        - hostname
        - setup

    - name: Restart MUNGE after hostname change
      systemd:
        name: munge
        state: restarted
      when: not (packer_build | default(false) | bool)
      failed_when: false
      tags:
        - hostname
        - setup

    - name: Display controller configuration
      debug:
        msg: "Configuring HPC controller: {{ inventory_hostname }} -> {{ slurm_node_name | default('controller') }}"

  tasks:
    # Parse VirtIO-FS mounts from JSON string (if provided as string)
    - name: Parse VirtIO-FS mounts configuration
      set_fact:
        virtio_fs_mounts_parsed: "{{ virtio_fs_mounts | from_json if virtio_fs_mounts is string else virtio_fs_mounts }}"
      when: virtio_fs_mounts is defined
      tags:
        - virtio-fs
        - storage
        - mounts

    # Configure VirtIO-FS mounts on controller (if configured)
    - name: Configure VirtIO-FS Host Mounts on Controller
      import_role:
        name: virtio-fs-mount
      when:
        - virtio_fs_mounts_parsed is defined
        - virtio_fs_mounts_parsed | length > 0
      vars:
        packer_build: false
        virtio_fs_perform_mounts: true
        virtio_fs_mounts: "{{ virtio_fs_mounts_parsed }}"
      tags:
        - virtio-fs
        - storage
        - mounts

    - name: Display VirtIO-FS configuration status
      debug:
        msg: |
          VirtIO-FS Configuration:
          - Mounts configured: {{ virtio_fs_mounts_parsed | length if virtio_fs_mounts_parsed is defined else 0 }}
          - Mount points: {{ virtio_fs_mounts_parsed | map(attribute='mount_point') | list if virtio_fs_mounts_parsed is defined else [] }}
      when: virtio_fs_mounts_parsed is defined
      tags:
        - virtio-fs
        - storage

    - name: Configure SLURM controller services
      import_role:
        name: slurm-controller
      tags:
        - slurm
        - controller

    - name: Start and configure monitoring stack
      import_role:
        name: monitoring-stack
        tasks_from: prometheus
      when: install_monitoring_stack | default(true)
      tags:
        - monitoring

  post_tasks:
    - name: Verify SLURM controller services
      systemd:
        name: "{{ item }}"
        state: started
      register: controller_services
      loop:
        - slurmctld
        - slurmdbd
      failed_when: false

    - name: Display controller status
      debug:
        msg: |
          Controller {{ inventory_hostname }} configured:
          - slurmctld: {{ 'Running' if (controller_services.results[0].state is defined and controller_services.results[0].state == 'started') else 'Check logs' }}
          - slurmdbd: {{ 'Running' if (controller_services.results[1].state is defined and controller_services.results[1].state == 'started') else 'Check logs' }}

# Distribute MUNGE key from controller to compute nodes
- name: Distribute MUNGE Key to Compute Nodes
  hosts: hpc_controllers
  become: true
  gather_facts: false
  tasks:
    - name: Fetch MUNGE key from controller
      fetch:
        src: /etc/munge/munge.key
        dest: /tmp/munge.key
        flat: true
      run_once: true
      tags:
        - munge
        - auth

- name: Copy MUNGE Key to Compute Nodes
  hosts: compute_nodes
  become: true
  gather_facts: false
  tasks:
    - name: Ensure MUNGE directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: munge
        group: munge
        mode: '0755'
      loop:
        - /etc/munge
        - /var/lib/munge
        - /var/log/munge
        - /var/run/munge
      tags:
        - munge
        - auth

    - name: Copy MUNGE key from controller
      copy:
        src: /tmp/munge.key
        dest: /etc/munge/munge.key
        owner: munge
        group: munge
        mode: '0400'
      notify: restart munge
      tags:
        - munge
        - auth

    - name: Start and enable MUNGE service
      systemd:
        name: munge
        state: started
        enabled: true
      tags:
        - munge
        - auth

  handlers:
    - name: restart munge
      systemd:
        name: munge
        state: restarted

# Compute node configuration
- name: Configure HPC Compute Nodes
  hosts: compute_nodes
  become: true
  gather_facts: true
  vars:
    packer_build: false

  pre_tasks:
    - name: Set compute node hostname from inventory
      hostname:
        name: "{{ slurm_node_name | default(inventory_hostname) }}"
      tags:
        - hostname
        - setup

    - name: Update /etc/hosts with compute node hostname
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1\t{{ slurm_node_name | default(inventory_hostname) }}"
        state: present
      tags:
        - hostname
        - setup

    - name: Restart MUNGE after hostname change
      systemd:
        name: munge
        state: restarted
      when: not (packer_build | default(false) | bool)
      failed_when: false
      tags:
        - hostname
        - setup

    - name: Display compute node configuration
      debug:
        msg: |
          Configuring compute node: {{ inventory_hostname }} -> {{ slurm_node_name | default(inventory_hostname) }}
          - Cgroup enabled: {{ slurm_cgroup_enabled | default(true) }}
          - GPU enabled: {{ gpu_enabled | default(false) }}
          - Container runtime: {{ slurm_container_enabled | default(true) }}

  tasks:
    - name: Configure SLURM compute services
      import_role:
        name: slurm-compute
      tags:
        - slurm
        - compute

    - name: Configure cgroup isolation
      import_role:
        name: slurm-compute
        tasks_from: cgroup
      when: slurm_cgroup_enabled | default(true)
      tags:
        - cgroup

    - name: Configure GPU GRES
      import_role:
        name: slurm-compute
        tasks_from: gres
      when: gpu_enabled | default(false)
      tags:
        - gres
        - gpu

    - name: Deploy job scripts
      import_role:
        name: slurm-compute
        tasks_from: job-scripts
      tags:
        - job-scripts

    - name: Configure DCGM monitoring
      import_role:
        name: monitoring-stack
        tasks_from: dcgm
      when: gpu_enabled | default(false)
      tags:
        - dcgm
        - monitoring
        - gpu

  post_tasks:
    - name: Verify slurmd service
      systemd:
        name: slurmd
        state: started
      register: slurmd_service
      failed_when: false

    - name: Check node registration with controller
      shell: |
        timeout 30 bash -c 'until scontrol show node {{ inventory_hostname }} 2>/dev/null | \
          grep -q "State="; do sleep 2; done'
      register: node_registration
      changed_when: false
      failed_when: false

    - name: Display compute node status
      debug:
        msg: |
          Compute node {{ inventory_hostname }} configured:
          - slurmd: {{ 'Running' if (slurmd_service.state is defined and slurmd_service.state == 'started') else 'Check logs' }}
          - Registration: {{ 'SUCCESS' if (node_registration.rc is defined and node_registration.rc == 0) else 'FAILED - Check MUNGE/network' }}
          - Cgroup: {{ 'Configured' if slurm_cgroup_enabled | default(true) else 'Disabled' }}
          - GPU GRES: {{ 'Configured' if gpu_enabled | default(false) else 'Disabled' }}

    - name: Display troubleshooting information on failure
      debug:
        msg: |
          Node registration failed. Troubleshooting steps:
          1. Check MUNGE service: systemctl status munge
          2. Verify MUNGE key matches controller
          3. Check network connectivity to controller
          4. Review slurmd logs: journalctl -u slurmd -n 50
          5. Verify slurm.conf has correct controller hostname
          6. Check firewall rules allowing SLURM traffic
      when: node_registration.rc != 0

# BeeGFS Parallel Filesystem Deployment (if enabled)
#
# Available BeeGFS Tags for Granular Control:
#
# DEPLOYMENT TAGS:
#   beegfs-mgmt      - Deploy BeeGFS management service only
#   beegfs-meta      - Deploy BeeGFS metadata service only
#   beegfs-storage   - Deploy BeeGFS storage services only
#   beegfs-client    - Deploy BeeGFS client on all nodes only
#   beegfs-deploy    - Deploy all BeeGFS services (mgmt, meta, storage, client)
#   beegfs-setup     - Run BeeGFS setup scripts only (before service start)
#
# VERIFICATION TAGS:
#   beegfs-verify    - Run all BeeGFS verification tasks
#   beegfs-status    - Check BeeGFS cluster status and nodes
#   beegfs-mounts    - Verify BeeGFS mounts on all nodes
#   beegfs-cross-node - Test cross-node file sharing
#   beegfs-pre-client - Verify services before client deployment
#
# DEBUGGING TAGS:
#   beegfs-debug     - Show logs, configs, and detailed status
#
# GENERAL TAGS:
#   beegfs          - All BeeGFS related tasks
#   storage         - All storage related tasks (includes BeeGFS)
#   verification    - All verification tasks (includes BeeGFS)
#
# USAGE EXAMPLES:
#   # Deploy only BeeGFS management service:
#   ansible-playbook playbook-hpc-runtime.yml --tags beegfs-mgmt
#
#   # Deploy all BeeGFS services:
#   ansible-playbook playbook-hpc-runtime.yml --tags beegfs-deploy
#
#   # Run only BeeGFS verification:
#   ansible-playbook playbook-hpc-runtime.yml --tags beegfs-verify
#
#   # Debug BeeGFS management service:
#   ansible-playbook playbook-hpc-runtime.yml --tags beegfs-mgmt,beegfs-debug
#
#   # Deploy BeeGFS and run verification:
#   ansible-playbook playbook-hpc-runtime.yml --tags beegfs-deploy,beegfs-verify
#
#   # Run only BeeGFS setup scripts:
#   ansible-playbook playbook-hpc-runtime.yml --tags beegfs-setup
- name: Deploy BeeGFS Management Service
  hosts: hpc_controllers
  become: true
  gather_facts: true
  vars:
    packer_build: false
    install_only: false
  tags:
    - beegfs
    - beegfs-mgmt
    - beegfs-deploy
    - storage
  tasks:
    - name: Parse BeeGFS configuration
      set_fact:
        beegfs_config_parsed: "{{ beegfs_config | from_json if beegfs_config is string else beegfs_config }}"
      when:
        - beegfs_enabled | default(false) | bool
        - beegfs_config is defined
      tags:
        - beegfs
        - storage

    - name: Display BeeGFS deployment plan
      debug:
        msg: |
          BeeGFS Configuration:
          - Enabled: {{ beegfs_enabled | default(false) }}
          - Mount Point: {{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}
          - Management Node: {{ beegfs_config_parsed.management_node | default('controller') }}
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage

    - name: Deploy BeeGFS management service
      import_role:
        name: beegfs-mgmt
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - storage

    - name: Wait for BeeGFS management service to be fully initialized
      ansible.builtin.pause:
        seconds: 30
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - storage

    - name: Check BeeGFS management service status
      ansible.builtin.systemd:
        name: beegfs-mgmtd
      register: beegfs_mgmt_service_status
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - storage

    - name: Display BeeGFS management service status
      debug:
        msg: "BeeGFS management service status: {{ beegfs_mgmt_service_status.status.ActiveState }}"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - storage

    - name: Check BeeGFS management service logs
      ansible.builtin.command: journalctl -u beegfs-mgmtd --no-pager -n 20
      register: beegfs_mgmt_logs
      changed_when: false
      failed_when: false
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - beegfs-debug
        - storage

    - name: Display BeeGFS management service logs
      debug:
        msg: |
          BeeGFS management service logs:
          {{ beegfs_mgmt_logs.stdout_lines | join('\n') }}
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - storage

    - name: Check BeeGFS management service configuration
      ansible.builtin.command: cat /etc/beegfs/beegfs-mgmtd.conf
      register: beegfs_mgmt_config
      changed_when: false
      failed_when: false
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - beegfs-debug
        - storage

    - name: Display BeeGFS management service configuration
      debug:
        msg: |
          BeeGFS management service configuration:
          {{ beegfs_mgmt_config.stdout_lines | join('\n') }}
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - storage

    - name: Try to verify BeeGFS management service is responding
      ansible.builtin.command: beegfs-ctl --listnodes --nodetype=mgmt
      register: beegfs_mgmt_verify
      changed_when: false
      failed_when: false
      retries: 3
      delay: 15
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - storage

    - name: Display BeeGFS management verification output
      debug:
        msg: |
          BeeGFS management verification:
          - Return code: {{ beegfs_mgmt_verify.rc }}
          - Stdout: {{ beegfs_mgmt_verify.stdout }}
          - Stderr: {{ beegfs_mgmt_verify.stderr }}
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - storage

    - name: Check if BeeGFS management service is at least running
      ansible.builtin.assert:
        that:
          - beegfs_mgmt_service_status.status.ActiveState == "active"
        fail_msg: "BeeGFS management service is not running"
        success_msg: "BeeGFS management service is running (verification may need more time)"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - storage

    - name: Display BeeGFS management service status (non-fatal)
      debug:
        msg: |
          BeeGFS management service status:
          - Service state: {{ beegfs_mgmt_service_status.status.ActiveState }}
          - Verification return code: {{ beegfs_mgmt_verify.rc | default('N/A') }}
          - Note: Service may need more time to fully initialize
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-mgmt
        - storage

    - name: Display management service status
      debug:
        msg: "BeeGFS management service deployed and ready on {{ inventory_hostname }}"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage

- name: Deploy BeeGFS Metadata Service
  hosts: hpc_controllers
  become: true
  gather_facts: true
  vars:
    packer_build: false
    install_only: false
  tags:
    - beegfs
    - beegfs-meta
    - beegfs-deploy
    - storage
  tasks:
    - name: Deploy BeeGFS metadata service
      import_role:
        name: beegfs-meta
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-meta
        - storage

    - name: Wait for BeeGFS metadata service to be fully initialized
      ansible.builtin.pause:
        seconds: 20
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-meta
        - storage

    - name: Check BeeGFS metadata service status
      ansible.builtin.systemd:
        name: beegfs-meta
      register: beegfs_meta_service_status
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-meta
        - storage

    - name: Display BeeGFS metadata service status
      debug:
        msg: "BeeGFS metadata service status: {{ beegfs_meta_service_status.status.ActiveState }}"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-meta
        - storage

    - name: Check if BeeGFS metadata service is at least running
      ansible.builtin.assert:
        that:
          - beegfs_meta_service_status.status.ActiveState == "active"
        fail_msg: "BeeGFS metadata service is not running"
        success_msg: "BeeGFS metadata service is running (verification may need more time)"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-meta
        - storage

    - name: Display BeeGFS metadata service status (non-fatal)
      debug:
        msg: |
          BeeGFS metadata service status:
          - Service state: {{ beegfs_meta_service_status.status.ActiveState }}
          - Note: Service may need more time to fully initialize
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-meta
        - storage

    - name: Display metadata service status
      debug:
        msg: "BeeGFS metadata service deployed and ready on {{ inventory_hostname }}"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage

- name: Deploy BeeGFS Storage Services
  hosts: compute_nodes
  become: true
  gather_facts: true
  vars:
    packer_build: false
    install_only: false
  tags:
    - beegfs
    - beegfs-storage
    - beegfs-deploy
    - storage
  tasks:
    - name: Deploy BeeGFS storage service
      import_role:
        name: beegfs-storage
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-storage
        - storage

    - name: Wait for BeeGFS storage service to be fully initialized
      ansible.builtin.pause:
        seconds: 15
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-storage
        - storage

    - name: Check BeeGFS storage service status
      ansible.builtin.systemd:
        name: beegfs-storage
      register: beegfs_storage_service_status
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-storage
        - storage

    - name: Display BeeGFS storage service status
      debug:
        msg: "BeeGFS storage service status on {{ inventory_hostname }}: {{ beegfs_storage_service_status.status.ActiveState }}"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-storage
        - storage

    - name: Check if BeeGFS storage service is at least running
      ansible.builtin.assert:
        that:
          - beegfs_storage_service_status.status.ActiveState == "active"
        fail_msg: "BeeGFS storage service is not running on {{ inventory_hostname }}"
        success_msg: "BeeGFS storage service is running on {{ inventory_hostname }} (verification may need more time)"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-storage
        - storage

    - name: Display BeeGFS storage service status (non-fatal)
      debug:
        msg: |
          BeeGFS storage service status on {{ inventory_hostname }}:
          - Service state: {{ beegfs_storage_service_status.status.ActiveState }}
          - Note: Service may need more time to fully initialize
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-storage
        - storage

    - name: Display storage service status
      debug:
        msg: "BeeGFS storage service deployed and ready on {{ inventory_hostname }}"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage

- name: Verify All BeeGFS Services Are Ready Before Client Deployment
  hosts: hpc_controllers
  become: true
  gather_facts: false
  tags:
    - beegfs
    - beegfs-verify
    - beegfs-pre-client
    - storage
    - verification
  tasks:
    - name: Wait for BeeGFS management service to be fully ready
      ansible.builtin.pause:
        seconds: 10
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Check for storage target registrations in management logs
      ansible.builtin.shell: |
        journalctl -u beegfs-mgmtd --since "10 minutes ago" | grep -E "Registered new storage target|Mapped storage targets" | wc -l
      register: storage_registration_count
      changed_when: false
      failed_when: false
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Wait for storage targets to register if not yet registered
      ansible.builtin.pause:
        seconds: 20
      when:
        - beegfs_enabled | default(false) | bool
        - (storage_registration_count.stdout | int) < 2
      tags:
        - beegfs
        - storage
        - verification

    - name: Check again for storage target registrations
      ansible.builtin.shell: |
        journalctl -u beegfs-mgmtd --since "15 minutes ago" | grep -E "Registered new storage target|Mapped storage targets" | wc -l
      register: storage_registration_check
      changed_when: false
      failed_when: false
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Display storage registration status
      debug:
        msg: |
          BeeGFS storage targets registration status:
          - Storage registration events found: {{ storage_registration_check.stdout }}
          - {{ 'Storage targets registered and ready' if (storage_registration_check.stdout | int) >= 2 else 'Warning: Expected storage registrations not found, but proceeding' }}
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Verify storage services are running on compute nodes
      ansible.builtin.systemd:
        name: beegfs-storage
      register: compute_storage_service_status
      delegate_to: "{{ item }}"
      loop: "{{ groups['compute_nodes'] | default([]) }}"
      changed_when: false
      failed_when: false
      when:
        - beegfs_enabled | default(false) | bool
        - groups['compute_nodes'] is defined and groups['compute_nodes'] | length > 0
      tags:
        - beegfs
        - storage
        - verification

    - name: Display storage service status
      debug:
        msg: |
          BeeGFS Storage Service Status on Compute Nodes:
          {% for result in compute_storage_service_status.results | default([]) %}
          - {{ result.item }}: {{ result.status.ActiveState | default('unknown') }}
          {% endfor %}
      when:
        - beegfs_enabled | default(false) | bool
        - compute_storage_service_status.results is defined
      tags:
        - beegfs
        - storage
        - verification

    - name: Final wait before client deployment
      ansible.builtin.pause:
        seconds: 5
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

- name: Deploy BeeGFS Client on All Nodes
  hosts: hpc_controllers,compute_nodes
  become: true
  gather_facts: true
  vars:
    packer_build: false
    install_only: false
  tags:
    - beegfs
    - beegfs-client
    - beegfs-deploy
    - storage
  tasks:
    - name: Deploy BeeGFS client
      import_role:
        name: beegfs-client
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - beegfs-client
        - storage

    - name: Display client deployment status
      debug:
        msg: "BeeGFS client configured and mounted on {{ inventory_hostname }}"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage

- name: Verify BeeGFS Cluster Status
  hosts: hpc_controllers
  become: true
  gather_facts: false
  tags:
    - beegfs
    - beegfs-verify
    - beegfs-status
    - storage
    - verification
  tasks:
    - name: Check BeeGFS cluster status
      command: beegfs-ctl --listnodes --nodetype=all
      register: beegfs_status
      changed_when: false
      failed_when: false
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Display BeeGFS cluster nodes
      debug:
        msg: "{{ beegfs_status.stdout_lines }}"
      when:
        - beegfs_enabled | default(false) | bool
        - beegfs_status.rc == 0
      tags:
        - beegfs
        - storage
        - verification

    - name: Check BeeGFS storage targets
      command: beegfs-ctl --listtargets --nodetype=storage --state
      register: beegfs_storage_targets
      changed_when: false
      failed_when: false
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Display BeeGFS storage targets
      debug:
        msg: "{{ beegfs_storage_targets.stdout_lines }}"
      when:
        - beegfs_enabled | default(false) | bool
        - beegfs_storage_targets.rc == 0
      tags:
        - beegfs
        - storage
        - verification

    - name: Test BeeGFS filesystem write
      copy:
        content: "BeeGFS deployment test - {{ ansible_date_time.iso8601 }}\n"
        dest: "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}/beegfs-test.txt"
        owner: root
        group: root
        mode: '0644'
      when:
        - beegfs_enabled | default(false) | bool
        - beegfs_status.rc == 0
      tags:
        - beegfs
        - storage
        - verification

    - name: Display BeeGFS deployment status
      debug:
        msg: "BeeGFS cluster deployed with {{ beegfs_status.stdout_lines | length }} nodes"
      when:
        - beegfs_enabled | default(false) | bool
        - beegfs_status.rc == 0
      tags:
        - beegfs
        - storage

- name: Verify BeeGFS Mounts on All Nodes
  hosts: hpc_controllers,compute_nodes
  become: true
  gather_facts: false
  tags:
    - beegfs
    - beegfs-verify
    - beegfs-mounts
    - storage
    - verification
  tasks:
    - name: Check if BeeGFS mount point exists
      stat:
        path: "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}"
      register: beegfs_mount_point_stat
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Verify BeeGFS mount point is a directory
      assert:
        that:
          - beegfs_mount_point_stat.stat.exists
          - beegfs_mount_point_stat.stat.isdir
        fail_msg: "BeeGFS mount point {{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }} does not exist or is not a directory"
        success_msg: "BeeGFS mount point {{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }} exists and is a directory"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Check if BeeGFS is mounted
      command: mount | grep -E "beegfs.*{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}"
      register: beegfs_mount_check
      changed_when: false
      failed_when: false
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Verify BeeGFS is mounted
      assert:
        that:
          - beegfs_mount_check.rc == 0
        fail_msg: "BeeGFS is not mounted at {{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }} on {{ inventory_hostname }} - service may still be initializing"
        success_msg: "BeeGFS is mounted at {{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }} on {{ inventory_hostname }}"
      ignore_errors: true
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Check BeeGFS client service status
      systemd:
        name: beegfs-client
      register: beegfs_client_service
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Verify BeeGFS client service is active
      assert:
        that:
          - beegfs_client_service.status.ActiveState == "active"
        fail_msg: "BeeGFS client service is not active on {{ inventory_hostname }} - may still be initializing"
        success_msg: "BeeGFS client service is active on {{ inventory_hostname }}"
      ignore_errors: true
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Test BeeGFS write access
      copy:
        content: "BeeGFS mount test from {{ inventory_hostname }} - {{ ansible_date_time.iso8601 }}\n"
        dest: "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}/mount-test-{{ inventory_hostname }}.txt"
        owner: root
        group: root
        mode: '0644'
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Test BeeGFS read access
      slurp:
        src: "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}/mount-test-{{ inventory_hostname }}.txt"
      register: beegfs_read_test
      failed_when: false
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Verify BeeGFS read access
      assert:
        that:
          - beegfs_read_test.content is defined
          - beegfs_read_test.content | b64decode | string | regex_search(inventory_hostname) is not none
        fail_msg: "BeeGFS read test failed on {{ inventory_hostname }} - mount may not be ready yet"
        success_msg: "BeeGFS read/write test successful on {{ inventory_hostname }}"
      when:
        - beegfs_enabled | default(false) | bool
        - beegfs_read_test.content is defined

    - name: Check BeeGFS filesystem usage
      command: df -h "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}"
      register: beegfs_df
      changed_when: false
      failed_when: false
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Display BeeGFS filesystem usage
      debug:
        msg: "BeeGFS filesystem usage on {{ inventory_hostname }}: {{ beegfs_df.stdout_lines[1] if beegfs_df.rc == 0 else 'Unable to get usage info' }}"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

- name: Verify BeeGFS Cross-Node File Sharing
  hosts: hpc_controllers
  become: true
  gather_facts: false
  tags:
    - beegfs
    - beegfs-verify
    - beegfs-cross-node
    - storage
    - verification
  tasks:
    - name: Create cross-node test file on controller
      copy:
        content: "Cross-node test file created on controller - {{ ansible_date_time.iso8601 }}\n"
        dest: "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}/cross-node-test.txt"
        owner: root
        group: root
        mode: '0644'
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Verify cross-node test file exists
      stat:
        path: "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}/cross-node-test.txt"
      register: cross_node_file_stat
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Assert cross-node test file exists
      assert:
        that:
          - cross_node_file_stat.stat.exists
        fail_msg: "Cross-node test file not found on controller"
        success_msg: "Cross-node test file created successfully on controller"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

    - name: Test file access from compute nodes
      delegate_to: "{{ item }}"
      stat:
        path: "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}/cross-node-test.txt"
      register: compute_node_file_check
      when:
        - beegfs_enabled | default(false) | bool
        - groups['compute_nodes'] is defined
      loop: "{{ groups['compute_nodes'] }}"
      tags:
        - beegfs
        - storage
        - verification

    - name: Assert compute nodes can access controller file
      assert:
        that:
          - item.stat.exists
        fail_msg: "Compute node {{ item.item }} cannot access controller-created file"
        success_msg: "Compute node {{ item.item }} can access controller-created file"
      when:
        - beegfs_enabled | default(false) | bool
        - groups['compute_nodes'] is defined
      loop: "{{ compute_node_file_check.results | default([]) }}"
      tags:
        - beegfs
        - storage
        - verification

    - name: Create test file from compute node
      delegate_to: "{{ groups['compute_nodes'][0] }}"
      copy:
        content: "Test file created from compute node - {{ ansible_date_time.iso8601 }}\n"
        dest: "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}/compute-to-controller-test.txt"
        owner: root
        group: root
        mode: '0644'
      when:
        - beegfs_enabled | default(false) | bool
        - groups['compute_nodes'] is defined
        - groups['compute_nodes'] | length > 0
      tags:
        - beegfs
        - storage
        - verification

    - name: Verify controller can access compute-created file
      stat:
        path: "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}/compute-to-controller-test.txt"
      register: controller_file_check
      when:
        - beegfs_enabled | default(false) | bool
        - groups['compute_nodes'] is defined
        - groups['compute_nodes'] | length > 0
      tags:
        - beegfs
        - storage
        - verification

    - name: Assert controller can access compute file
      assert:
        that:
          - controller_file_check.stat.exists
        fail_msg: "Controller cannot access compute-created file"
        success_msg: "Controller can access compute-created file - cross-node sharing verified"
      when:
        - beegfs_enabled | default(false) | bool
        - groups['compute_nodes'] is defined
        - groups['compute_nodes'] | length > 0
      tags:
        - beegfs
        - storage
        - verification

    - name: Clean up test files
      file:
        path: "{{ beegfs_config_parsed.mount_point | default('/mnt/beegfs') }}/{{ item }}"
        state: absent
      loop:
        - "cross-node-test.txt"
        - "compute-to-controller-test.txt"
      when: beegfs_enabled | default(false) | bool
      tags:
        - beegfs
        - storage
        - verification

# Post-validation
- name: HPC Runtime Configuration - Post-validation
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display configuration completion
      debug:
        msg: |
          ====================================================================
          HPC Runtime Configuration Complete
          ====================================================================

          Cluster configured successfully!

          Next steps:
          1. Verify cluster status: sinfo
          2. Check node states: scontrol show nodes
          3. Test job submission: srun -N1 hostname
          4. Run comprehensive tests: make test-hpc-runtime
          5. Test VirtIO-FS mounts: ls -la /mnt/host-* (if configured)

          Monitoring:
          - Prometheus: http://controller:9090
          - Grafana: http://controller:3000
          - Node metrics: http://nodes:9100/metrics

          Storage:
          - VirtIO-FS mounts: {{ virtio_fs_mounts | length if virtio_fs_mounts is defined else 0 }} configured
          - BeeGFS: {{ 'Enabled' if beegfs_enabled | default(false) else 'Disabled' }}

          For troubleshooting:
          - Controller logs: journalctl -u slurmctld -f
          - Compute logs: journalctl -u slurmd -f
          - Database logs: journalctl -u slurmdbd -f

          ====================================================================
