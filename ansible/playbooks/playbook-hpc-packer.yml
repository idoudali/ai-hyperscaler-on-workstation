---
# HPC Base Image Packer Playbook
# This playbook is used by Packer to install essential HPC packages during image build

- name: Install HPC Base Packages
  hosts: all
  become: true
  become_method: sudo
  become_user: root
  gather_facts: false
  any_errors_fatal: false

  module_defaults:
    apt:
      update_cache: yes
      cache_valid_time: 3600

  vars:
    # Packer-specific variables
    ansible_connection: ssh
    ansible_python_interpreter: /usr/bin/python3
    # Fallback values for when fact gathering fails
    ansible_facts:
      pkg_mgr: "apt"
      os_family: "Debian"
      distribution: "Debian"
      distribution_version: "13"

  pre_tasks:
    - name: "Test basic connectivity"
      ping:
      tags: always

    - name: "Starting HPC Base Image provisioning"
      debug:
        msg: "Starting HPC Base Image provisioning with Ansible on {{ inventory_hostname }}"
      tags: always

    - name: "Skip fact gathering - using predefined facts"
      debug:
        msg: "Using predefined facts for Debian 13 (trixie) build environment"
      tags: always

  roles:
    - role: hpc-base-packages
      tags: ["hpc", "packages", "nvidia"]

  tasks:
    - name: "Running post-installation verification"
      debug:
        msg: "Verifying installed packages and drivers"
      tags: always

    - name: "Test NVIDIA driver installation"
      command: nvidia-smi
      register: nvidia_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: "NVIDIA driver status"
      debug:
        msg: "NVIDIA drivers: {{ 'Available' if nvidia_check.rc == 0 else 'Not available' }}"

    - name: "Test CUDA toolkit installation"
      command: nvcc --version
      register: cuda_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: "CUDA toolkit status"
      debug:
        msg: "CUDA toolkit: {{ 'Available' if cuda_check.rc == 0 else 'Not available' }}"

    - name: "Test essential system packages"
      command: which git && which wget && which curl && which vim && which htop
      register: essential_check
      changed_when: false
      failed_when: false

    - name: "Essential packages status"
      debug:
        msg: "Essential packages: {{ 'All verified' if essential_check.rc == 0 else 'Some missing' }}"

    - name: "HPC Base Image build completed"
      debug:
        msg: |
          === HPC BASE IMAGE BUILD COMPLETE ===
          Essential packages: {{ 'VERIFIED' if essential_check.rc == 0 else 'ISSUES DETECTED' }}
          NVIDIA drivers: {{ 'AVAILABLE' if nvidia_check.rc == 0 else 'NOT AVAILABLE' }}
          CUDA toolkit: {{ 'AVAILABLE' if cuda_check.rc == 0 else 'NOT AVAILABLE' }}
      tags: always
