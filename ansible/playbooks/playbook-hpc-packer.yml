---
# HPC Base Image Packer Playbook
# This playbook is used by Packer to install essential HPC packages during image build

- name: Install HPC Base Packages
  hosts: all
  become: true
  become_method: sudo
  become_user: root
  gather_facts: false

  module_defaults:
    setup:
      gather_subset: minimal
      gather_timeout: 10

  vars:
    # Packer-specific variables
    ansible_connection: ssh
    ansible_python_interpreter: /usr/bin/python3
    # Fallback values for when fact gathering fails
    ansible_facts:
      pkg_mgr: "apt"
      os_family: "Debian"
      distribution: "Debian"
      distribution_version: "13"

  pre_tasks:
    - name: Gather facts manually with error handling
      setup:
        gather_subset: minimal
      register: fact_result
      failed_when: false
      ignore_errors: true

    - name: Set facts based on result
      set_fact:
        ansible_facts: "{{ fact_result.ansible_facts | default(ansible_facts) }}"
      when: fact_result.ansible_facts is defined

  roles:
    - role: hpc-base-packages
      tags: ["hpc", "packages", "nvidia"]

  tasks:
    - name: Verify NVIDIA driver installation
      command: nvidia-smi
      register: nvidia_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Display NVIDIA driver status
      debug:
        msg: "NVIDIA driver check result: {{ nvidia_check.stdout_lines }}"
      when: nvidia_check.rc == 0

    - name: Display NVIDIA driver not available
      debug:
        msg: "NVIDIA drivers not available - this is expected in some environments"
      when: nvidia_check.rc != 0

    - name: Verify CUDA installation
      command: nvcc --version
      register: cuda_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Display CUDA version
      debug:
        msg: "CUDA version: {{ cuda_check.stdout_lines }}"
      when: cuda_check.rc == 0

    - name: Display CUDA not available
      debug:
        msg: "CUDA toolkit not available - this is expected in some environments"
      when: cuda_check.rc != 0

    - name: Verify essential packages
      command: which git && which wget && which curl && which vim && which htop
      register: essential_check
      changed_when: false
      failed_when: false

    - name: Display essential packages status
      debug:
        msg: "Essential packages check passed: {{ essential_check.stdout_lines }}"
      when: essential_check.rc == 0

    - name: Display essential packages missing
      debug:
        msg: "Some essential packages are missing - check installation"
      when: essential_check.rc != 0
