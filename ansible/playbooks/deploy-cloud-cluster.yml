# Cloud Cluster Kubernetes Deployment Playbook
# Deploys Kubernetes cluster using Kubespray
#
# Prerequisites:
# 1. VMs provisioned and running (via ai-how cloud start)
# 2. Kubespray installed (cmake --build build --target install-kubespray)
# 3. Inventory generated (python scripts/generate-kubespray-inventory.py ...)
#
# Usage:
#   ansible-playbook -i ansible/inventories/cloud-cluster/inventory.ini \
#     ansible/playbooks/deploy-cloud-cluster.yml

- name: Pre-flight - Prepare Debian nodes
  hosts: all
  gather_facts: true
  become: true
  tasks:
    - name: Prefer IPv4 connectivity (disable IPv6)
      ansible.builtin.include_role:
        name: network-ipv6
      vars:
        disable_ipv6: true

    - name: Update APT cache on Debian systems
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == 'Debian'
      register: apt_update
      retries: 3
      delay: 5
      until: apt_update is succeeded

    - name: Pre-install conntrack package (Debian 13+)
      ansible.builtin.apt:
        name: conntrack
        state: present
      when:
        - ansible_os_family == 'Debian'
        - ansible_distribution_major_version | int >= 13
      register: conntrack_install
      retries: 3
      delay: 5
      until: conntrack_install is succeeded

    - name: Ensure DNS configuration present
      ansible.builtin.include_role:
        name: dns-config

- name: Deploy Cloud Cluster with Kubespray
  hosts: localhost
  gather_facts: false
  become: false
  vars:
    kubespray_source_dir: "{{ playbook_dir }}/../../build/3rd-party/kubespray/kubespray-src"
    kubespray_inventory_file: "{{ inventory_file | default('ansible/inventories/cloud-cluster/inventory.ini') }}"
  tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          ================================================================
          Cloud Cluster Kubernetes Deployment
          ================================================================
          Inventory: {{ kubespray_inventory_file }}
          Kubespray: {{ kubespray_source_dir }}
          ================================================================
      delegate_to: localhost
      run_once: true

    - name: Run Kubespray cluster deployment via role
      ansible.builtin.include_role:
        name: kubespray-integration

- name: Post-Kubespray Configuration
  hosts: kube_node
  gather_facts: true
  become: true
  tasks:
  # Note: Kubespray already ensures nodes are Ready during deployment
  # Skipping redundant node readiness check to avoid Python dependency issues

- name: Validate Cluster Health
  hosts: kube_control_plane[0]
  gather_facts: false
  become: false
  tasks:
    - name: Get control plane host address
      ansible.builtin.set_fact:
        control_plane_host: "{{ hostvars[groups['kube_control_plane'][0]]['ansible_host'] | default(hostvars[groups['kube_control_plane'][0]]['inventory_hostname']) }}"
      run_once: true

    - name: Wait for API server to be ready
      ansible.builtin.wait_for:
        host: "{{ control_plane_host }}"
        port: 6443
        delay: 10
        timeout: 300
      delegate_to: localhost
      run_once: true

    - name: Display deployment success message
      ansible.builtin.debug:
        msg: |
          ================================================================
          Kubernetes Cluster Deployment Complete
          ================================================================
          API Server: {{ control_plane_host }}:6443
          Status: Ready

          Note: Use 'kubectl get nodes' to verify cluster status.
          Kubespray has already validated all nodes are Ready.
          ================================================================
      run_once: true
