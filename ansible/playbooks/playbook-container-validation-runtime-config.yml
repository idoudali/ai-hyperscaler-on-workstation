---
# Container Validation Runtime Configuration Playbook
# Task 026: Runtime configuration playbook for container integration validation
# This playbook is specifically for runtime validation and testing
# Usage:
#   ansible-playbook -i inventory playbook-container-validation-runtime-config.yml

- name: Container Integration Validation Runtime Configuration
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  gather_facts: true

  vars:
    # Runtime deployment mode (not a Packer build)
    packer_build: false

    # Container configuration
    container_image_path: "/opt/containers/ml-frameworks/pytorch-cuda12.1-mpi4.1.sif"
    container_runtime: "apptainer"

    # Validation tests to run
    run_container_tests: true
    run_pytorch_tests: true
    run_mpi_tests: true
    run_slurm_tests: true

  pre_tasks:
    - name: Verify this is runtime mode
      assert:
        that:
          - not (packer_build | bool)
        fail_msg: "This playbook is for runtime validation only. packer_build must be false."
        success_msg: "Runtime validation mode confirmed."

    - name: Display validation configuration
      debug:
        msg: |
          Container Integration Validation Configuration:
          - Target hosts: {{ target_hosts | default('all') }}
          - Container image: {{ container_image_path }}
          - Container runtime: {{ container_runtime }}
          - Run container tests: {{ run_container_tests }}
          - Run PyTorch tests: {{ run_pytorch_tests }}
          - Run MPI tests: {{ run_mpi_tests }}
          - Run SLURM tests: {{ run_slurm_tests }}

  tasks:
    - name: Verify container runtime is available
      command: which {{ container_runtime }}
      register: runtime_check
      changed_when: false
      failed_when: false

    - name: Display container runtime status
      debug:
        msg: "Container runtime {{ container_runtime }}: {{ 'Available' if runtime_check.rc == 0 else 'NOT FOUND' }}"

    - name: Check if container image exists
      stat:
        path: "{{ container_image_path }}"
      register: container_image_stat

    - name: Display container image status
      debug:
        msg: "Container image: {{ 'Exists' if container_image_stat.stat.exists else 'NOT FOUND' }}"

    - name: Warn if prerequisites are missing
      debug:
        msg: |
          WARNING: Missing prerequisites detected:
          {% if runtime_check.rc != 0 %}
          - Container runtime ({{ container_runtime }}) not found
          {% endif %}
          {% if not container_image_stat.stat.exists %}
          - Container image not found at {{ container_image_path }}
          {% endif %}

          Please ensure the following tasks are completed:
          - TASK-019: PyTorch Container built
          - TASK-020: Container converted to Apptainer
          - TASK-021: Container Registry deployed
      when: runtime_check.rc != 0 or not container_image_stat.stat.exists

    - name: Test basic container execution
      command: "{{ container_runtime }} exec {{ container_image_path }} echo 'Container execution test'"
      register: container_exec_test
      changed_when: false
      failed_when: false
      when: run_container_tests and container_image_stat.stat.exists

    - name: Test Python availability in container
      command: "{{ container_runtime }} exec {{ container_image_path }} python3 --version"
      register: python_test
      changed_when: false
      failed_when: false
      when: run_container_tests and container_image_stat.stat.exists

    - name: Test PyTorch import in container
      command: "{{ container_runtime }} exec {{ container_image_path }} python3 -c 'import torch; print(torch.__version__)'"
      register: pytorch_import_test
      changed_when: false
      failed_when: false
      when: run_pytorch_tests and container_image_stat.stat.exists

    - name: Test PyTorch CUDA availability
      command: "{{ container_runtime }} exec {{ container_image_path }} python3 -c 'import torch; print(torch.cuda.is_available())'"
      register: cuda_test
      changed_when: false
      failed_when: false
      when: run_pytorch_tests and container_image_stat.stat.exists

    - name: Test MPI availability in container
      command: "{{ container_runtime }} exec {{ container_image_path }} which mpirun"
      register: mpi_test
      changed_when: false
      failed_when: false
      when: run_mpi_tests and container_image_stat.stat.exists

    - name: Test mpi4py import
      command: "{{ container_runtime }} exec {{ container_image_path }} python3 -c 'from mpi4py import MPI; print(MPI.Get_version())'"
      register: mpi4py_test
      changed_when: false
      failed_when: false
      when: run_mpi_tests and container_image_stat.stat.exists

    - name: Check SLURM availability
      command: which srun
      register: slurm_check
      changed_when: false
      failed_when: false
      when: run_slurm_tests

    - name: Test container execution via SLURM
      command: "srun --ntasks=1 {{ container_runtime }} exec {{ container_image_path }} hostname"
      register: slurm_container_test
      changed_when: false
      failed_when: false
      when: run_slurm_tests and slurm_check.rc == 0 and container_image_stat.stat.exists

  post_tasks:
    - name: Display validation results
      debug:
        msg: |
          Container Integration Validation Results:
          ==========================================
          Hostname: {{ inventory_hostname }}

          Prerequisites:
          - Container runtime: {{ 'AVAILABLE (' + container_runtime + ')' if runtime_check.rc == 0 else 'NOT FOUND' }}
          - Container image: {{ 'EXISTS' if container_image_stat.stat.exists else 'NOT FOUND' }}

          {% if container_image_stat.stat.exists %}
          Container Functionality Tests:
          - Basic execution: {{ 'PASSED' if container_exec_test.rc == 0 else 'FAILED' }}
          - Python availability: {{ 'PASSED (' + python_test.stdout + ')' if python_test.rc == 0 else 'FAILED' }}

          PyTorch Tests:
          - PyTorch import: {{ 'PASSED (v' + pytorch_import_test.stdout + ')' if pytorch_import_test.rc == 0 else 'FAILED' }}
          - CUDA availability: {{ 'AVAILABLE' if cuda_test.stdout | default('False') | trim == 'True' else 'NOT AVAILABLE (expected without GPU)' }}

          MPI Tests:
          - MPI runtime: {{ 'AVAILABLE' if mpi_test.rc == 0 else 'NOT FOUND' }}
          - mpi4py import: {{ 'PASSED' if mpi4py_test.rc == 0 else 'FAILED' }}

          SLURM Integration Tests:
          - SLURM available: {{ 'YES' if slurm_check.rc == 0 else 'NO' }}
          {% if slurm_check.rc == 0 %}
          - Container via SLURM: {{ 'PASSED' if slurm_container_test.rc == 0 else 'FAILED' }}
          {% endif %}
          {% endif %}

          ==========================================
          Status: {{ 'READY FOR INTEGRATION TESTING' if container_image_stat.stat.exists and runtime_check.rc == 0 else 'MISSING PREREQUISITES' }}

    - name: Display next steps
      debug:
        msg: |
          Container Integration Validation Complete!

          Next Steps:
          1. Run comprehensive tests: cd tests && make test-container-integration
          2. Run specific test categories:
             - Container functionality: tests/suites/container-integration/check-container-functionality.sh
             - PyTorch + CUDA: tests/suites/container-integration/check-pytorch-cuda-integration.sh
             - MPI communication: tests/suites/container-integration/check-mpi-communication.sh
             - Distributed training: tests/suites/container-integration/check-distributed-training.sh
             - SLURM integration: tests/suites/container-integration/check-container-slurm-integration.sh
          3. Run full test framework: tests/test-container-integration-framework.sh

          For detailed testing guide, see: docs/CONTAINER-INTEGRATION-TESTING.md
      when: container_image_stat.stat.exists and runtime_check.rc == 0

    - name: Display troubleshooting information
      debug:
        msg: |
          Prerequisites missing. Please complete the following:

          {% if runtime_check.rc != 0 %}
          Container Runtime ({{ container_runtime }}):
          - Install Apptainer on compute nodes
          - Verify installation: which {{ container_runtime }}
          - Check version: {{ container_runtime }} --version
          {% endif %}

          {% if not container_image_stat.stat.exists %}
          Container Image:
          - Build Docker image: cmake --build build --target build-docker-pytorch-cuda12.1-mpi4.1
          - Convert to Apptainer: cmake --build build --target convert-to-apptainer-pytorch-cuda12.1-mpi4.1
          - Deploy to cluster: ansible-playbook playbooks/playbook-container-registry.yml
          - Verify deployment: ls -lh {{ container_image_path }}
          {% endif %}

          Required Tasks (must be completed in order):
          1. TASK-019: Build PyTorch Container with CUDA 12.1 + MPI 4.1
          2. TASK-020: Convert Docker to Apptainer SIF
          3. TASK-021: Deploy Container Registry Infrastructure
          4. TASK-022: Install SLURM Compute Nodes
          5. TASK-023: Configure GPU Resources (GRES)
          6. TASK-024: Configure Cgroup Resource Isolation
          7. TASK-026: Run Container Integration Validation Tests
      when: runtime_check.rc != 0 or not container_image_stat.stat.exists

    - name: Summary message
      debug:
        msg: |
          ==========================================
          Container Integration Validation: {{ 'COMPLETE' if container_image_stat.stat.exists and runtime_check.rc == 0 else 'INCOMPLETE' }}
          ==========================================
