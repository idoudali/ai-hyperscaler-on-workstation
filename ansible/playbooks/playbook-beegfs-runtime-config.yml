---
# BeeGFS Parallel Filesystem Runtime Configuration Playbook
#
# This playbook deploys BeeGFS parallel filesystem across the HPC cluster:
# - Management service on HPC controller
# - Metadata service on HPC controller
# - Storage services on compute nodes
# - Client mounts on all nodes
#
# Usage:
#   ansible-playbook -i inventory.yml playbook-beegfs-runtime-config.yml
#
# Variables:
#   beegfs_mgmt_host: Management service hostname (default: first controller)
#   beegfs_client_mount_point: Mount point (default: /mnt/beegfs)
#

# Step 1: Deploy BeeGFS management service on HPC controller
- name: Configure BeeGFS Management Service
  hosts: controller
  become: true
  vars:
    packer_build: false
    install_only: false
  roles:
    - role: beegfs-mgmt
      tags:
        - beegfs
        - beegfs-mgmt

  tasks:
    - name: Display management service deployment status
      ansible.builtin.debug:
        msg: "BeeGFS management service deployed on {{ inventory_hostname }}"
      tags:
        - beegfs
        - beegfs-mgmt

# Step 2: Deploy BeeGFS metadata service on HPC controller
- name: Configure BeeGFS Metadata Service
  hosts: controller
  become: true
  vars:
    packer_build: false
    install_only: false
  roles:
    - role: beegfs-meta
      tags:
        - beegfs
        - beegfs-meta

  tasks:
    - name: Display metadata service deployment status
      ansible.builtin.debug:
        msg: "BeeGFS metadata service deployed on {{ inventory_hostname }}"
      tags:
        - beegfs
        - beegfs-meta

# Step 3: Deploy BeeGFS storage services on compute nodes
- name: Configure BeeGFS Storage Services
  hosts: compute
  become: true
  vars:
    packer_build: false
    install_only: false
  roles:
    - role: beegfs-storage
      tags:
        - beegfs
        - beegfs-storage

  tasks:
    - name: Display storage service deployment status
      ansible.builtin.debug:
        msg: "BeeGFS storage service deployed on {{ inventory_hostname }}"
      tags:
        - beegfs
        - beegfs-storage

# Step 4: Deploy BeeGFS client on all nodes
- name: Configure BeeGFS Client on All Nodes
  hosts: controller:compute
  become: true
  vars:
    packer_build: false
    install_only: false
  roles:
    - role: beegfs-client
      tags:
        - beegfs
        - beegfs-client

  tasks:
    - name: Display client deployment status
      ansible.builtin.debug:
        msg: "BeeGFS client configured and mounted on {{ inventory_hostname }}"
      tags:
        - beegfs
        - beegfs-client

# Step 5: Verify BeeGFS cluster status
- name: Verify BeeGFS Cluster Configuration
  hosts: controller
  become: true
  vars:
    beegfs_client_mount_point: "/mnt/beegfs"
  tasks:
    - name: Check BeeGFS cluster status
      ansible.builtin.command:
        cmd: beegfs-ctl --listnodes --nodetype=all --cfgFile=/etc/beegfs/beegfs-mgmtd.conf
      register: beegfs_cluster_status
      changed_when: false
      failed_when: false
      ignore_errors: true
      tags:
        - beegfs
        - verification

    - name: Display cluster nodes
      ansible.builtin.debug:
        msg: "{{ beegfs_cluster_status.stdout_lines }}"
      tags:
        - beegfs
        - verification

    - name: Check BeeGFS storage targets
      ansible.builtin.command:
        cmd: beegfs-ctl --listtargets --nodetype=storage --state
      register: beegfs_storage_targets
      changed_when: false
      failed_when: false
      ignore_errors: true
      tags:
        - beegfs
        - verification

    - name: Display storage targets
      ansible.builtin.debug:
        msg: "{{ beegfs_storage_targets.stdout_lines }}"
      tags:
        - beegfs
        - verification

    - name: Test BeeGFS filesystem write
      ansible.builtin.copy:
        content: "BeeGFS deployment test - {{ ansible_date_time.iso8601 }}\n"
        dest: "{{ beegfs_client_mount_point }}/beegfs-test.txt"
        owner: root
        group: root
        mode: '0644'
      tags:
        - beegfs
        - verification

    - name: Verify BeeGFS filesystem read
      ansible.builtin.command:
        cmd: cat {{ beegfs_client_mount_point }}/beegfs-test.txt
      register: beegfs_read_test
      changed_when: false
      tags:
        - beegfs
        - verification

    - name: Display filesystem test result
      ansible.builtin.debug:
        msg: "BeeGFS filesystem operational - test file read successfully"
      when: beegfs_read_test.rc == 0
      tags:
        - beegfs
        - verification

# Step 6: Display deployment summary
- name: BeeGFS Deployment Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display deployment completion
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "BeeGFS Parallel Filesystem Deployment Complete"
          - "========================================"
          - ""
          - "Architecture:"
          - "  - Management Service: HPC Controller"
          - "  - Metadata Service: HPC Controller"
          - "  - Storage Services: Compute Nodes (distributed)"
          - "  - Client Mounts: All Nodes"
          - ""
          - "Mount Point: {{ beegfs_client_mount_point | default('/mnt/beegfs') }}"
          - ""
          - "Next Steps:"
          - "  1. Run performance benchmarks"
          - "  2. Configure user access and permissions"
          - "  3. Set up monitoring and alerts"
          - "  4. Test ML/AI workload integration"
          - ""
          - "Verification Commands:"
          - "  beegfs-ctl --listnodes --nodetype=all"
          - "  beegfs-ctl --listtargets --nodetype=storage --state"
          - "  beegfs-df"
          - "  beegfs-check-servers"
          - "========================================"
      tags:
        - beegfs
