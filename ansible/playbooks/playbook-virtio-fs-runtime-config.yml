---
# Runtime Configuration Playbook for Virtio-FS Host Directory Sharing
# Applies virtio-fs mount configuration to existing running VMs
# Use this after VMs are created from Packer images

- name: Configure Virtio-FS Mounts on Running Systems
  hosts: all
  become: true
  gather_facts: true

  vars:
    # Force runtime deployment mode (not Packer build)
    packer_build: false

    # Ensure mounts are performed in runtime mode
    virtio_fs_perform_mounts: true

    # Example virtio-fs mount configuration
    # Override this in inventory or group_vars
    virtio_fs_mounts:
      - tag: "datasets"
        mount_point: "/mnt/host-datasets"
        readonly: false
        owner: "admin"
        group: "admin"
        mode: "0755"
        options: "rw,relatime"
      - tag: "containers"
        mount_point: "/mnt/host-containers"
        readonly: true
        owner: "root"
        group: "root"
        mode: "0755"
        options: "ro,relatime"

  pre_tasks:
    - name: Display runtime configuration mode
      debug:
        msg:
          - "========================================"
          - "Virtio-FS Runtime Configuration Mode"
          - "========================================"
          - "This playbook configures virtio-fs mounts on running systems"
          - "packer_build: {{ packer_build }}"
          - "Mounts will be configured and verified"
          - "Number of mounts to configure: {{ virtio_fs_mounts | length }}"
          - "========================================"

    - name: Display configured mounts
      debug:
        msg: "Mount: {{ item.tag }} -> {{ item.mount_point }} ({{ 'readonly' if item.readonly | default(false) else 'read-write' }})"
      loop: "{{ virtio_fs_mounts }}"

    - name: Ensure systemd is available
      command: systemctl --version
      register: systemd_check
      changed_when: false
      failed_when: false

    - name: Check for virtiofs kernel module
      shell: lsmod | grep -i virtiofs || echo "not loaded"
      register: virtiofs_module_check
      changed_when: false
      failed_when: false

    - name: Display virtiofs module status
      debug:
        msg: "Virtiofs kernel module: {{ 'Loaded' if 'virtiofs' in virtiofs_module_check.stdout else 'Not loaded' }}"

  roles:
    - role: virtio-fs-mount
      tags:
        - virtio-fs
        - storage
        - mounts

  post_tasks:
    - name: Verify mount points exist
      stat:
        path: "{{ item.mount_point }}"
      register: mount_point_check
      loop: "{{ virtio_fs_mounts }}"
      when: virtio_fs_mounts is defined

    - name: Display mount point verification
      debug:
        msg: "{{ item.item.mount_point }}: {{ 'Exists' if item.stat.exists else 'Does NOT exist' }}"
      loop: "{{ mount_point_check.results }}"
      when:
        - mount_point_check is defined
        - mount_point_check.results is defined

    - name: Check mounted filesystems
      shell: mount | grep virtiofs
      register: mounted_filesystems
      changed_when: false
      failed_when: false

    - name: Display mounted virtio-fs filesystems
      debug:
        msg: "{{ mounted_filesystems.stdout_lines }}"
      when:
        - mounted_filesystems is defined
        - mounted_filesystems.stdout_lines is defined
        - mounted_filesystems.stdout_lines | length > 0

    - name: Check /etc/fstab for virtio-fs entries
      shell: grep virtiofs /etc/fstab | wc -l
      register: fstab_check
      changed_when: false
      failed_when: false

    - name: Test write access to read-write mounts
      shell: |
        test -w {{ item.mount_point }} && echo "writable" || echo "readonly"
      register: write_test
      loop: "{{ virtio_fs_mounts }}"
      changed_when: false
      failed_when: false
      when:
        - item.mount_point is defined
        - not (item.readonly | default(false))

    - name: Display write access test results
      debug:
        msg: "{{ item.item.mount_point }}: {{ item.stdout }}"
      loop: "{{ write_test.results }}"
      when:
        - write_test is defined
        - write_test.results is defined
        - item.stdout is defined

    - name: Final runtime configuration summary
      debug:
        msg:
          - "========================================"
          - "Virtio-FS Runtime Configuration Complete"
          - "========================================"
          - "Mounts configured: {{ virtio_fs_mounts | length }}"
          - "Mounts in fstab: {{ fstab_check.stdout | default('unknown') }}"
          - "Active virtiofs mounts: {{ mounted_filesystems.stdout_lines | length if mounted_filesystems.stdout_lines is defined else 0 }}"
          - "========================================"
