---
# Consolidated HPC Playbook
# Supports both Packer builds and live VM deployments
# Usage:
#   Packer: ansible-playbook -e packer_build=true playbook-hpc.yml
#   Live:   ansible-playbook -i inventory playbook-hpc.yml

- name: Deploy HPC Base Packages and NVIDIA Drivers
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  gather_facts: true

  vars:
    # Packer build detection and configuration
    packer_build: "{{ packer_build | default(false) }}"
    nvidia_install_cuda: "{{ nvidia_install_cuda | default(false) }}"
    nvidia_packer_build: "{{ packer_build | default(false) }}"

    # HPC Configuration
    slurm_version: "23.11.4"

    # Container Runtime Configuration
    container_runtime_type: "apptainer"  # Apptainer is the successor to Singularity
    container_runtime_version: "1.4.2"
    container_runtime_install_method: "github"  # Use GitHub releases
    container_runtime_enable_service: false  # Don't start service in Packer builds

  roles:
    - hpc-base-packages
    - container-runtime
    - nvidia-gpu-drivers
    - slurm-controller

  tasks:
    - name: Verify HPC base packages installation
      debug:
        msg: "HPC base packages have been installed successfully"

    - name: Verify container runtime installation
      command: "{{ container_runtime_binary | default('apptainer') }} --version"
      register: container_runtime_version
      changed_when: false
      failed_when: false

    - name: Display container runtime version
      debug:
        msg: "Container runtime {{ container_runtime_binary | default('apptainer') }} version: {{ container_runtime_version.stdout }}"
      when: container_runtime_version.rc == 0

    - name: Verify container runtime dependencies
      shell: "dpkg -l | grep -E '(fuse|squashfs-tools|uidmap)'"
      register: container_dependencies
      changed_when: false
      failed_when: false

    - name: Display container runtime dependencies
      debug:
        msg: "Container runtime dependencies installed: {{ container_dependencies.stdout_lines }}"

    - name: Verify SLURM controller installation
      command: "{{ item }}"
      register: slurm_version_check
      changed_when: false
      failed_when: false
      loop:
        - "slurmctld -V"
        - "slurmdbd -V"
        - "sinfo --version"

    - name: Display SLURM controller version
      debug:
        msg: "SLURM component {{ item.item }} version: {{ item.stdout.split('\n')[0] }}"
      loop: "{{ slurm_version_check.results }}"
      when: item.rc == 0

    - name: Verify SLURM controller dependencies
      shell: "dpkg -l | grep -E '(slurm-wlm|munge|mariadb-server|libpmix)'"
      register: slurm_dependencies
      changed_when: false
      failed_when: false

    - name: Display SLURM controller dependencies
      debug:
        msg: "SLURM controller dependencies installed: {{ slurm_dependencies.stdout_lines }}"

    - name: Display deployment context
      debug:
        msg: |
          Deployment Context:
          - Packer Build: {{ packer_build }}
          - NVIDIA CUDA: {{ nvidia_install_cuda }}
          - Container Runtime: {{ container_runtime_type | default('singularity') }}
          - SLURM Version: {{ slurm_version }}
          - Target Hosts: {{ target_hosts | default('all') }}

    - name: Gather installed package facts
      package_facts:
        manager: auto

    - name: Display relevant installed packages
      debug:
        msg: "{{ ansible_facts.packages | dict2items | selectattr('key', 'in', ['tmux', 'htop', 'vim', 'curl', 'wget', 'nvidia-driver', 'fuse', 'squashfs-tools', 'uidmap', 'slurm-wlm', 'slurmdbd', 'munge', 'mariadb-server', 'libpmix2']) | list }}"
