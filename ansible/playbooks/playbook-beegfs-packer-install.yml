---
# BeeGFS Packer Installation Playbook
# This playbook is used by Packer to pre-install BeeGFS packages during image creation
# It installs packages only (install_only=true) without configuring or starting services
#
# Note: Uses 'hosts: all' for compatibility with ansible provisioner (SSH connection)
# Previously used 'hosts: localhost' + 'connection: local' for ansible-local provisioner
#
# BeeGFS Client DKMS Module Build (BeeGFS 8.1.0 + Kernel 6.12+ Compatible)
# ================================================================================
# The BeeGFS client role will SKIP DKMS kernel module build during Packer builds
# to reduce image build time. BeeGFS 8.1.0 is fully compatible with kernel 6.12+.
#
# Current Behavior:
#   - BeeGFS client PACKAGES are installed (beegfs-client-dkms, beegfs-utils, beegfs-helperd)
#   - DKMS kernel module build is SKIPPED (packer_build=true) for faster image creation
#   - Image build completes successfully
#   - DKMS module will be built during runtime deployment
#
# Impact on Images:
#   Controller Image: Server packages + client packages installed (module built at runtime)
#   Compute Image: Storage + client packages installed (module built at runtime)
#
# Requirements:
#   Ensure kernel consistency between Docker build container and Packer VMs
#   See: docs/implementation-plans/task-lists/hpc-slurm/pending/phase-3-storage-fixes.md
#   Task: TASK-028.1 - BeeGFS 8.1.0 kernel consistency fixes
# ================================================================================

- name: Install BeeGFS packages on HPC Controller (Packer)
  hosts: all
  become: true
  vars:
    packer_build: true
    install_only: true
    beegfs_packages_path: "/tmp/beegfs-packages"
  roles:
    - role: beegfs-mgmt
      tags: [beegfs, beegfs-mgmt, install]
    - role: beegfs-meta
      tags: [beegfs, beegfs-meta, install]
    - role: beegfs-storage
      tags: [beegfs, beegfs-storage, install]
    - role: beegfs-client
      tags: [beegfs, beegfs-client, install]

- name: Install BeeGFS packages on HPC Compute (Packer)
  hosts: all
  become: true
  vars:
    packer_build: true
    install_only: true
    beegfs_packages_path: "/tmp/beegfs-packages"
  roles:
    - role: beegfs-storage
      tags: [beegfs, beegfs-storage, install]
    - role: beegfs-client
      tags: [beegfs, beegfs-client, install]
