{% set hw_accel = hardware.get('acceleration', {}) if hardware else {} %}
{% set hw_perf = hw_accel.get('performance', {}) if hw_accel else {} %}

{# Macro to parse hugepage size and return size and unit #}
{% macro parse_hugepage_size(size_str) %}
  {% set size_str_upper = size_str | upper %}
  {% set size_value = size_str_upper.rstrip('MGK') %}
  {% set unit = "G" if "G" in size_str_upper else ("K" if "K" in size_str_upper else "M") %}
  {{ size_value }},{{ unit }}
{% endmacro %}

<domain type='kvm'>
  <name>{{ vm_name }}</name>
  <uuid>{{ vm_uuid | default('') }}</uuid>
  <memory unit='GiB'>{{ memory_gb }}</memory>
  <currentMemory unit='GiB'>{{ memory_gb }}</currentMemory>
  <vcpu placement='static'>{{ cpu_cores }}</vcpu>

  {% if hw_perf.get('cpu_pinning', false) %}
  <!-- CPU pinning configuration for better PCIe passthrough performance -->
  <cputune>
    {% for i in range(cpu_cores) %}
    <vcpupin vcpu='{{ i }}' cpuset='{{ i }}'/>
    {% endfor %}
  </cputune>
  {% endif %}

  <!-- Memory backing configuration for PCIe passthrough performance -->
  {% if hw_perf.get('memory_backing') == 'memfd' or pcie_passthrough.get('enabled', false) %}
  <memoryBacking>
    <source type='memfd'/>
    <access mode='shared'/>
    {% if hw_perf.get('enable_hugepages', false) %}
    <hugepages>
      {% set hugepage_parsed = parse_hugepage_size(hw_perf.get('hugepage_size', '2M')).split(',') %}
      <page size='{{ hugepage_parsed[0] }}' unit='{{ hugepage_parsed[1] }}'/>
    </hugepages>
    {% endif %}
  </memoryBacking>
  {% elif hw_perf.get('enable_hugepages', false) %}
  <memoryBacking>
    <hugepages>
      {% set hugepage_parsed = parse_hugepage_size(hw_perf.get('hugepage_size', '2M')).split(',') %}
      <page size='{{ hugepage_parsed[0] }}' unit='{{ hugepage_parsed[1] }}'/>
    </hugepages>
  </memoryBacking>
  {% endif %}

  <os>
    <type arch='x86_64' machine='q35'>hvm</type>
    <boot dev='hd'/>
  </os>

  <features>
    <acpi/>
    <apic/>
    <vmport state='off'/>
    <kvm>
      <hidden state='on'/>
    </kvm>
  </features>

  <cpu mode='{{ hw_accel.get('cpu_model', 'host-passthrough') }}'>
    {% set cpu_topo = hw_accel.get('cpu_topology', {}) %}
    <topology sockets='{{ cpu_topo.get('sockets', 1) }}'
              cores='{{ cpu_cores }}'
              threads='{{ cpu_topo.get('threads', 1) }}'/>
    <!-- CPU features for virtualization and performance -->
    {% set cpu_features = [] %}
    {% if hw_accel.get('enable_nested', false) or pcie_passthrough.get('enabled', false) %}
      {% set _ = cpu_features.extend(['vmx', 'svm']) %}
    {% endif %}
    {% for feature in hw_accel.get('cpu_features', []) %}
      {% set _ = cpu_features.append(feature.lstrip('+')) %}
    {% endfor %}
    {% set unique_features = cpu_features | unique | list %}
    {% for feature in unique_features %}
    <feature policy='require' name='{{ feature }}'/>
    {% endfor %}
  </cpu>

  <clock offset='utc'>
    <timer name='rtc' tickpolicy='catchup'/>
    <timer name='pit' tickpolicy='delay'/>
    <timer name='hpet' present='no'/>
  </clock>

  <on_poweroff>destroy</on_poweroff>
  <on_reboot>restart</on_reboot>
  <on_crash>restart</on_crash>

  <devices>
    <emulator>/usr/bin/qemu-system-x86_64</emulator>

    <!-- Primary disk -->
    <disk type='file' device='disk'>
      <driver name='qemu' type='qcow2'/>
      <source file='{{ disk_path }}'/>
      <target dev='vda' bus='virtio'/>
    </disk>

    <!-- Network interface -->
    <interface type='network'>
      <source network='{{ cluster_name }}-network'/>
      <model type='virtio'/>
      {% if mac_address %}
      <mac address='{{ mac_address }}'/>
      {% endif %}
    </interface>

    <!-- Basic controllers -->
    <controller type='usb' index='0' model='qemu-xhci'/>
    <controller type='pci' index='0' model='pcie-root'/>

    <!-- PCIe Passthrough (if configured) -->
    {% if pcie_passthrough and pcie_passthrough.get('enabled') and pcie_passthrough.get('devices') %}
    {% for device in pcie_passthrough['devices'] %}
    <hostdev mode='subsystem' type='pci' managed='yes'>
      <source>
        <address domain='0x{{ device['pci_address'].split(":")[0] }}'
                 bus='0x{{ device['pci_address'].split(":")[1] }}'
                 slot='0x{{ device['pci_address'].split(":")[2].split(".")[0] }}'
                 function='0x{{ device['pci_address'].split(":")[2].split(".")[1] }}'/>
      </source>
      {% if device.get('device_type') == 'gpu' %}
      <!-- Enable ROM BAR for GPU device -->
      <rom bar='on'/>
      {% endif %}
    </hostdev>
    {% endfor %}
    {% endif %}

    <!-- Console access -->
    <serial type='pty'>
      <target type='isa-serial' port='0'/>
    </serial>
    <console type='pty'>
      <target type='serial' port='0'/>
    </console>

    <!-- Graphics (only if no GPU passthrough) -->
    {% set has_gpu_passthrough = false %}
    {% if pcie_passthrough and pcie_passthrough.get('enabled') and pcie_passthrough.get('devices') %}
      {% for device in pcie_passthrough['devices'] %}
        {% if device.get('device_type') == 'gpu' %}
          {% set has_gpu_passthrough = true %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if not has_gpu_passthrough %}
    <graphics type='vnc' port='-1' autoport='yes' listen='127.0.0.1'/>
    <video>
      <model type='qxl'/>
    </video>
    {% else %}
    <graphics type='none'/>
    {% endif %}

    <!-- Essential devices -->
    <input type='keyboard' bus='ps2'/>
    <input type='mouse' bus='ps2'/>
    <memballoon model='virtio'/>
    <rng model='virtio'>
      <backend model='random'>/dev/urandom</backend>
    </rng>
  </devices>
</domain>
