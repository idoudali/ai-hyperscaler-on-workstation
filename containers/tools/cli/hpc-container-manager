#!/usr/bin/env python3
"""
HPC Container Manager CLI

Command-line tool for managing HPC container images with docker-wrapper integration.
Supports Docker building, Apptainer conversion, and cluster deployment.
"""

import sys
import os
import logging
from pathlib import Path
import click

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from hpc_extensions.apptainer_converter import ApptainerConverter
from hpc_extensions.cluster_deploy import ClusterDeployer

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


@click.group()
@click.option('--verbose', '-v', is_flag=True, help='Enable verbose output')
def cli(verbose):
    """HPC Container Manager - Build, convert, and deploy containers for HPC."""
    if verbose:
        logging.getLogger().setLevel(logging.DEBUG)


@cli.group()
def docker():
    """Docker image operations (requires docker-wrapper)."""
    pass


@docker.command('build')
@click.argument('container_name')
@click.option('--tag', '-t', default='latest', help='Image tag')
def docker_build(container_name, tag):
    """Build a Docker image from container extension."""
    click.echo(f"Building Docker image: {container_name}:{tag}")
    click.echo("Note: This requires docker-wrapper library to be installed")

    # TODO: Implement docker-wrapper integration
    click.echo("Run: docker build -t {container_name}:{tag} images/{container_name}/Docker/")


@docker.command('run')
@click.argument('container_name')
@click.option('--gpus', default='all', help='GPU configuration')
@click.option('--cmd', default='/bin/bash', help='Command to run')
def docker_run(container_name, gpus, cmd):
    """Run a Docker container."""
    click.echo(f"Running Docker container: {container_name}")
    click.echo(f"GPUs: {gpus}, Command: {cmd}")

    # TODO: Implement docker-wrapper integration
    click.echo(f"Run: docker run --gpus {gpus} {container_name} {cmd}")


@cli.group()
def convert():
    """Convert Docker images to Apptainer format."""
    pass


@convert.command('to-apptainer')
@click.argument('docker_image')
@click.argument('output_path')
@click.option('--force', '-f', is_flag=True, help='Overwrite existing file')
def convert_to_apptainer(docker_image, output_path, force):
    """Convert Docker image to Apptainer .sif format."""
    converter = ApptainerConverter()

    if converter.convert_docker_to_apptainer(docker_image, output_path, force):
        click.echo(f"✓ Successfully converted to {output_path}")
    else:
        click.echo(f"✗ Conversion failed", err=True)
        sys.exit(1)


@cli.group()
def deploy():
    """Deploy container images to HPC clusters."""
    pass


@deploy.command('to-cluster')
@click.argument('sif_path')
@click.argument('target_path')
@click.option('--controller', required=True, help='Controller node IP')
@click.option('--user', default='root', help='SSH username')
@click.option('--key', help='SSH private key path')
@click.option('--sync-nodes', is_flag=True, help='Sync to compute nodes')
@click.option('--verify', is_flag=True, help='Verify deployment')
def deploy_to_cluster(sif_path, target_path, controller, user, key, sync_nodes, verify):
    """Deploy Apptainer image to HPC cluster."""
    deployer = ClusterDeployer()

    click.echo(f"Deploying {sif_path} to {controller}:{target_path}")

    if deployer.deploy_image(sif_path, target_path, controller, user, key, sync_nodes):
        click.echo("✓ Deployment successful")

        if verify:
            click.echo("Verifying deployment...")
            if deployer.verify_deployment(target_path, controller, user, key, sync_nodes):
                click.echo("✓ Verification passed")
            else:
                click.echo("✗ Verification failed", err=True)
    else:
        click.echo("✗ Deployment failed", err=True)
        sys.exit(1)


@cli.command('info')
@click.argument('sif_path')
def info(sif_path):
    """Get information about an Apptainer image."""
    converter = ApptainerConverter()
    info = converter.get_image_info(sif_path)

    click.echo(f"\nImage Information:")
    click.echo(f"  Path: {info.get('path')}")
    click.echo(f"  Size: {info.get('size', 0) / (1024**3):.2f} GB")
    click.echo(f"\nDetailed Info:")
    click.echo(info.get('inspect_output', 'No info available'))


@cli.command('test')
@click.argument('sif_path')
@click.option('--gpu', is_flag=True, help='Test with GPU support')
def test(sif_path, gpu):
    """Test an Apptainer image."""
    converter = ApptainerConverter()

    click.echo(f"Testing image: {sif_path}")

    # Basic test
    if converter.test_apptainer_image(sif_path, "python3 --version"):
        click.echo("✓ Python test passed")
    else:
        click.echo("✗ Python test failed", err=True)
        sys.exit(1)

    # PyTorch test
    pytorch_cmd = "python3 -c 'import torch; print(torch.__version__)'"
    if converter.test_apptainer_image(sif_path, pytorch_cmd):
        click.echo("✓ PyTorch test passed")
    else:
        click.echo("✗ PyTorch test failed", err=True)

    if gpu:
        # GPU test
        gpu_cmd = "python3 -c 'import torch; print(f\"CUDA: {torch.cuda.is_available()}\")'"
        if converter.test_apptainer_image(sif_path, gpu_cmd):
            click.echo("✓ GPU test passed")
        else:
            click.echo("✗ GPU test failed (may be expected without GPU)", err=True)


if __name__ == '__main__':
    cli()
