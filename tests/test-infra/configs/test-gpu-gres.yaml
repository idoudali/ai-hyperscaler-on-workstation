version: "1.0"
metadata:
  name: "test-gpu-gres"
  description: "GPU GRES Test Configuration for Task 023 validation"

global: {}

clusters:
  hpc:
    name: "test-hpc-gpu-gres"
    # Base image path - will be overridden by node-specific images
    # Paths are relative to PROJECT_ROOT
    base_image_path: "build/packer/hpc-controller/hpc-controller/hpc-controller.qcow2"

    network:
      subnet: "192.168.160.0/24"
      bridge: "virbr160"

    # Hardware acceleration configuration
    hardware:
      acceleration:
        enable_kvm: true
        enable_nested: false
        cpu_model: "host-passthrough"
        cpu_features:
          - "+vmx"
          - "+svm"
          - "+sse4.1"
          - "+sse4.2"
          - "+avx"
          - "+avx2"
        numa_topology: null
        cpu_topology:
          sockets: 1
          cores: 4
          threads: 1
        performance:
          enable_hugepages: false
          hugepage_size: "2M"
          cpu_pinning: false
          memory_backing: "default"

    # Controller node - required for SLURM GRES testing
    controller:
      cpu_cores: 4
      memory_gb: 8
      disk_gb: 50
      ip_address: "192.168.160.10"
      # Use specialized controller image (path relative to PROJECT_ROOT)
      image_path: "build/packer/hpc-controller/hpc-controller/hpc-controller.qcow2"

    # Compute nodes - focus of Task 023 testing (GPU GRES)
    compute_nodes:
      - name: "compute-01"
        cpu_cores: 4
        memory_gb: 8
        disk_gb: 50
        ip_address: "192.168.160.11"
        # Use specialized compute image (path relative to PROJECT_ROOT)
        image_path: "build/packer/hpc-compute/hpc-compute/hpc-compute.qcow2"
        # GPU configuration (for GRES testing)
        gres:
          gpu:
            enabled: true
            type: "gpu"
            count: 0  # Simulated - no actual GPUs in test environment
            autodetect: false

      - name: "compute-02"
        cpu_cores: 4
        memory_gb: 8
        disk_gb: 50
        ip_address: "192.168.160.12"
        # Use specialized compute image (path relative to PROJECT_ROOT)
        image_path: "build/packer/hpc-compute/hpc-compute/hpc-compute.qcow2"
        # GPU configuration (for GRES testing)
        gres:
          gpu:
            enabled: true
            type: "gpu"
            count: 0  # Simulated - no actual GPUs in test environment
            autodetect: false

    # SLURM configuration
    slurm_config:
      partitions: ["compute"]
      default_partition: "compute"
      max_job_time: "4:00:00"
      # GRES configuration
      gres_types:
        - "gpu"

  # Empty cloud cluster (required by schema but not used in this test)
  cloud:
    name: "test-cloud-empty"
    # Using controller image as placeholder since cloud-base doesn't exist
    # Path is relative to PROJECT_ROOT
    base_image_path: "build/packer/hpc-controller/hpc-controller/hpc-controller.qcow2"
    network:
      subnet: "192.168.161.0/24"
      bridge: "virbr161"
    control_plane:
      cpu_cores: 2
      memory_gb: 4
      disk_gb: 30
      ip_address: "192.168.161.10"
    worker_nodes:
      cpu: []
      gpu: []
    kubernetes_config:
      cni: "calico"
      ingress: "nginx"
      storage_class: "local-path"

# Test-specific configuration (for test framework)
test:
  # Target compute nodes for testing
  target_pattern: "compute"

  # Test suite configuration
  test_suite: "gpu-gres"
  test_timeout: 900  # 15 minutes for GPU GRES tests

  # Test categories to run
  test_categories:
    - "gres-configuration"  # GRES configuration file validation
    - "gpu-detection"       # GPU device detection
    - "gpu-scheduling"      # GPU resource scheduling

  # Test environment variables
  environment:
    SLURM_VERSION: "23.11.4"
    TEST_GPU_GRES: "true"
    TEST_GRES_CONFIG: "true"
    GRES_ENABLED: "true"

# Build configuration (if building images is needed)
build:
  enabled: false  # Tests assume pre-built compute image
  image_type: "hpc-compute"

# Performance and timeout settings
timeouts:
  vm_start: 300      # 5 minutes to start VMs
  ssh_ready: 120     # 2 minutes for SSH to be ready
  test_execution: 900 # 15 minutes for test execution

# Logging configuration
logging:
  level: "INFO"
  capture_vm_logs: true
  save_test_artifacts: true
