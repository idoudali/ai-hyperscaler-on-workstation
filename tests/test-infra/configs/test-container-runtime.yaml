version: "1.0"
metadata:
  name: "test-container-runtime"
  description: "Container runtime test configuration for Task 008 validation with container-enabled nodes"

global: {}

clusters:
  hpc:
    name: "test-hpc-container-runtime"
    # Default base image path - can be absolute or relative to the current working directory
    # For container runtime testing, compute nodes will override with specialized image
    # Relative paths will be resolved from the directory where the CLI is executed
    base_image_path: "build/packer/hpc-controller/hpc-controller/hpc-controller.qcow2"  # Cluster-level default base image path (used by controller and any node not overriding)
    network:
      subnet: 192.168.155.0/24
      bridge: "virbr155"

    # Hardware acceleration configuration (x86_64 only)
    hardware:
      acceleration:
        enable_kvm: true           # Enable KVM hardware virtualization
        enable_nested: false      # Enable nested virtualization
        cpu_model: "host-passthrough"  # host, host-passthrough, host-model, qemu64
        cpu_features:              # Additional CPU features
          - "+vmx"                 # Intel VT-x virtualization
          - "+svm"                 # AMD-V virtualization
          - "+sse4.1"              # SSE 4.1 instructions
          - "+sse4.2"              # SSE 4.2 instructions
        numa_topology: null       # NUMA topology (auto-detect if null)
        cpu_topology:             # CPU topology settings
          sockets: 1
          cores: 4
          threads: 1
        performance:
          enable_hugepages: false  # Use hugepages for better memory performance
          hugepage_size: "2M"      # 2M or 1G hugepages
          cpu_pinning: false       # Pin vCPUs to physical CPUs
          memory_backing: "default" # default, hugepages, memfd

    controller:
      cpu_cores: 4
      memory_gb: 8
      disk_gb: 50
      ip_address: "192.168.155.10"
      # Controller uses cluster default (controller image)

    compute_nodes:
      # Container-enabled compute node for testing
      - cpu_cores: 4
        memory_gb: 8
        disk_gb: 40
        ip: "192.168.155.11"
        # Override with compute image that has pre-installed container runtime
        base_image_path: "build/packer/hpc-compute/hpc-compute/hpc-compute.qcow2"
        # Container runtime specific configuration
        container_runtime:
          enabled: true
          runtime_type: "apptainer"
          version: "4.1.5"
          # Task 008 dependencies
          dependencies:
            - "fuse"
            - "squashfs-tools"
            - "uidmap"
            - "libfuse2"
            - "libseccomp2"
          # Security configuration per Task 008 and Task 009
          security_config:
            allow_suid: false
            allow_pid_namespace: true
            mount_home: true
            mount_hostfs: false
            config_passwd: true
            config_group: true
            config_resolv_conf: true
            mount_proc: true
            mount_sys: true
            mount_dev: true
            mount_tmp: true
            user_bind_control: true
            enable_overlay: true
            enable_underlay: false
            mount_slave: true
            sessiondir_max_size: 16
            allow_container_squashfs: true
            allow_container_extfs: true
            allow_container_dir: true
            allow_container_encrypted: true
            always_use_nv: false
            root_default_capabilities: "full"

    slurm_config:
      partitions: ["container", "debug"]
      default_partition: "container"
      max_job_time: "2:00:00"
      # Container integration
      container_plugin_enabled: true
